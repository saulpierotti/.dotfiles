webpackJsonp([17],{2150:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2151),i(2155),i(2157),i(2159),i(2161)},2151:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2152),n=i(2153),r=i(2154),o=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,f,v,m){var g=this;if(this.constants=i,this.layoutService=s,this.utilityService=r,this.loggingService=o,this.messageService=a,this.filesMessagePaneHelper=l,this.authenticationService=c,this.filesEntityService=d,this.storageService=p,this.filesUtilityService=u,this.channelService=f,this.settingsService=v,this.showStartConversationButton=!1,this.panelRegions=teamspace.PanelRegion,this.moreOptionsText=e.instant(n.strings.files_moreOptions),this.startConversationClicked=!1,this.theme=v.getActiveTheme(),m.$on(t,i.events.layout.themeChanged,function(){g.theme=v.getActiveTheme()}),this.provider){if(this.provider.iconsService){var w=this.provider.iconsService.getIcon(this.fileType);w&&(this.fileIconPath=w.largeIconPath||w.defaultIconPath,this.isSvgIcon=w.isSvg,this.iconAltTextKey=w.altTextResourceKey)}h.getEntryBreadcrumbInfo(this.provider).then(function(e){g.thumbnailImgSrc=e.thumbnailImgSrc})}this.fileIconPath||(this.fileIconPath=this.getTypeSvgSrc(),this.isSvgIcon=!0),this.initConversation(),t.$on("$destroy",function(){l&&l.destroyContextMessagePane()}),this.trackData={fileId:this.fileId,fileType:this.fileType,error:this.error,errorReasonForTelemetry:this.errorReasonForTelemetry}}return e.$inject=["$translate","$scope","constants","layoutService","resources","utilityService","loggingService","messageService","filesMessagePaneHelper","authenticationService","filesEntityService","filesNavigationEntryService","storageService","filesUtilityService","channelService","settingsService","eventingService"],e.prototype.$onChanges=function(e){if(this.hasPrimaryOptions=this.primaryOptions&&this.primaryOptions.options&&this.primaryOptions.options.length&&this.primaryOptions.options.some(function(e){return!e.shouldBeHidden()}),this.settingsService.valueAsBoolean(this.constants.settings.names.enableTeamArchive)&&this.conversationInfo&&this.conversationInfo.threadId){var t=this.channelService.getParentTeamAndChannelByChannelId(this.conversationInfo.threadId);this.isTeamArchived=t&&t.team&&t.team.isArchived}this.isEditButtonAvailable=!!this.hasPrimaryOptions||this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileType),this.hasMoreOptions=this.moreOptions&&this.moreOptions.length&&this.moreOptions.some(function(e){return!e.shouldBeHidden()})},e.prototype.initConversation=function(){var e=this;if(this.filesMessagePaneHelper&&this._conversationInfo&&this._conversationInfo.threadId){var t=/p2p/i.test(this._conversationInfo.serviceName);this.filesMessagePaneHelper.initializeContextMessagePane(this._conversationInfo.objectId,this._conversationInfo.threadId,t).then(function(i){return e.updateEnablePostToChannel(i,t)})}},e.prototype.updateEnablePostToChannel=function(e,t){this.showStartConversationButton=e&&!t?!!this.channelService.canPostToChannel(this.conversationInfo.threadId)&&e:e},Object.defineProperty(e.prototype,"conversationInfo",{get:function(){return this._conversationInfo},set:function(e){this._conversationInfo||(this._conversationInfo=e,this.initConversation())},enumerable:!0,configurable:!0}),e.prototype.getTypeSvgSrc=function(){void 0===this.fileType&&(this.loggingService.warn("[getTypeSvgSrc] FileType is undefined, setting to empty string to get default svg"),this.fileType="");var e=this.utilityService.getIconClass({type:this.fileType}),t=this.constants.css.fileIcons;return[t.excel,t.onenote,t.pdf,t.powerpoint,t.visio,t.word].includes(e)?"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}-file-32_1.5x")+".html":"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}")+".html"},e.prototype.startConversation=function(){var e=this;if(!this.startConversationClicked){this.startConversationClicked=!0;var t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.filesMessagePaneHelper.getReplyChainIdFromFileId(this._conversationInfo.objectId,this._conversationInfo.threadId).then(function(i){i?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e._conversationInfo.threadId,i,teamspace.services.ReplyChainIdType.ParentMessageId,/p2p/i.test(e._conversationInfo.serviceName)),e.showStartConversationButton=!1,t.stop()):(e.createFileAttachment?e.createFileAttachment():e.filesEntityService.getFileDetail(e.fileType,e.conversationInfo.objectUrl).then(function(e){return e.value}).then(function(t){return e.getAttachment(t)})).then(function(t){var i=e.getMessageParams(t,e.conversationInfo.threadId);return e.messageService.createMessage(i)}).then(function(t){return e.authenticationService.getUserInformation().then(function(e){return{upn:((e||{}).profile||{}).upn,messageId:t.messageId}})}).then(function(t){return t.upn?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve user upn on start conversation"),t.messageId?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve messageId on start conversation"),t.messageId}).then(function(t){return e.filesMessagePaneHelper.initializeContextMessagePane(e.conversationInfo.objectId,e.conversationInfo.threadId,!1,t)}).then(function(){return e.showStartConversationButton=!1}).then(function(){return t.stop()}).catch(function(i){var s="Failed to start conversation";e.startConversationClicked=!1,e.loggingService.error(s),t.fail({error:s})})})}},e.prototype.rightRailShowExistingComponent=function(){var e=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.layoutService.rightRailShowExistingComponent(),e.stop()},e.prototype.getAttachment=function(e){return{objectId:e.objectId,objectUrl:e.objectUrl,siteUrl:e.siteUrl,serverRelativeUrl:e.serverRelativeUrl,title:e.title,type:e.type}},e.prototype.getMessageParams=function(e,t){return{conversationId:t,replyChainId:"",messageSubject:"",messageBody:"",messagePreview:"",fileAttachments:[e],extensions:"",mentions:"",embeddedLinks:[],isHtml:!0,importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:""}},e}();angular.module("teamspace.fileDocumentTitleBar",["teamspace.layoutService","teamspace.utilityService","teamspace.loggingService","teamspace.messageService","teamspace.settingsService","teamspace.filesEntityService","teamspace.authenticationService","teamspace.filesMessagePaneHelper"]).component("fileDocumentTitleBar",{bindings:{isEditMode:"<?",editAction:"<?",fileName:"<",fileType:"<",fileId:"<",hideClose:"<?",onClose:"&?",isEnabled:"=",inlineActions:"<?",primaryOptions:"<?",moreOptions:"<?",conversationInfo:"<?",createFileAttachment:"&?",provider:"<?",error:"<?",errorReasonForTelemetry:"<?"},template:s,controller:o}).run(["$templateCache",function(e){e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html",n),e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html",r)}])},2152:function(e,t){e.exports='<div class="app-title-bar" analytics-panel="{{::$ctrl.panelRegions.main}}" analytics-panel-view="{ panel: {type: {{$root.trackConstants.panelType.documentStage}} }}" track-data="{{::$ctrl.trackData}}">\n  <svg-include class="title-component title-visible svg-icon" ng-if="$ctrl.isSvgIcon" src="::$ctrl.fileIconPath"></svg-include>\n  <div class="title-component title-visible img-icon" ng-if="!$ctrl.isSvgIcon">\n    <img ng-src="{{::$ctrl.fileIconPath}}" alt="{{::$ctrl.iconAltTextKey|translate}}" title="{{::$ctrl.iconAltTextKey|translate}}"/>\n  </div>\n  <h1 class="title-component title-visible" data-tid="document-stage-title-bar">\n    <span class="document-title" tabindex="0" role="heading">{{::$ctrl.fileName}}</span>\n  </h1>\n  \x3c!--\n    TODO: Requirement 437506\n      <span class="save-status" id="file-save-status"></span>\n  --\x3e\n</div>\n<div class="right-side-buttons pull-right">\n  <div ng-if="::$ctrl.thumbnailImgSrc" class="provider-icon">\n    <span class="app-svg img-container">\n      <img ng-src="{{::$ctrl.thumbnailImgSrc}}"/>\n    </span>\n  </div>\n  <div ng-if="$ctrl.inlineActions && $ctrl.inlineActions.length">\n    <button class="ts-sym inline-action" type="button" ng-repeat="menuItem in $ctrl.inlineActions track by $index" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" ng-click="menuItem.click()" ng-disabled="!$ctrl.isEnabled" aria-label="{{menuItem.title || menuItem.displayName || undefined}}" ng-attr-title="{{menuItem.title || undefined}}">\n      <svg-include src="menuItem.svgPath"></svg-include>\n      <span>{{menuItem.displayName}}</span>\n    </button>\n  </div>\n  <div class="btn-edit btn-group" ng-if="$ctrl.isEditButtonAvailable && !$ctrl.isEditMode && $ctrl.editAction">\n      <button class="btn ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" aria-label="{{::$ctrl.primaryOptions.primaryButtonAria}}" type="button" ng-click="$ctrl.editAction()" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" data-tid="title-bar-primary-edit-button">\n        <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      </button>\n      <div ng-if="::$ctrl.hasPrimaryOptions" class="dropdown-separator"></div>\n      <button ng-if="::$ctrl.hasPrimaryOptions" aria-label="{{::$ctrl.primaryOptions.dropdownButtonText}}" class="btn ts-btn ts-btn-fluent tn-btn-titlebar inset-border dropdown-toggle-split" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-dropdown-edit-button">\n        <svg-include src="\'svg/icons-triangle-down-small.html\'"></svg-include>\n      </button>\n  </div>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-if="::$ctrl.hasPrimaryOptions && !$ctrl.editAction" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-edit-button">\n      <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      <ng-include src="\'svg/icons-triangle-down-small.html\'"></ng-include>\n    </button>\n    <button ng-show="$ctrl.showStartConversationButton" class="ts-btn ts-btn-fluent ts-btn-fluent-secondary ts-btn-fluent-titlebar" type="button" ng-click="$ctrl.startConversation()" translate-once="{{::$root.resources.strings.files_startConversation }}" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Starts a conversation around the file and opens the chat pane" data-tid="start-conversation" ng-disabled="!$ctrl.isEnabled">\n    </button>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-secondary btn-close ts-btn-fluent-titlebar" ng-if="$ctrl.onClose && !$ctrl.hideClose" type="button" ng-click="$ctrl.onClose()" track-outcome="{{::$root.trackConstants.trackOutcome.nav}}" track-scenario="{{::$root.trackConstants.trackScenario.closeDocumentStage}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageCloseButton}}" track-type="{{::$root.trackConstants.trackType.other}}" track-summary="Close the document stage" aria-label="{{::$root.resources.strings.files_closeDocumentStageAria | translate }}" translate-once="{{::$root.resources.strings.files_closeFullscreenButton }}" data-tid="fullscreen-close-button">\n    </button>\n</div>\n<span ng-if="!$ctrl.hasMoreOptions" class="right-padding"></span>\n<div ng-if="$ctrl.hasMoreOptions" class="inline-button pull-right">\n  <button class="ts-sym app-icons-fill-hover" title="{{::$ctrl.moreOptionsText}}" aria-label="{{::$ctrl.moreOptionsText}}" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html" data-tid="title-bar-more-button" aria-haspopup="true">\n    <ng-include src="\'svg/icons-more.html\'"></ng-include>\n  </button>\n</div>\n<div class="inline-button pull-right collapsable" ng-class="{\'expand\': $ctrl.layoutService.rightRailVisible || !$ctrl.layoutService.rightRailContext}">\n  <button ng-disabled="!$ctrl.isEnabled" type="button" ng-if="!$ctrl.layoutService.rightRailVisible && $ctrl.layoutService.rightRailContext" class="ts-sym app-icons-fill-hover pull-right" ng-click="$ctrl.rightRailShowExistingComponent()" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Opens the conversation around the file" data-tid="document-chat-expand" title="{{::$root.resources.strings.calling_toggleChat_on|translate}}" aria-label="{{::$root.resources.strings.calling_toggleChat_on|translate}}">\n    <ng-include src="\'svg/icons-chat.html\'"></ng-include>\n  </button>\n</div>\n'},2153:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.primaryOptions.options track by $index" ng-class="::menuItem.class" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" acc-role="focus-default" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" type="button" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{menuItem.id == \'office-open-in-desktop-app\' ? $root.trackConstants.trackScenario.editFileInApp : $root.trackConstants.trackScenario.editFileOnline}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileDocumentTitleBar}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file edit menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Edit a file in app OR edit a file in Office online">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2154:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.moreOptions track by $index" ng-if="::!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" type="button" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" track-outcome="{{::$root.trackConstants.trackOutcome.select}}" track-scenario="{{::$root.trackConstants.trackScenario.selectFileAction}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileActionButton}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file action menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Choose a file action to perform - document stage">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2155:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=i(2156),r=i(45),o=function(){function e(e,t,i,s,n,o,a,l,c,d,h,p,u,f,v,m,g,w,y,S,b,I,C,E,U){var $=this;this.$scope=e,this.$q=t,this.$timeout=o,this.$state=a,this.$window=l,this.$sce=c,this.settingsService=d,this.layoutService=h,this.constants=p,this.loggingService=u,this.utilityService=f,this.filesUtilityService=v,this.authenticationService=m,this.routeUtilityService=g,this.filesDocStageHelperService=w,this.filesMessagePaneHelper=y,this.storageService=S,this.messageService=b,this.routeChangeService=I,this.navigationService=E,this.localizationService=U,this.isEditMode=!0,this.webviewElement=null,this.iframeElement=null,this.isCloseButtonClick=!1,this.canPostConversation=!0,this.isConversationPanelOpen=!1,this.childMessageListner=function(e){if($.iframeElement=$.iframeElement?$.iframeElement:document.getElementById("file-unified-app-viewer-frame"),$.iframeElement&&e.source===$.iframeElement.contentWindow)return $.commonMessageListner({data:e.data})},this.messageType=p.messages.types.newConversation,this.canPostConversation=C.canPostToCurrentChannel(),this.filesConversationEmptChatPaneHeader=i.instant(s.strings.files_conversation_empty_chat_pane_header),this.filesConversationEmptChatPaneBody=i.instant(s.strings.files_conversation_empty_chat_pane_body),this.logger=u.newLogger("FileViewer"),this.useWebview=d.valueAsBoolean(p.settings.names.isDesktopApp)&&!!l.electronSafeIpc&&l.desktopSettings.enableTabWebviews;var T,P,k=l.electronSafeIpc,A=this.layout.bind(this),x=!1;this.jsApiHostSessionId=u.sessionId+"-"+this.scenario.id,k&&this.useWebview?(k.send(p.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),k.once(p.events.desktopApp.webViewCreationEnabled,function(){$.webviewElement=window.document.getElementById("file-unified-app-viewer-webview"),$.webviewElement.setAttribute("webpreferences","nativeWindowOpen=yes"),$.webviewElement.setAttribute("allowpopups",""),$.eventListener=new r.EventListener($.webviewElement);$.eventListener.addListener("ipc-message",function(e){return $.webviewProcessMessage(e)});$.eventListener.addListener("crashed",function(e){return u.event(p.telemetry.webview.crashed,{errorEvent:JSON.stringify(e)})});$.eventListener.addListener("gpu-crashed",function(e){return u.event(p.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(e)})});$.eventListener.addListener("plugin-crashed",function(e){return u.event(p.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(e)})});$.eventListener.addListener("did-fail-load",function(e){u.event(p.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:e?e.errorCode:null,errorDescription:e?e.errorDescription:null})}),$.logger.error("loading failed - did-fail-load fired")}),$.eventListener.addListener("dom-ready",A),$.eventListener.addListener("load-commit",function(e){e&&e.isMainFrame&&(P=T?(Date.now()-T).toString():""),x=e&&e.url&&e.url.startsWith($.filesExpBaseUrl)}),$.eventListener.addListener("did-frame-finish-load",function(e){if(x){var t={filesExpFrameLoadTime:T?(Date.now()-T).toString():"",webviewFirstLoadCommitTime:P};$.logger.info("did-frame-finish-load scenario markers for files exp frame {0}",t),$.scenario.mark("files-experience-frame-load-time",t),x=!1}}),l.addEventListener("resize",A),$.init(),T=Date.now()})):(this.init(),this.registerForBaseEvents()),I.registerRouteChangeHandler(p.states.appDocumentViewer,this.routeChangeHandler.bind(this)),e.$on("$destroy",function(){l.removeEventListener("resize",A),l.removeEventListener("message",$.childMessageListner),$.eventListener&&$.eventListener.destroy(),v.isIntegratedUXEnabled($.fileType)&&w.changeFileNameInTeamsChromeHeader(!1),y&&y.destroyContextMessagePane(),I.unregisterRouteChangeHandler(p.states.appDocumentViewer)})}return e.$inject=["$scope","$q","$translate","resources","$rootScope","$timeout","$state","$window","$sce","settingsService","layoutService","constants","loggingService","utilityService","filesUtilityService","authenticationService","routeUtilityService","filesDocStageHelperService","filesMessagePaneHelper","storageService","messageService","routeChangeService","channelService","navigationService","localizationService"],e.prototype.routeChangeHandler=function(e,t,i,s){var n=this;if(s.name===this.constants.states.appDocumentViewer){var r=!0===this.isCloseButtonClick?this.settingsService.valueFor(this.constants.settings.names.closeDocStagePromiseTimeout):this.settingsService.valueFor(this.constants.settings.names.navigationDocStagePromiseTimeout);if(this.logger.info("unloading timeout {0}",r),this.routeChangeService.unregisterRouteChangeHandler(this.constants.states.appDocumentViewer),0==r)return this.logger.info("navigating away from doc-stage on timeout 0"),void this.$state.go(t,i);this.toStateForUnloading=t,this.toStateParamsForUnloading=i,this.unlockFilePromise=this.filesDocStageHelperService.unlockFile(function(){n.logger.info("navigating away from doc-stage on timeout"),n.$state.go(t,i)},r),e.preventDefault()}},e.prototype.registerForBaseEvents=function(){this.$window.addEventListener("message",this.childMessageListner)},e.prototype.commonMessageListner=function(e){switch(e.data.channel){case"multi-window-manager-channel":return this.handlePostMessagesEvents(e.data.payload)}},e.prototype.handlePostMessagesEvents=function(e){var t=this;switch(this.logger.info("Post message received for event {0}",e.eventId),e.eventId){case teamspace.services.ChildWindowEventRequest.WindowReady:this.logger.info("Child frame has reported ready state");break;case teamspace.services.ChildWindowEventRequest.WindowInitialized:this.logger.info("Child frame has reported it is fully initialized");break;case teamspace.services.ChildWindowEventRequest.NewWindow:this.logger.info("Child frame requested to open new window directly (blocked)");break;case teamspace.services.ChildWindowEventRequest.AadGetToken:var i=e.eventId;if(e.correlationId&&e.payload){n=e.payload.resource;return this.filesUtilityService.updateTokenWarmingRule(n),this.logger.info("Child frame requested AAD token: resource={0}, correlationId={1}",n,e.correlationId),this.authenticationService.getAuthTokens([n]).then(function(s){var n={eventId:i,correlationId:e.correlationId,payload:{token:s}};t.filesDocStageHelperService.sendPostMessage(n,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get auth token: correlationId={0}, error={1}",e.correlationId,i)})}this.logger.error("Expected payload or correlationId for {0} but got none",i);break;case teamspace.services.ChildWindowEventRequest.AadGetCurrentUser:if(e.correlationId)return this.logger.info("Child frame requested current logged in user correlationId={0}",e.correlationId),this.authenticationService.getUserInformation().then(function(i){var s={eventId:e.eventId,correlationId:e.correlationId,payload:{authUser:i}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get current logged in user correlationId={0}, error={1}",e.correlationId,i)});this.logger.error("ERROR: AadGetCurrentUser request was made but no correlationId was given");break;case teamspace.services.ChildWindowEventRequest.AadClearCache:if(e.payload){var n=e.payload.resource;this.logger.info("Child frame requested clear adal cache:  resource={0}, correlationId={1}",n,e.correlationId),n&&this.authenticationService.clearAdalCache(n)}else this.logger.error("Expected data for event {0} but got none",e.event);break;case teamspace.services.ChildWindowEventRequest.HideFileViewerLoader:this.hideSpinner();break;case teamspace.services.ChildWindowEventRequest.StopDocStageScenario:e.payload&&this.handleScenario(e.payload);break;case teamspace.services.ChildWindowEventRequest.GetDriveItemResponse:w=e.payload&&e.payload.sendTime&&Date.now()-e.payload.sendTime;return this.scenario.mark("exp-request-drive-item",{ipcTimeOverhead:w}),this.redeemPromise.then(function(i){t.scenario.mark("redeem-post-success");var n=s({},i,{driveItemCallStartTime:t.driveItemCallStartTime,driveItemCallEndTime:Date.now(),fileActions:t.filesUtilityService.isIntegratedUXEnabled(t.fileType)?t.filesDocStageHelperService.getFileActions(i,t.hideClose):null}),r={eventId:e.eventId,correlationId:e.correlationId,payload:n};t.logger.info("sending redeem response to Files experience"),t.filesDocStageHelperService.sendPostMessage(r,t.iframeElement,t.webviewElement);var o=t.utilityService.getIconClass({type:t.fileType})===t.constants.css.fileIcons.powerpoint,a=i.currentUserRole&&i.currentUserRole.readOnly,l=i.file&&i.file.irmEnabled;!a&&!l||o?t.filesUtilityService.isIntegratedUXEnabled(t.fileType)&&!1===t.displayTitleBar&&t.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,t.fileName):(t.displayTitleBar=!0,t.isEditMode=!0)});case teamspace.services.ChildWindowEventRequest.AddScenarioMarker:e.payload&&this.addScenarioMarker(e.payload);break;case teamspace.services.ChildWindowEventRequest.FilesExperienceSendData:switch(this.logger.info("Post message received with messageId {0}",e.payload.MessageId),e.payload.MessageId){case"App_AccessibilityLoopComplete":var r="backward"!==e.payload.Values.Direction;this.layoutService.navigateToNextLandmark(r);break;case"Wac_ActionComplete":this.logger.info("wac action completed {0} ",e.payload);var o=e.payload.Values&&e.payload.Values.Action;if(!o)return void this.logger.info("unknown action reported from WAC");if("OpenInBrowser"===o)return this.findAndPerformActionButtonClick("office-open-in-new-tab"),void this.filesDocStageHelperService.logAction("Open_In_Browser",this.fileId);"OpenInDesktop"===o&&this.filesDocStageHelperService.logAction("Open_In_Desktop",this.fileId);var a=e.payload.sendTime,l=e.payload.SendTime,c=l&&a?(a-l).toString():"",d=a?(Date.now()-a).toString():"",h=l?(Date.now()-l).toString():"",p=e.payload.Values&&e.payload.Values.wdUserSession,u=this.constants.scenarios.files.openOfficeFileInDesktop,f=this.loggingService.newScenario(u);f.eventData.entryPoint=this.serviceName,f.eventData.context=this.ctx||this.utilityService.getUrlRootContext(),f.eventData.type=this.fileType,f.eventData.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,f.stop({ipcOverheadToExperienceFromWac:c,ipcOverheadToMainAppFromExperience:d,ipcOverHead:h,wdUserSession:p,jsApiHostSessionId:this.jsApiHostSessionId});break;case"Action_Button_Click":var v=e.payload&&e.payload.SendTime,m={ipcOverheadToExperienceFromWac:v&&e.payload.receivedTime?(e.payload.receivedTime-v).toString():"",ipcOverheadToMainAppFromExperience:e.payload.receivedTime?(Date.now()-e.payload.receivedTime).toString():"",ipcOverHead:v&&(Date.now()-v).toString(),ipcCorrelationId:e.payload.CorrelationId,ipcwdUserSession:e.payload.wdUserSession,jsApiHostSessionId:this.jsApiHostSessionId};this.logger.info("wdUserSession {0} correlationId {1} hostSessionId {2}",e.payload.wdUserSession,e.payload.CorrelationId,this.jsApiHostSessionId);var g=this.constants.scenarios.files.actionButton+"_"+e.payload.button;this.loggingService.newScenario(g).stop(m),this.handleActionButtonsClick(e.payload.button),this.filesDocStageHelperService.logAction(e.payload.button,this.fileId);break;case"Unload":var w=e.payload.sendTime&&Date.now()-e.payload.sendTime;this.$timeout.cancel(this.unlockFilePromise),this.closeFileUnlockScenario(w),this.$state.go(this.toStateForUnloading,this.toStateParamsForUnloading);break;case"Reboot":if(this.isTabbedFile())return void this.logger.info("wrong reboot file path");var y=this.routeUtilityService.getRootRouteParams(),S={documentViewerParams:s({},y,{reboot:!0}),viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(S);break;case"Error":this.handleErrorFromNStarExperience(e.payload);break;case"App_SwitchMode":this.handleModeSwitch(e.payload);break;case"Get_ReplyChainId":var b=void 0,I=this.getMessageIdFromRouteParams();I?b=this.$q.resolve(I):(this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),b=this.replyChainIdPromise),b.then(function(i){var s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,correlationId:e.correlationId,payload:{replyChainId:i,threadId:t.threadId}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)});break;case"Open_File":this.gotoSPOFile(e.payload)}break;default:this.logger.info("Child frame has reported event {0} which doesn't exist {1}",e.eventId,e)}},e.prototype.gotoSPOFile=function(e){var t=e.serviceName?e.serviceName:this.constants.files.serviceName.teams,i={documentViewerParams:{fileType:e.fileType,serviceName:t,objectUrl:e.objectUrl,threadId:e.threadId,messageId:e.messageId,baseUrl:e.baseUrl,fileId:e.fileId,viewerAction:this.constants.files.fileActions.viewer.view},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(i)},e.prototype.handleErrorFromNStarExperience=function(e){this.hideSpinner(),this.handleScenario(s({status:!1},e)),this.displayTitleBar=!0,this.fileErrorCode=this.constants.files.error.unknown+"_unifiedapp"},e.prototype.handleActionButtonsClick=function(e){switch(e){case"Conversation":this.layoutService.rightRailVisible?this.layoutService.rightRailHide():this.isConversationPanelOpen?this.isConversationPanelOpen=!1:this.setUpConversationPane();break;case"Close":this.isCloseButtonClick=!0,this.onClose();break;case"Open_In_Desktop":this.findAndPerformActionButtonClick("office-open-in-desktop-app");break;case"Open_In_Browser":this.findAndPerformActionButtonClick("office-open-in-new-tab");break;case"Download":this.findAndPerformActionButtonClick("download-office-document")}},e.prototype.findAndPerformActionButtonClick=function(e){this.moreOptions.filter(function(t){return t.id===e})[0].click()},e.prototype.initiateConversation=function(e){var t=this,i=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.redeemPromise.then(function(e){var i=e,s=i.webDavUrl,n=i.name,r=i.sharepointIds,o=r.siteUrl,a=r.listItemUniqueId;return{serverRelativeUrl:t.filesUtilityService.extractServerRelativeUrl(s),siteUrl:o,objectUrl:s,objectId:a,title:n,type:t.fileType}}).then(function(s){var n=t.createMessageWithCurrentFile(e,s);return n.scenario=i,t.messageService.createMessage(n)}).then(function(e){t.isConversationPanelOpen=!1,t.storageService.set(""+t.constants.files.strings.saveChatIsExpanded,!0),t.filesMessagePaneHelper.initializeContextMessagePane(t.fileId,t.threadId,!1,e.messageId),t.replyChainIdPromise=null}).then(function(){return i.stop()}).catch(function(e){var s="Failed to start conversation";t.loggingService.error(s),i.fail({error:s})})},e.prototype.createMessageWithCurrentFile=function(e,t){var i={conversationId:this.threadId,replyChainId:"",messageSubject:e?e.subject:"",messageBody:e?e.message:"",messagePreview:e?e.preview:"",fileAttachments:e?e.attachments:[],extensions:e?e.extensions:"",mentions:e?e.mentions:"",embeddedLinks:e?e.embeddedlinks:[],isHtml:!0,importance:e?e.importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:e?e.draftObjectId:""};return i.fileAttachments.push(t),i},e.prototype.setUpConversationPane=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened),i=/p2p/i.test(this.serviceName);if(i)return this.storageService.set(""+this.constants.files.strings.saveChatIsExpanded,!0),this.filesMessagePaneHelper.showRightRail(this.threadId,void 0,teamspace.services.ReplyChainIdType.MessageId,i),void t.stop();this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),this.replyChainIdPromise.then(function(s){s?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e.threadId,s,teamspace.services.ReplyChainIdType.ParentMessageId,i),t.stop()):e.isConversationPanelOpen=!0}).catch(function(){e.replyChainIdPromise=null;var i="Failed to get reply chain";e.loggingService.error(i),t.fail({error:i})})},e.prototype.closeConversationPane=function(){this.isConversationPanelOpen=!1},e.prototype.addScenarioMarker=function(e){var t=e.errorMessage,i=e.sendTime,s=e.scenarioMarker,n=e.cached,r=i&&Date.now()-i;this.logger.info("scenarioMarker {0}",s),this.scenario.mark(s,{ipcTimeOverhead:r,errorMessage:t,cached:n})},e.prototype.closeFileUnlockScenario=function(e){var t=this.routeUtilityService.getRootRouteParams(),i=t.serviceName?decodeURIComponent(t.serviceName):void 0,s=this.filesDocStageHelperService.getPivot(i),n=this.constants.scenarios.files.closeFile+"_"+s,r=this.loggingService.findScenario(n);r?r.stop({ipcTimeOverhead:e,openFileScenarioId:this.scenario&&this.scenario.id}):this.logger.error("file-unified-app-viewer: could not find scenario"),this.logger.info("navigating away from doc-stage on Unload post-message")},e.prototype.handleScenario=function(e){var t=e.status,i=e.sendTime,s=e.officeSessionId,n=i&&Date.now()-i;if(t){var r=e.deltaWithPerceivedBoot;this.scenario.stop({deltaWithPerceivedBoot:r,officeSessionId:s,ipcTimeOverhead:n})}else{var o=e.errorMessage;this.scenario.fail({errorMessage:o,officeSessionId:s,ipcTimeOverhead:n})}this.logger.info("officeSessionId {} hostSessionId {}",s,this.jsApiHostSessionId)},e.prototype.handleFocus=function(e){var t=e.target.dataset.focusDirection||(e.shiftKey?"backward":"forward"),i={MessageId:"Host_AccessibilityLoopComplete",SendTime:Date.now(),Values:{Direction:t}},s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:i};(this.iframeElement||this.webviewElement).focus(),this.filesDocStageHelperService.sendPostMessage(s,this.iframeElement,this.webviewElement)},e.prototype.handleModeSwitch=function(e){var t=this;if(this.filesUtilityService.isIntegratedUXEnabled(this.fileType)){var i=e.Editable;if("view"===e.NewMode)this.$scope.$apply(function(){t.displayTitleBar=!0,t.isEditMode=!i}),this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);else if("edit"===e.NewMode){var s=this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,n=this.loggingService.findScenario(s);n?n.stop({jsApiHostSessionId:this.jsApiHostSessionId}):this.logger.error("scenario corresponging to excel file edit not found"),this.displayTitleBar=!1,this.isEditMode=!0,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)}else this.logger.error("Switched to unknown mode: "+e.NewMode)}},e.prototype.init=function(){var e=this.getNStarViewerExpUrl();this.fileViewerExpUrl=this.$sce.trustAsResourceUrl(e)},e.prototype.getNStarViewerExpUrl=function(){var e=(this.utilityService.djb2_hash(""+this.objectUrl)||"").toString(),t=this.filesDocStageHelperService.getFilesExperienceOrigin()+"/files/apps/com.microsoft.teams.files/files/"+e+"/open";this.filesExpBaseUrl=t;var i=this.settingsService.getActiveTheme(),s=this.localizationService.getLocale(),n=this.isTabbedFile(),r={agent:"postmessage",objectUrl:this.objectUrl,fileId:this.fileId,fileType:this.fileType,messageId:this.getMessageIdFromRouteParams(),userClickTime:this.userClickTime,ctx:this.ctx,scenarioId:this.scenario&&this.scenario.id||null,locale:s,isTabbedFile:n,theme:i,version:this.settingsService.getOrbitalVersion(this.constants.settings.orbitals.files)},o=this.settingsService.getRing(),a={"ring.id":o&&o.id||"",createdTime:Date.now()},l=t+"?"+Object.keys(r).filter(function(e){return r[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")+"&"+Object.keys(a).map(function(e){return"setting="+e+":"+a[e]}).join("&"),c=this.utilityService.parseUrl(l),d="iframe-container.html#iframeurl="+encodeURIComponent(this.$sce.trustAsResourceUrl(c.href))+"&skipDomainValidation=true";return this.useWebview?d:l},e.prototype.webviewProcessMessage=function(e){return this.commonMessageListner({data:e.args[1]})},e.prototype.layout=function(){if(this.webviewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webviewElement.clientWidth,t=this.webviewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.getMessageIdFromRouteParams=function(){return this.routeUtilityService.getRootRouteParams().messageId},e.prototype.isTabbedFile=function(){var e=this.routeUtilityService.getRootRouteParams();return e&&e.middlePane&&e.middlePane.startsWith("tab::")||"pinned-tab"===this.scenario.eventData.entryPoint},e}();t.FileUnifiedAppViewerController=o,angular.module("teamspace.fileUnifiedAppViewer",["teamspace.layoutService","teamspace.settingsService","teamspace.constants","teamspace.loggingService","teamspace.utilityService","teamspace.filesUtilityService","teamspace.routeUtilityService","teamspace.filesDocStageHelperService","teamspace.channelService","teamspace.filesMessagePaneHelper","teamspace.messageService","teamspace.storageService","teamspace.routeChangeService","teamspace.navigationService"]).component("fileUnifiedAppViewer",{bindings:{fileType:"<",objectUrl:"<",scenario:"<",hideClose:"<?",onClose:"&?",userClickTime:"<",ctx:"<",redeemPromise:"<",driveItemCallStartTime:"<",displayTitleBar:"=",isEditMode:"=",moreOptions:"<?",hideSpinner:"<?",fileName:"<",serviceName:"<",threadId:"<",fileId:"<"},template:n,controller:o})},2156:function(e,t){e.exports='<div id="file-unified-app-viewer" class="flex-fill" ng-focus="$ctrl.handleFocus($event)" tabindex="0">\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode">\n  </file-full-alert>\n\n  <div ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <iframe id="file-unified-app-viewer-frame" ng-if="::!$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-unified-app-viewer-webview" ng-if="::$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n<div class="ts-right-rail thread-right-rail file-unified-app-viewer-conversation-panel" ng-if="$ctrl.isConversationPanelOpen">\n  <div class="file-unified-app-viewer-conversation-panel-container">\n    <div class="ts-canvas-message-pane">\n      <div class="conversation-title-bar">\n        <button class="ts-sym app-icons-fill-hover conversation-close" aria-label="{{::$root.resources.strings.files_conversation_chat_pane_close_button_aria_label| translate:{fileName:$ctrl.fileName} }}" title="{{::$root.resources.strings.files_conversation_chat_pane_close_button_tooltip | translate}}" ng-click="$ctrl.closeConversationPane()" acc-role="tab-handler-close-conversation-pane" tabindex="-1">\n          <ng-include class="icon icons-close" src="\'svg/icons-close.html\'"></ng-include>\n        </button>\n      </div>\n      <div class="file-unified-app-viewer-conversation-panel-container-body">\n        <img src="https://statics.teams.cdn.office.net/hashedassets/placeholders/zero_chat-eaac2004.svg" class="files-zero-chat-icon"/>\n        <h4 class="file-empty-header-text">{{$ctrl.filesConversationEmptChatPaneHeader}}</h4>\n        <h5 class="file-empty-body-text">{{$ctrl.filesConversationEmptChatPaneBody}}</h5>\n        <div class="ts-files-start-conversation">\n          <div class="message-expander">\n            <div class="ts-files-add-message" id="add-new-message" data-tid="channelNewMessageContainer" ng-disabled="!$ctrl.canPostConversation">\n              <new-message send-message="$ctrl.initiateConversation(messageData, scenario)" message-type="::$ctrl.messageType" hide-people-picker="false" conversation-id="::$ctrl.threadId">\n              </new-message>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},2157:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=i(2158),r=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,f,v,m,g){var w=this;this.$scope=e,this.$window=i,this.$timeout=n,this.$cookies=r,this.constants=o,this.loggingService=a,this.settingsService=l,this.utilityService=c,this.authenticationService=d,this.appConfig=h,this.eventingService=p,this.filesActionService=f,this.filesUtilityService=v,this.appStateService=m,this.sharepointShareService=g,this.postMessageId="teams",this.clientId="MicrosoftTeams",this.webViewElement=null,this.loadingComplete=!0,this.encounteredRedirectError=!1,this.logger=a.newLogger("FileViewer"),this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isDesktopApp=l.valueAsBoolean(o.settings.names.isDesktopApp);var y=!1,S=!1,b=!1;if(i&&i.desktopSettings&&(y=i.desktopSettings.enableWebviewPreload,S=i.desktopSettings.enableWebviewSandbox,b=i.desktopSettings.enableTabWebviews),this.useWebView=l.valueAsBoolean(o.settings.names.filesEnableOneUpWebview)&&this.isDesktopApp&&!!i.electronSafeIpc&&(y&&S||b),this.oneUpServiceUrl=t.trustAsResourceUrl(this.getOneUpServiceUrl()),this.webViewSrc="",this.host=c.parseUrl(s.absUrl()).origin,this.currentLocale=u.getLocale(),e.$on("$destroy",function(){w.removeListeners(),w.scenario.cancel()}),!this.siteUrl||!this.serverRelativeUrl&&!this.fileId){var I=this.siteUrl?"Invalid ServerRelativeURL and FileId":"Invalid SiteURL";return this.logger.error(I),this.errorCode=o.files.error.invalidArguments,void this.handleError(this.errorCode,I)}this.useWebView?this.initWebView():this.getAuthToken().then(function(e){w.initFrame(e)}),this.ensureInitialFocusIsNotStolen()}return e.$inject=["$scope","$sce","$window","$location","$timeout","$cookies","constants","loggingService","settingsService","utilityService","authenticationService","appConfig","eventingService","localizationService","filesActionService","filesUtilityService","appStateService","sharepointShareService"],e.prototype.initWebView=function(){var e=this,t=this.$window.electronSafeIpc;t&&this.useWebView&&(t.send(this.constants.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),t.once(this.constants.events.desktopApp.webViewCreationEnabled,function(){e.webViewElement=window.document.getElementById("file-one-up-viewer-webview"),e.messageSource=e.webViewElement;e.addListener("ipc-message",function(t){return e.webviewProcessMessage(t)});e.addListener("crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.crashed,{errorEvent:JSON.stringify(t)})});e.addListener("gpu-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("plugin-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("did-fail-load",function(t){e.loggingService.event(e.constants.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:t?t.errorCode:null,errorDescription:t?t.errorDescription:null})})});var t=e.layout.bind(e);e.addListener("dom-ready",t),e.$window.addEventListener("resize",t),e.$scope.$on("$destroy",function(){e.$window.removeEventListener("resize",t)}),e.webViewSrc="iframe-container.html#iframeurl=about:blank&processTag="+e.constants.files.strings.oneup}))},e.prototype.layout=function(){if(this.webViewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webViewElement.clientWidth,t=this.webViewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.addListener=function(e,t){this.webViewElement?this.webViewElement.addEventListener(e,t):window.addEventListener(e,t),this.listeners||(this.listeners={}),this.listeners[e]=t},e.prototype.removeListeners=function(){for(var e in this.listeners)this.webViewElement?this.webViewElement.removeEventListener(e,this.listeners[e]):window.removeEventListener(e,this.listeners[e]);this.listeners=null},e.prototype.webviewProcessMessage=function(e){if((e&&e.channel)===this.constants.webViewShim.postMessageFromWebview){var t=e.srcElement||e.target;if(this.webViewElement===t)if(!e.args||e.args.length<2)this.logger.error("OneUp viewer did not receive all the params");else{var i=e.args&&e.args[0];window&&window.location&&window.location.origin===i?this.handlePostMessageFromContainer(e.args[1]):this.oneUpServiceOrigin===i?this.handlePostMessage({origin:e.args[0],data:e.args[1],source:this.webViewElement}):this.logger.error("invalid event origin {0}",i)}else this.logger.error("OneUp viewer received message from a different webview")}},e.prototype.handlePostMessageFromContainer=function(e){if(e&&e.func){if("iframeLoaded"===e.func)return void this.postFormToWebview();if("error"===e.func)return void this.handleCurrentWindowErrorMessage(e)}},e.prototype.postFormToWebview=function(){var e=this;this.getAuthToken().then(function(t){e.embedParams=e.getEmbedParams(t),e.oneUpServiceOrigin=e.utilityService.parseUrl(e.oneUpServiceUrl).origin,e.encounteredRedirectError=!1,e.webViewElement.send(e.constants.webViewShim.postFormToWebview,{url:e.getOneUpServiceUrl(),params:{context:e.embedParams}})})},e.prototype.handleCurrentWindowErrorMessage=function(e){var t="";try{t=JSON.stringify(e.args)}catch(e){t=e.toString()}this.logger.error("received errorCode: {0}, errorMessage {1} for oneup viewer","IPC error",t),this.handleError("IPC error",t)},e.prototype.initFrame=function(e){this.encounteredRedirectError=!1;var t=document.getElementById("file-one-up-viewer-frame"),i=document.getElementById("file-one-up-viewer-form"),s=document.getElementById("file-one-up-viewer-context");t&&(this.messageSource=t.contentWindow),this.embedParams=this.getEmbedParams(e);try{s.value=JSON.stringify(this.embedParams)}catch(e){this.logger.error("Exception in stringfying embed params correlationId {0} ",this.embedParams.correlationId),this.errorCode=this.constants.files.error.invalidArguments}this.registerPostMessageHandler(),i.submit()},e.prototype.getEmbedParams=function(e){var t={id:this.postMessageId,o:this.host,ct:(new Date).getTime()},i=this.getOneUpThemePayload();return{authToken:e,webUrl:this.siteUrl,UniqueId:this.fileId&&this.fileId.replace(/{|}/g,""),id:this.serverRelativeUrl,embed:JSON.stringify(t),culture:this.currentLocale,client_id:this.clientId,correlationId:this.loggingService.sessionId+"-"+this.scenario.id,useHostDownload:!0,theme:i,item:this.driveItem}},e.prototype.getOneUpThemePayload=function(){var e={themePrimary:"#6264a7",themeDark:"#293370"},t={buttonPrimaryTextHovered:"#fff",buttonPrimaryTextFocused:"#fff"};return(this.$cookies.get(this.constants.themes.cookieName)||this.constants.themes.default)===this.constants.themes.highContrast&&(e.themePrimary="#000",e.themeDark="#ffff01",e.neutralLighter="#fff",t.buttonPrimaryTextFocused="#252424",t.buttonPrimaryTextHovered="#252424"),{palette:e,semanticColors:t}},e.prototype.getOneUpServiceUrl=function(){var e=this.appConfig.oneUpServiceConstants.host,t=this.appConfig.oneUpServiceConstants.devHost;return t&&(e=e+"?devHost="+t),e},e.prototype.getAuthToken=function(){var e=this.utilityService.parseUrl(this.siteUrl).origin;return this.filesUtilityService.updateTokenWarmingRule(e),this.authenticationService.getAuthTokens([e])},e.prototype.registerPostMessageHandler=function(){var e=this;this.removeListeners();this.addListener("message",function(t){return e.handlePostMessage(t.originalEvent||t)})},e.prototype.handlePostMessage=function(e){var t=this,i=e,s=this.utilityService.parseUrl(this.oneUpServiceUrl).origin,n="[OneDrive:From:Embed:"+this.postMessageId+"]";if(i&&i.origin&&i.origin.toLowerCase()===s.toLowerCase()&&i.source===this.messageSource&&_.startsWith(i.data,n)){var r=i.data.substr(n.length),o=JSON.parse(r||"{}");switch(o.type){case"success":var a=o;this.logger.info("success callback from oneUp {0}",a),this.stopScenario(a.previewType,a.conversationId);break;case"error":var l=o,c=l.error?l.error.code:this.constants.files.error.unknownOneUp,d=l.error?l.error.message:this.constants.files.error.unknownOneUp,h=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRetryOnRedirectErrorForOneUp);this.logger.info("error callback from oneUp {0}",l),h&&o&&"RedirectError"===o.data?(this.scenario.eventData.specialCase=this.constants.errorCodes.invalidAudienceUri,this.encounteredRedirectError=!0,this.reloadFileOnRedirectError(l.conversationId)):!this.encounteredRedirectError&&this.handleError(c,d,l.conversationId,l.isExpected);break;case"download":if(this.serviceName&&this.fileDetail){var p={serviceName:this.serviceName,getContextBase:function(){return t.filesUtilityService.getContextBase(t.fileDetail,t.serviceName,void 0,t.fileDetail.objectUrl,!1)}};this.filesActionService.execute(teamspace.services.EntityActionType.Download,this.fileDetail,p)}else this.loggingService.error("oneUp download failed because fileDetail or serviceName undefined for scenario "+this.scenario.id)}i.source&&void 0!==o.conversationId&&this.postAckMessage(i.source,o.conversationId)}},e.prototype.reloadFileOnRedirectError=function(e){var t=this;this.scenario.mark("get_updated_site_url_start"),this.sharepointShareService.getSiteResourceInfo(this.siteUrl).then(function(i){t.scenario.mark("get_updated_site_url_end"),i!==t.siteUrl?(t.updateOneUpParams(i),t.useWebView?t.postFormToWebview():t.getAuthToken().then(function(e){t.initFrame(e)})):(t.scenario.mark("updated_site_unchanged"),t.scenario.eventData.specialCase=null,t.handleError(t.constants.errorCodes.invalidMultiGeoCase,"Retry not needed. Not true multi geo case",e,!1))}).catch(function(i){t.scenario.mark("get_updated_site_url_fail"),t.fileErrorCode=i.statusCode||i.errorCode,t.handleError("GRAPH_"+(i.statusCode||i.errorCode),i.errorMessage,e,!1)})},e.prototype.updateOneUpParams=function(e){this.siteUrl=e;var t=this.utilityService.parseUrl(this.siteUrl).origin,i=this.utilityService.parseUrl(this.objectUrl).pathname;this.fileDetail=s({},this.fileDetail,{siteUrl:e,objectUrl:""+t+i})},e.prototype.postAckMessage=function(e,t){if(e){var i={type:"acknowledge",conversationId:t},s="[OneDrive:To:Embed:"+this.postMessageId+"]"+JSON.stringify(i);if(this.useWebView&&this.webViewElement)this.webViewElement.send(this.constants.webViewShim.postMessageToWebview,s);else{var n=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;e.postMessage(s,n)}}},e.prototype.stopScenario=function(e,t){this.loadingComplete=!0,this.eventingService.$emit(this.constants.events.files.fileOneUpViewerLoaded,{conversationId:t,previewType:e,useWebview:this.getUseWebViewFlag(),scenario:this.scenario})},e.prototype.handleError=function(e,t,i,s){this.loadingComplete=!0,(!this.appStateService.isOnline||!this.appStateService.isConnected)&&(e=this.fileErrorCode=this.constants.errorCodes.networkOffline,t="Network is offline",s=!0),s||this.checkIfExpectedFailure(e)?this.scenario.incomplete({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag(),isExpectedFailure:this.constants.files.isExpectedFailure.yes}):this.scenario.fail({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag()})},e.prototype.checkIfExpectedFailure=function(e){var t=this.constants.responseCode;return-1!==[t.unauthorizedAccess,t.forbidden,t.notFound,t.notAcceptable].indexOf(Number(e))},e.prototype.getUseWebViewFlag=function(){return this.useWebView?"true":"false"},e.prototype.ensureInitialFocusIsNotStolen=function(){var e=this,t=angular.element(this.$window);this.onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler()),this.onWindowBlur=function(t){return e.onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e.onWindowBlur)})},e.prototype.onWindowBlurHandler=function(e){var t=this;angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler(),this.onWindowBlur=null,this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOneUpViewer",["teamspace.settingsService","teamspace.utilityService","teamspace.authenticationService"]).component("fileOneUpViewer",{bindings:{scenario:"<",type:"<",siteUrl:"<",serverRelativeUrl:"<",fileDetail:"<",serviceName:"<",driveItem:"<",fileId:"<",objectUrl:"<"},template:n,controller:r})},2158:function(e,t){e.exports='<div id="file-one-up-viewer" class="flex-fill">\n\n  <div ng-if="!$ctrl.loadingComplete">\n      <busy-animation size="medium" context="file-one-up-viewer">\n      </busy-animation>\n  </div>\n\n  <file-full-alert class="flex-fill" object-url="{{$ctrl.objectUrl}}" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode">\n  </file-full-alert>\n\n  <div ng-style="{\'visibility\' : $ctrl.loadingComplete ? \'visible\' : \'hidden\'}" ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <form id="file-one-up-viewer-form" target="file-one-up-viewer-frame" method="POST" action="{{$ctrl.oneUpServiceUrl}}" hidden>\n      <input id="file-one-up-viewer-context" type="text" name="context"/>\n      <input type="submit"/>\n    </form>\n\n    <iframe id="file-one-up-viewer-frame" name="file-one-up-viewer-frame" ng-if="::!$ctrl.useWebView" ng-src="about:blank" sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-one-up-viewer-webview" ng-if="::$ctrl.useWebView" ng-src="{{$ctrl.webViewSrc}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n'},2159:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2160),n=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,f,v,m,g,w,y,S,b,I,C){var E=this;this.$q=e,this.$scope=t,this.$state=i,this.$translate=s,this.constants=n,this.resources=r,this.loggingService=o,this.utilityService=a,this.routeUtilityService=l,this.filesEntityService=c,this.filesUtilityService=d,this.filesActionService=h,this.analyticsService=p,this.filesActionRouter=u,this.filesProviderFactory=f,this.settingsService=v,this.sharepointScenarioHandler=m,this.sharePointFilePreviewService=g,this.filesRedeemService=y,this.navigationService=S,this.filesDocStageHelperService=I,this.filesSharingHelper=C,this.isPreProcessingComplete=void 0,this.useNStarViewerExpInMainWindow=!1,this.displayTitleBar=!0,this.showSpinner=!0,this.scenarioComplete=!1,this.fileDetailsFetchSuccess=!1,this.logger=o.newLogger("FileViewer");var U=l.getRootRouteParams();this.ctx=U.ctx?decodeURIComponent(U.ctx):void 0,this.accessType=U.accessType;var $;!this.objectUrl||U.fileName&&this.fileType||($=d.getFileNameFromObjectURL(this.objectUrl)),this.fileName=U.fileName?U.fileName:$,this.fileId=this.fileId&&this.fileId.replace(/{|}/g,""),!this.shareUrl&&U.shareUrl&&(this.shareUrl=U.shareUrl),!this.shareId&&U.shareId&&(this.shareId=U.shareId),C.shareLogInfo(n.files.actionLogs.fileOpen,this.fileId,this.shareUrl?"shareUrl exists":"shareUrl does not exist"),this.isNewFile=this.ctx===n.scenarios.files.newFileCreationContext;var T=this.getActionType(),P=v.valueAsBoolean(n.settings.names.filesEnableSharePointFilePreviewService);if(i.current.name!==n.states.appDocumentViewer&&i.current.name!==n.states.appAppsAppFileSection||U.viewerAction!==n.files.fileActions.viewer.edit?(this.viewerType=P?g.getPreviewerType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!1):(this.viewerType=P?g.getEditorType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!0),this.objectUrl&&d.isNStarViewerExpInMainWindowEnabled(this.fileType)&&b.getBrowser()!==n.browser.ie&&(this.wacEdit=!0,this.useNStarViewerExpInMainWindow=!0,d.isIntegratedUXEnabled(this.fileType)&&(this.displayTitleBar=T===n.wopiActions.view||!this.wacEdit),this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,this.fileType===n.fileExtensions.email&&(this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email,this.setFileDetails()),this.hideSpinner=function(){return E.showSpinner=!1}),w.$on(t,n.events.files.fileOneUpViewerLoaded,function(e,t){E.oneUpViewerLoadSucessMessage=t,E.stopScenario()}),this.useOneUp=this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp,this.scenario=o.findScenario(this.scenarioName),this.scenario||(o.warn("file-office-frame: could not find scenario"),this.scenario=o.newScenario(this.scenarioName,null,function(){E.scenarioComplete=!0},n.timeInMiliseconds.tenMinutes),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName}),this.scenario.eventData.viewerType=this.viewerType,this.scenario.eventData.type=d.scrubUnknownFileExtensions(this.fileType),this.scenario.eventData.isShareUrlPresent=!!this.shareUrl,this.logger.info("sessionId {0} scenarioId {1} viewerType {2}",o.sessionId,this.scenario.id,this.viewerType),this.baseUrl||(this.baseUrl=d.extractSiteUrl(this.objectUrl)),this.useOneUp&&(this.oneUpParams={baseUrl:this.baseUrl,fileType:this.fileType,scenario:this.scenario,serverRelativeUrl:d.extractServerRelativeUrl(this.objectUrl)}),t.$on("$destroy",function(){E.scenarioComplete||E.scenario.cancel()}),this.logger.info("type {0} isOneUp {1} isUnified {2}",this.fileType,this.useOneUp,this.useNStarViewerExpInMainWindow),this.useOneUp&&!a.isDocumentType(this.fileType))return this.setFileDetails(),void this.redeemFile(this.viewerType,U,$,T,!1);this.useNStarViewerExpInMainWindow?this.redeemFile(this.viewerType,U,$,T,!1):this.redeemFile(this.viewerType,U,$,T)}return e.$inject=["$q","$scope","$state","$translate","constants","resources","loggingService","utilityService","routeUtilityService","filesEntityService","filesUtilityService","filesActionService","analyticsService","filesActionRouter","filesProviderFactory","settingsService","sharepointScenarioHandler","sharePointFilePreviewService","eventingService","filesRedeemService","navigationService","platformDetectService","filesDocStageHelperService","filesSharingHelper"],e.prototype.getActionType=function(){if(this.isNewFile)return this.constants.wopiActions.editNew;var e=this.utilityService.getIconClass({type:this.fileType}),t=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord);switch(e){case this.constants.css.fileIcons.word:return t?this.constants.wopiActions.view:this.constants.wopiActions.open;case this.constants.css.fileIcons.visio:case this.constants.css.fileIcons.excel:return this.constants.wopiActions.open;case this.constants.css.fileIcons.powerpoint:return this.constants.wopiActions.edit;default:return}},e.prototype.redeemFile=function(e,t,i,s,n){var r=this;if(void 0===n&&(n=!0),this.logger.info("isDetailCallNeeded {0} isShareUrl {1} isNStarViewerExperience {2}",n,this.shareUrl,this.useNStarViewerExpInMainWindow),this.shareUrl||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp){var o={fileId:this.fileId,shareId:this.shareId},a=this.settingsService.valueAsBoolean(this.constants.settings.names.enableInValidAudienceErrorRetryForUnifiedApps),l=this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp&&a;this.scenario.mark("redeem-call-started"),this.driveItemCallStartTime=Date.now(),this.redeemPromise=this.filesRedeemService.redeemFile(this.objectUrl,this.shareUrl,this.useNStarViewerExpInMainWindow,s,o,this.baseUrl,l,this.scenario.name),this.redeemPromise.then(function(s){r.scenario.mark("redeem-call-finished"),r.driveItem=s,r.isPreProcessingComplete=!0,n&&r.fetchFileDetailsAndSetHeaders(e,t,i)}).catch(function(e){r.logger.error("Error in redeem call"),r.scenario.mark("redeem-call-failed"),r.onFileLoadError(e,!0)}).finally(function(){if(r.setFileDetails(),r.useNStarViewerExpInMainWindow){if(r.isPreProcessingComplete&&!r.isValidDriveItem(r.driveItem,r.fileType)){r.scenario.mark("redeem-call-incomplete");var e={statusCode:200,message:"jsAPI parameters missing in driveItem API response"};return r.logger.error("jsapi params missing in redeem call response"),void r.onFileLoadError(e,!0)}r.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp&&r.isValidDriveItem(r.driveItem,r.fileType)&&fetch(r.driveItem.openWith.wac.bootstrapperUrl).then(function(e){var t=performance.getEntriesByName(r.driveItem.openWith.wac.bootstrapperUrl).slice(-1)[0],i=t?{latency:t.duration,cached:0===t.transferSize}:void 0;r.scenario.mark("JSAPI script prefetched",i)}).catch(function(e){r.scenario.mark("JSAPI prefetch failed")})}})}else this.isPreProcessingComplete=!0,n&&this.fetchFileDetailsAndSetHeaders(e,t,i)},e.prototype.isValidDriveItem=function(e,t){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email||!!(this.driveItem&&this.driveItem.openWith&&this.driveItem.openWith.wac)},e.prototype.fetchFileDetailsAndSetHeaders=function(e,t,i){var s,n=this,r=this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),o=this.filesActionRouter.getItemDetailsRepository(r),a=!0;(this.useNStarViewerExpInMainWindow||this.isNStarViewerType())&&(a=!1);var l=t.rootContext?decodeURIComponent(t.rootContext):void 0;if(this.getByFileIdAndBaseUrl(l)){var c=this.fileType?this.fileType:this.utilityService.getFileExtension(i);s=o.getById(this.baseUrl,this.fileId,c===this.constants.onenote.extension,this.isNewFile,a)}else s=this.objectUrl?o.getByUrl(this.objectUrl,a):this.$q.reject(teamspace.services.files.FilesError.createFromInternalError(this.constants.files.internalErrorCodes.common.argumentError,"File is not specified."));s.then(function(e){n.scenario.mark("details-call-finished"),n.fileDetail=e.value,n.fileDetail.size&&(n.scenario.eventData.size=n.utilityService.bytesToMb(n.fileDetail.size)),n.useOneUp||(n.wacUrl=n.wacEdit?n.fileDetail.wacUrlEdit:n.fileDetail.wacUrl),n.fileName||(n.fileName=n.fileDetail.title);var t=n.getSiteUrlFromFileDetails(n.fileDetail);if(t=decodeURIComponent(t),n.baseUrl!==t&&(n.baseUrl=t),n.useOneUp){if(!n.oneUpParams){var i=decodeURIComponent(n.fileDetail.objectUrl);n.oneUpParams={baseUrl:t,fileType:n.fileType,scenario:n.scenario,serverRelativeUrl:n.filesUtilityService.extractServerRelativeUrl(i)}}n.oneUpParams.fileDetail=n.fileDetail,n.oneUpParams.serviceName=n.serviceName}return n.fileDetail}).then(function(e){n.initializeTitleAndStopScenario()}).catch(function(e){n.logger.error("Error in details call"),n.onFileLoadError(e,!1,!0)})},e.prototype.setFileDetails=function(){var e=this.objectUrl;this.isPreProcessingComplete&&this.driveItem&&this.driveItem.webUrl&&(e=this.driveItem.webUrl),this.fileDetail={objectId:this.fileId,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,type:this.fileType,wacUrl:"",wacUrlEdit:"",openInWindowFileUrl:e,isPersonal:this.serviceName===this.constants.files.serviceName.personal,siteUrl:""},this.oneUpParams&&(this.oneUpParams.fileDetail=this.fileDetail,this.oneUpParams.serviceName=this.serviceName),this.initializeTitleAndStopScenario()},e.prototype.initializeTitleAndStopScenario=function(){this._initializeTitleBar(),this.fileDetailsFetchSuccess=!0,this.stopScenario()},e.prototype.getByFileIdAndBaseUrl=function(e){return this.baseUrl&&this.fileId&&(e===this.constants.scenarios.files.itemsViewRootContext||this.fileType!==this.constants.onenote.extension)},e.prototype.getSiteUrlFromFileDetails=function(e){return e&&e.objectUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.common.invalidUrl,statusCode:200},!1,!0),e.siteUrl?e.siteUrl:(e.parentListUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.sharepoint.missingListUrl,statusCode:200},!1,!0),this.filesUtilityService.extractSiteUrl(e.objectUrl,e.parentListUrl))},e.prototype.stopScenario=function(){if(this.oneUpViewerLoadSucessMessage&&this.fileDetailsFetchSuccess&&this.oneUpParams&&this.oneUpParams.scenario&&this.oneUpViewerLoadSucessMessage.scenario===this.scenario){var e={conversationId:this.oneUpViewerLoadSucessMessage.conversationId,previewType:this.oneUpViewerLoadSucessMessage.previewType,useWebview:this.oneUpViewerLoadSucessMessage.useWebview};this.oneUpParams.scenario.stop(e)}},e.prototype._initializeTitleBar=function(){var e=this;if(this.fileDetail){var t={serviceName:this.serviceName,getContextBase:function(){return e.filesUtilityService.getContextBase(e.fileDetail,e.serviceName,void 0,e.fileDetail.objectUrl,!1)}},i=this.filesActionService.isReadOnlyNotTeamOwner({accessType:this.accessType,threadId:this.threadId}),s=this.filesEntityService.getOpenInText(this.fileDetail.type),n=this.settingsService.valueAsBoolean(this.constants.settings.names.filesEnableSharePointFilePreviewService);if(this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileDetail.type)){this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)};var r=this.filesUtilityService.getProductLabels(this.fileDetail.type);this.titleBarPrimaryOptions={primaryButtonText:r.desktopProductName,primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabelVisio)}}else{var o=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOfficeViewerEdit);o&&(this.editAction=function(){return e.changeToEdit()});var a=i?this.resources.strings.files_menuLabelOpenInTeams:this.resources.strings.files_menuLabelEditInTeams,l=o&&(!n||this.sharePointFilePreviewService.canEditFileInTeams(this.fileDetail.type)),c={id:"office-edit-in-teams",displayName:this.$translate.instant(a),class:"open-in-teams-entry",click:function(){return e.changeToEdit()},shouldBeHidden:function(){return!l},svgPath:"svg/icons-msft-teams.html"},d=n?this.sharePointFilePreviewService.canEditFileInDesktopApp(this.fileDetail.type)&&this.fileDetail.objectUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,this.fileDetail,{serviceName:this.serviceName}),h={id:"office-open-in-desktop-app",displayName:s.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!d},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},p=n?this.sharePointFilePreviewService.canEditFileInSharePoint(this.fileDetail.type)&&this.fileDetail.openInWindowFileUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,this.fileDetail,{serviceName:this.serviceName});this.openInNewTabMenuItem={id:"office-open-in-new-tab",displayName:s.openInNewTabText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!p},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"};var u=i?this.resources.strings.files_openButtonLabel:this.resources.strings.files_editButtonLabel;this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(u),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabel),dropdownButtonText:this.$translate.instant(this.resources.strings.files_moreEditOptionsButtonLabel),options:[c,h,this.openInNewTabMenuItem]}}this.titleBarMoreOptions=[{id:"download-office-document",displayName:this.$translate.instant(this.resources.strings.files_menuLabelDownload),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.Download,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.Download,e.fileDetail,{serviceName:e.serviceName,showActionMenuDownload:!0})},svgPath:"svg/icons-download.html"},{id:"open-office-document-in-sharepoint",displayName:this.filesActionService.textFor(teamspace.services.EntityActionType.OpenInSharePoint,{serviceName:this.serviceName}),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,null)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/"+this.filesActionService.iconFor(teamspace.services.EntityActionType.OpenInSharePoint,this.fileDetail,{serviceName:this.serviceName}).first+".html"},{id:"office-open-in-desktop-app",displayName:s.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,{serviceName:e.serviceName})||!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},{id:"office-open-in-new-tab",displayName:s.openInNewTabText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,{serviceName:e.serviceName})||!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"}],this.threadId&&(this.titleBarConversationInfo={threadId:this.threadId,objectId:this.fileDetail.objectId,serviceName:this.serviceName,objectUrl:this.fileDetail.objectUrl})}},e.prototype.getAccessibleIframeNotice=function(){if(this.openInNewTabMenuItem)return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?this.$translate.instant(this.resources.strings.files_accessible_iframe_notice):this.$translate.instant(this.resources.strings.files_inaccessible_iframe_notice)},e.prototype.openInNewTab=function(e){e.which===this.constants.keyCodes.enter&&e.target===e.currentTarget&&(this.openInNewTabMenuItem.click(),e.preventDefault(),this.analyticsService.onPanelAction(this.$scope,{action:{gesture:teamspace.components.PanelActionGesture.click,scenario:teamspace.components.PanelActionScenario.openFile,scenarioType:teamspace.components.PanelActionScenarioType.files},module:{name:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleName.documentStage.toString(),teamspace.components.PanelModuleName,this.loggingService).toString(),type:teamspace.components.PanelModuleType.viewer,summary:"Opening document from accessible iframe wrapper"},dataBag:{wacAccessibilityOpenOnline:!0}}))},e.prototype.changeToEdit=function(){var e=this;if(this.scenarioComplete||this.scenario.cancel({errorCode:"changeToEdit"}),this.scenarioComplete=!1,this.scenario=this.loggingService.newScenario(this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,null,function(){e.scenarioComplete=!0}),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName,viewerType:this.viewerType},this.$state.current.name==this.constants.states.appDocumentViewer){var t=this.routeUtilityService.getRootRouteParams();t.viewerAction=this.constants.files.fileActions.viewer.edit;var i={documentViewerParams:t,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(i,{location:"replace",notify:!1})}this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?(this.filesDocStageHelperService.sendPostMessage({eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:{MessageId:"Host_SwitchMode",SendTime:Date.now(),Values:{NewMode:"edit"}}}),this.displayTitleBar=!1,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)):this.wacUrl=this.fileDetail.wacUrlEdit,this.wacEdit=!0,this.utilityService.isEditableVisioFileExtension(this.fileType)&&this.fileDetail.openInWindowFileUrl.includes("action=view")&&(this.fileDetail.openInWindowFileUrl=this.fileDetail.openInWindowFileUrl.replace("action=view","action=edit"))},e.prototype.onFileLoadError=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),this.fileErrorCode=e&&(e.statusCode||e.errorCode||e.internalErrorCode||e.code)||this.constants.files.error.unknown;var s=_.get(e,"errorMessage.error");if(this.errorReasonForTelemetry=s&&s["error.errorMessage.error"],t||i){if(!e)return void this.scenario.fail({errorCode:"Unknown Error"});if(e.code===this.constants.errorCodes.networkOffline)return void this.scenario.incomplete({errorCode:e.code,errorMessage:e.message});var n=e.statusCode,r=e.message||e.errorMessage||e.internalErrorCode||this.errorReasonForTelemetry||this.fileErrorCode;if(!n)return void this.scenario.fail({errorCode:e.errorCode,errorMessage:r});if("number"!=typeof n){var o="type: "+typeof n+", status: "+n;return r=r?o+", message: "+r:o,void this.scenario.fail({errorCode:"Invalid status code type",errorMessage:r})}switch(n){case this.constants.responseCode.clientFailure:case this.constants.responseCode.badRequest:case this.constants.responseCode.internalServerError:case this.constants.responseCode.serviceUnavailable:case this.constants.responseCode.ok:this.scenario.fail({errorCode:n,errorMessage:r});break;default:this.scenario.incomplete({errorCode:n,errorMessage:r})}}else if(this.scenario.mark("scenario-stop-pending"),this.filesSharingHelper.shareLogInfo(this.constants.files.actionLogs.fileOpenError,this.fileId,this.fileErrorCode,this.errorReasonForTelemetry),this.scenario){var a={errorCode:e&&(e.errorCode||e.internalErrorCode),statusCode:e&&e.statusCode};this.sharepointScenarioHandler.getFilesScenario(a,this.constants.files.scenarioActions.getFiles).finishScenario(this.scenario)}},e.prototype.isNStarViewerType=function(){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email},e}();angular.module("teamspace.fileOfficeFrame",["teamspace.loggingService","teamspace.utilityService","teamspace.routeUtilityService","teamspace.filesUtilityService","teamspace.filesActionService","teamspace.filesEntityService","teamspace.filesRedeemService","teamspace.analyticsService","teamspace.platformDetectService","teamspace.authenticationService","teamspace.services.files.modules.sharePoint.sharePointFileDetailsRepository","teamspace.services.files.modules.sharePoint.sharePointFilePreviewService","teamspace.services.files.modules.scenarios.sharepointScenarioHandler","teamspace.services.files.modules.sharePoint.vroom.sharepointShareService","teamspace.navigationService","teamspace.filesDocStageHelperService","teamspace.services.files.modules.sharePoint.filesSharingHelper"]).component("fileOfficeFrame",{bindings:{serviceName:"<",fileType:"<",objectUrl:"<",baseUrl:"<",fileId:"<",threadId:"<?",onTitleBarClosed:"&?",scenarioName:"<",userClickTime:"<",shareUrl:"<",shareId:"<"},template:s,controller:n})},2160:function(e,t){e.exports='<div id="file-office-frame" class="flex-fill">\n\n  \x3c!-- busy animation --\x3e\n  <busy-animation size="medium" ng-if="!($ctrl.fileDetail || ($ctrl.useOneUp && $ctrl.oneUpParams && !$ctrl.wacEdit)) && !$ctrl.fileErrorCode && !$ctrl.useNStarViewerExpInMainWindow" context="file-office-frame">\n  </busy-animation>\n\n  <file-document-title-bar id="ts-file-document-title-bar" ng-show="$ctrl.displayTitleBar || $ctrl.fileErrorCode" is-edit-mode="$ctrl.wacEdit" edit-action="$ctrl.editAction" file-name="::$ctrl.fileName" file-type="::$ctrl.fileType" file-id="::$ctrl.fileId" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" is-enabled="true" primary-options="::$ctrl.titleBarPrimaryOptions" more-options="::$ctrl.titleBarMoreOptions" error="$ctrl.fileErrorCode" error-reason-for-telemetry="$ctrl.errorReasonForTelemetry" conversation-info="::$ctrl.titleBarConversationInfo">\n  </file-document-title-bar>\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" object-url="{{$ctrl.objectUrl}}" share-url="{{$ctrl.shareUrl}}">\n  </file-full-alert>\n\n  <div class="office-frame flex-fill" ng-if="!$ctrl.fileErrorCode">\n    <div tabindex="0" set-focus="true" id="file-office-frame-container" acc-role="tab-handler-document-viewer-frame" role="application" class="flex-fill office-viewer-container" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="::$ctrl.isPreProcessingComplete && !$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <file-office-viewer ng-if="$ctrl.fileDetail && ($ctrl.wacEdit || !$ctrl.useOneUp)" type="::$ctrl.fileDetail.type" scenario="$ctrl.scenario" wac-url-source="$ctrl.wacUrl" wac-edit="$ctrl.wacEdit" ctx="::$ctrl.ctx" file-type="::$ctrl.fileType" class="flex-fill">\n      </file-office-viewer>\n      <file-one-up-viewer ng-if="$ctrl.oneUpParams && !$ctrl.wacEdit" type="::$ctrl.oneUpParams.fileType" scenario="$ctrl.oneUpParams.scenario" site-url="$ctrl.oneUpParams.baseUrl" server-relative-url="$ctrl.oneUpParams.serverRelativeUrl" file-detail="::$ctrl.oneUpParams.fileDetail" object-url="::$ctrl.objectUrl" service-name="::$ctrl.oneUpParams.serviceName" drive-item="$ctrl.driveItem" file-id="::$ctrl.fileId" class="flex-fill">\n      </file-one-up-viewer>\n    </div>\n\n    <div tabindex="0" set-focus="true" id="file-office-frame-experience-container" class="flex-fill office-viewer-container" role="application" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <div id="ts-unified-app-loader" ng-if="$ctrl.showSpinner">\n        <busy-animation size="medium" context="file-unified-app-viewer">\n        </busy-animation>\n      </div>\n      \x3c!-- ng-show ensures that files experience is not visible till redeem call succeeds.--\x3e\n      <file-unified-app-viewer ng-show="::$ctrl.isPreProcessingComplete" is-edit-mode="$ctrl.wacEdit" file-type="::$ctrl.fileType" object-url="::$ctrl.objectUrl" user-click-time="::$ctrl.userClickTime" scenario="::$ctrl.scenario" ctx="::$ctrl.ctx" drive-item-call-start-time="::$ctrl.driveItemCallStartTime" class="flex-fill file-unified-app-viewer-container" redeem-promise="$ctrl.redeemPromise" hide-spinner="$ctrl.hideSpinner" display-title-bar="$ctrl.displayTitleBar" more-options="::$ctrl.titleBarMoreOptions" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" file-name="::$ctrl.fileName" thread-id="::$ctrl.threadId" service-name="::$ctrl.serviceName" file-id="::$ctrl.fileId">\n      </file-unified-app-viewer>\n    </div>\n  </div>\n</div>'},2161:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2162),n=function(){function e(e,t,i,s,n,r,o,a,l,c){var d=this;this.$scope=e,this.$sce=t,this.$window=i,this.$location=s,this.$timeout=n,this.constants=r,this.utilityService=a,this.filesUtilityService=c,this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isOneNote=r.fileExtensions.onenote.indexOf(this.type)>=0,this.isVisio=r.fileExtensions.visio.indexOf(this.type)>=0,this.isElectronApp=l.isElectron(),this.useHwaWebView=l.isHwa()&&o.valueAsBoolean(r.settings.names.enableMsWebViewFileOfficeViewer),this.useElectronWebView=this.isElectronApp;var h=i.electronSafeIpc;this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):h&&this.useElectronWebView?(h.send(r.events.desktopApp.allowWebViewCreate),h.once(r.events.desktopApp.webViewCreationEnabled,function(){d.init(),d._stopFullScreenScenario(),d.isWebViewCreationEnabled=!0})):(this.init(),this._registerScenarioEnd()),this._ensureInitialFocusIsNotStolen()}return e.$inject=["$scope","$sce","$window","$location","$timeout","constants","settingsService","utilityService","desktopUtilityService","filesUtilityService"],e.prototype.$onChanges=function(e){var t=this;if(e.wacUrlSource&&!e.wacUrlSource.isFirstChange()){var i=this.$window.electronSafeIpc;i&&this.useElectronWebView&&this.isWebViewCreationEnabled||this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):i&&this.useElectronWebView||(this.wacUrl=null,this.$timeout(function(){return t.init()},0,!1),this._registerScenarioEnd())}},e.prototype.init=function(){var e=this,t=this.wacUrlSource+"&hh=1",i=t.match(/sc=pmo[^&]*/g);t=t.replace(/sc=.*?&/g,""),this.wacEdit?t+="&sc=OwaEdit":i&&i.length&&(t=t+"&"+i[0]),t+="&uih=Teams";var s=this.filesUtilityService.isNStarViewerExpInMainWindowEnabled(this.fileType);t=this.ctx===this.constants.scenarios.files.newFileCreationContext&&s?t+"&uiEmbed=1":t;var n=this.utilityService.parseUrl(t);if(this.wacOrigin=n&&n.origin,this.wacUrl=this.$sce.trustAsResourceUrl(t),this.sourceElement=document.getElementsByClassName("wopi-iframe")[0],this.sourceElement){var r=this.layout.bind(this);this.sourceElement.addEventListener("dom-ready",r),this.$window.addEventListener("resize",r),this.$scope.$on("$destroy",function(){e.sourceElement.removeEventListener("dom-ready",r),e.$window.removeEventListener("resize",r)})}},e.prototype.layout=function(){if(this.sourceElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.sourceElement.clientWidth,t=this.sourceElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype._registerScenarioEnd=function(){var e=this,t=this.$location.host();if(!(!this.useElectronWebView&&(t.endsWith(this.constants.counters.skype.skypeDomain)||t.endsWith(this.constants.counters.microsoft.domain)))||this.isOneNote||this.isVisio||this.wacEdit)this._stopFullScreenScenario();else{var i=angular.element(this.$window);this._onPostMessageReceive&&(i.unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler()),this._onPostMessageReceive=function(t){return e._postMessageReceiveHandler(t)},i.on("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler=this.$scope.$on("$destroy",function(){i.unbind("message",e._onPostMessageReceive)})}},e.prototype._postMessageReceiveHandler=function(e){var t=e.originalEvent||e;if(t&&t.origin&&t.origin===this.wacOrigin){var i=JSON.parse(t.data||"{}");i.MessageId&&i.MessageId.toLowerCase()==="App_LoadingStatus".toLowerCase()&&(this._stopFullScreenScenario("wac"),angular.element(this.$window).unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler(),this._onPostMessageReceive=null)}},e.prototype._stopFullScreenScenario=function(e){void 0===e&&(e=""),this.scenario&&this.scenario.stop({context:e})},e.prototype._ensureInitialFocusIsNotStolen=function(){var e=this;this.focusCounter=0;var t=angular.element(this.$window);this._onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler()),this._onWindowBlur=function(t){return e._onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e._onWindowBlur)})},e.prototype._onWindowBlurHandler=function(e){var t=this;this.focusCounter++;var i=this.isOneNote?2:1;this.focusCounter==i&&(angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler(),this._onWindowBlur=null),this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOfficeViewer",["teamspace.settingsService","teamspace.filesUtilityService"]).component("fileOfficeViewer",{bindings:{type:"<",scenario:"<",wacEdit:"<",wacUrlSource:"<",ctx:"<",fileType:"<"},template:s,controller:n})},2162:function(e,t){e.exports='<div id="file-office-viewer" class="flex-fill">\n\n  <iframe ng-if="$ctrl.wacUrl && !($ctrl.useElectronWebView || $ctrl.useHwaWebView)" ng-src="{{$ctrl.wacUrl}}" ng-attr-sandbox="{{ ::$ctrl.isElectronApp ? \'allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts\' : undefined }}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </iframe>\n\n  <webview ng-if="::$ctrl.useElectronWebView && !$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true" webpreferences="nativeWindowOpen=yes" allowpopups="">\n  </webview>\n\n  \x3c!-- TODO tac: use embedded-page-container instead once it supports url updates --\x3e\n  <x-ms-webview ng-if="::$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </x-ms-webview>\n</div>\n'}},[2150]);
//# sourceMappingURL=https://statics.teams.cdn.office.net/hashedjs/lazy-ng1-mod-files-components.min.js-6ed3e245.map