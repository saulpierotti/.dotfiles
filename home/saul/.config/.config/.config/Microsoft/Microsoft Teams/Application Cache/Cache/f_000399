!function(e){"object"==typeof module&&module.exports?module.exports=e():window.vdiPeerConnection=e()}(function(e,t){"use strict";var i={NATIVE:0,CEF:1},n={VIDEO:"video",SCREENSHARE:"screenshare",APPSHARE:"appshare",HID:"hid"},o={createInstance:30,createInstanceResult:31,newVideoElement:32,removeVideoElement:33,updateVideoElement:34,version:40,enumDevices:41,enumVideoDevice:42,createPeerConnection:43,createOffer:44,createAnswer:45,setLocalDescription:46,setRemoteDescription:47,addIceCandidate:48,addStream:49,getLocalStreams:50,getStats:51,removeStream:52,close:53,getUserMediaShim:54,mediaTrkStop:55,trackEnabled:56,newAudioElement:57,setSinkId:58,updateSrcObject:59,notifyAudio:60,mediaStreamClone:61,mediaTrackClone:62,getDisplayMediaShim:63,setDefaultSinkId:64,shimLogToWebSocket:65,insertDTMF:66,getReceivers:67},r={ERROR:0,WARN:1,INFO:2,DEBUG:3},a={DISCONNECTED:0,PENDING:1,CONNECTED:2},s={DURATION:100,INTERTONEGAP:70},c={SSRC:0,CSRC:1},d="1.0.";d+="@"==="15541834"[0]?"00000":"15541834";var l=null,u={},h=-1,f=0,v=0,g={},m={},p={},b={},S={},y=window.RTCPeerConnection,k=window.navigator.webkitGetUserMedia,E=window.navigator.mediaDevices.getUserMedia,C=window.navigator.mediaDevices.enumerateDevices,_=window.navigator.mediaDevices.getDisplayMedia,w=i.CEF,O=null,M={},D={},I={},R={},T={},N=null,P=null,V=[],A={logLevel:r.DEBUG,websocketlogLevel:r.INFO,updateLogLevel:function(e,t){A.logLevel=e,A.websocketlogLevel=t},error:function(e){A.log("ERROR",e),P&&"function"==typeof P.error&&P.error(e)},warn:function(e){A.log("WARN",e),P&&"function"==typeof P.warn&&P.warn(e)},info:function(e){A.log("INFO",e),P&&"function"==typeof P.info&&P.info(e)},debug:function(e){A.log("DEBUG",e)},log:function(e,t){try{console&&r[e]<=A.logLevel&&("object"==typeof t?console.log(t):console.log(e+": "+t),"string"==typeof t&&r[e]<=A.websocketlogLevel&&N.sendLogToWebSocket(t,e))}catch(e){}}},j=function(e){setTimeout(e,0)},x=function(){var e=this,t={};this.id=++h,this._localStreams=[],this._remoteStreams=[],this._iceConnectionState="new",Object.defineProperty(this,"iceConnectionState",{get:function(){return A.debug("get iceConnectionState:"+this._iceConnectionState),this._iceConnectionState},configurable:!0}),this._iceGatheringState="new",Object.defineProperty(this,"iceGatheringState",{get:function(){return A.debug("get iceGatheringState:"+this._iceGatheringState),this._iceGatheringState},configurable:!0}),this._signalingState="stable",Object.defineProperty(this,"signalingState",{get:function(){return A.debug("get signalingState:"+this._signalingState),this._signalingState},configurable:!0}),this._connectionState="new",Object.defineProperty(this,"connectionState",{get:function(){return A.debug("get connectionState:"+this._connectionState),this._connectionState},configurable:!0}),this._localDescription=null,Object.defineProperty(this,"localDescription",{get:function(){return A.debug("get localDescription:"+this._localDescription),this._localDescription},configurable:!0}),this._remoteDescription=null,Object.defineProperty(this,"remoteDescription",{get:function(){return A.debug("get remoteDescription:"+this._remoteDescription),this._remoteDescription},configurable:!0}),this.cleanUp=function(){if("complete"!==this._iceGatheringState){t={type:"icecandidate",candidate:null,target:this};this.onicecandidate&&this.onicecandidate(t),this._iceGatheringState="complete";var e={type:"icegatheringstatechange",target:this};this.onicegatheringstatechange&&this.onicegatheringstatechange(e)}if("disconnected"!=this._iceConnectionState){this._iceConnectionState="failed";var t={type:"iceconnectionstatechange",target:this};this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t)}this._localStreams=[],this._remoteStreams=[]},this.createOffer=function(t,i,n){return new Promise(function(o,r){var a=new DOMException("createOffer cancelled","OperationError");N.send({cmd:"createOffer",options:n},e.id,function(e){void 0===e.error?(A.debug(e.desc),t(e.desc)):i(a)})})},this.createAnswer=function(t,i,n){return new Promise(function(o,r){var a=new DOMException("createAnswer cancelled","OperationError");N.send({cmd:"createAnswer",options:n},e.id,function(e){void 0===e.error?(A.debug(e.desc),t(e.desc)):i(a)})})},this.setRemoteDescription=function(t,i,n){return this._remoteDescription=t,new Promise(function(o,r){var a=new DOMException("setRemoteDescription cancelled","OperationError");N.send({cmd:"setRemoteDescription",desc:t},e.id,function(e){void 0===e.error?i():n(a)})})},this.setLocalDescription=function(t,i,n){return this._localDescription=t,new Promise(function(o,r){var a=new DOMException("setLocalDescription cancelled","OperationError");N.send({cmd:"setLocalDescription",desc:t},e.id,function(e){void 0===e.error?i():n(a)})})},this.addIceCandidate=function(t,i,n){return new Promise(function(o,r){var a=new DOMException("addIceCandidate cancelled","OperationError");N.send({cmd:"addIceCandidate",candidate:t},e.id,function(){void 0===evtObj.error?i():n(a)})})},this.createDTMFSender=function(t){if("audio"!==t.kind)return A.error("DTMF only could be associated with audio track."),null;var i=new U(e.id,t);return S[t.id]=i,i},this.getStats=function(t){return new Promise(function(i,n){new DOMException("getStats cancelled","InvalidAccessError");N.send({cmd:"getStats"},e.id,function(e){if("function"==typeof t)if(void 0===e.error&&void 0!==e.stats){var i=new L;i._create(e.stats),t(i)}else t({})})})},this.getLocalStreams=function(){return A.debug("getLocalStreams():"+this._localStreams.length),this._localStreams},this.getRemoteStreams=function(){return A.debug("getRemoteStreams():"+this._remoteStreams.length),this._remoteStreams},this.addStream=function(t){this._localStreams.push(t),N.send({cmd:"addStream",sid:t.id},e.id)},this.removeStream=function(t){A.debug("RTCPeerConnection.removeStream(): "+t.id);var i=this._localStreams.indexOf(t);-1!=i?this._localStreams.splice(i,1):A.error("RTCPeerConnection.removeStream(): Failed to find stream: "+t.id),N.send({cmd:"removeStream",sid:t.id},e.id)},this.close=function(){i=null,N.send({cmd:"close"},e.id,function(t){delete m[e.id]},!0)};var i=null,n=function(e){e&&e.forEach(function(e){if(e.id){var t=e.id;if("-"===e.op)delete i[t];else{"+"===e.op&&delete i[t];var n=i[t];n||(n=new G,i[t]=n),n.update(e)}}})};this.getReceivers=function(){i||(i={},N.send({cmd:"getReceivers"},e.id,function(e){},!0));var t=[];for(var n in i)i[n]&&t.push(i[n]);return t},this.getSenders=function(){A.debug("RTCPeerConnection.getSenders(): Not Implemented")},this.addEventListener=function(e,i){A.debug("RTCPeerConnection.addEventListener(): "+e),"function"==typeof i?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(i)):A.error("RTCPeerConnection.addEventListener(): The event name is invalid."):A.error("RTCPeerConnection.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,i){A.debug("RTCPeerConnection.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==i.toString()}):A.error("RTCPeerConnection.removeEventListener(): Event does not exist = "+e)},this._onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt){var t={type:e.evt,target:this};switch(e.details&&this._updateVars(e.details),e.evt){case"connectionstatechange":this.onconnectionstatechange&&this.onconnectionstatechange(t);break;case"negotiationneeded":this.onnegotiationneeded&&this.onnegotiationneeded(t);break;case"icecandidate":t.candidate=e.candidate,this.onicecandidate&&this.onicecandidate(t);break;case"icegatheringstatechange":this.onicegatheringstatechange&&this.onicegatheringstatechange(t);break;case"iceconnectionstatechange":this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t);break;case"signalingstatechange":this.onsignalingstatechange&&this.onsignalingstatechange(t);break;case"datachannel":t.channel=JSON.parse(JSON.stringify(evt.channel)),this.ondatachannel&&this.ondatachannel(t);break;case"addStream":if(void 0===e.stream){A.debug("_onReceiveEvent(): stream property is invalid.");break}t.stream=new F,t.stream._create(e.stream),this._remoteStreams.push(t.stream),this.onaddstream&&this.onaddstream(t);break;case"removeStream":if(void 0===e.stream){A.debug("_onReceiveEvent(): stream property is invalid.");break}if(t.stream=b[e.stream],void 0===t.stream){A.debug("_onReceiveEvent(): no stream found.");break}var i=this._remoteStreams.indexOf(t.stream);-1!=i&&this._remoteStreams.splice(i,1),this.onremovestream&&this.onremovestream(t);break;case"ontrack":if(t.streams=[],void 0===e.sid||void 0===b[e.sid]){A.debug("_onReceiveEvent(): ontrack, sid is invalid  or not found.");break}t.streams.push(b[e.sid]),this.ontrack&&this.ontrack(t);break;case"tonechange":var o=S[e.tid];if(void 0===o){A.debug("_onReceiveEvent(): tonechange, dtmfId is invalid  or not found.");break}o.ontonechange&&o.ontonechange(e);break;case"onreceivers":n(e.receivers)}}else A.error("_onReceiveEvent(): evt property is invalid.")},this._updateVars=function(e){e.iceConnectionState&&(this._iceConnectionState=e.iceConnectionState),e.iceGatheringState&&(this._iceGatheringState=e.iceGatheringState),e.signalingState&&(this._signalingState=e.signalingState),e.connectionState&&(this._connectionState=e.connectionState),e.localDescription&&(this._localDescription=e.localDescription),e.remoteDescription&&(this._remoteDescription=e.remoteDescription)}},F=function(){var e=0,t={};this.id="",this.active=!1,this.ended=!1,this.cloned=null,this.track=[],this._create=function(e){var t=this;this.id=e.id,this.active=e.active,this.track=[],e.track.forEach(function(e){var i=new W;i._create(e),t.track.push(i)}),b[this.id]=this},this.dispatchEvent=function(e){A.debug("MediaStream.dispatchEvent(): "+e.type),void 0!==t[event.type]&&t[event.type].listeners.forEach(function(t){t(e)}),"active"===e.type?this.onactive&&this.onactive(e):"addtrack"===e.type?this.onaddtrack&&this.onaddtrack(e):"inactive"===e.type?this.oninactive&&this.oninactive(e):"removetrack"===e.type?this.onremovetrack&&this.onremovetrack(e):A.debug("MediaStream.dispatchEvent(): Undefined event: ",e.type)},this.addEventListener=function(e,i){A.debug("MediaStream.addEventListener(): "+e),"function"==typeof i?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(i)):A.error("MediaStream.addEventListener(): The event name is invalid."):A.error("MediaStream.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,i){A.debug("MediaStream.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==i.toString()}):A.error("MediaStream.removeEventListener(): Event does not exist = "+e)},this.addTrack=function(e){A.debug("MediaStream.addTrack(): "+e.id);var t=!1;this.track.forEach(function(i){i.id==e.id&&(t=!0)}),t||this.track.push(e)},this.removeTrack=function(e){A.debug("MediaStream.removeTrack(): "+e.id);for(var t=0;t<this.track.length;t++)if(this.track[t].id==e.id)return void this.track.splice(t,1)},this.getTracks=function(){return A.debug("MediaStream.getTracks(): "+this.track.length),A.debug(this.track),this.track},this.getAudioTracks=function(){var e=[];return this.track.forEach(function(t){"audio"==t.kind&&e.push(t)}),A.debug("MediaStream.getAudioTracks(): Audio tracks = "+e.length),e},this.getVideoTracks=function(){var e=[];return this.track.forEach(function(t){"video"==t.kind&&e.push(t)}),A.debug("MediaStream.getVideoTracks(): Video tracks = "+e.length),e},this.getTrackById=function(e){var t=null;return A.debug("MediaStream.getTrackById(): "+e),this.track.forEach(function(i){i.id==e&&(t=i)}),t},this.clone=function(){if(A.debug("MediaStream.clone(): Clone mediaStream = "+this.id),this.cloned)return A.debug("MediaStream.clone(): Use cached clone: "+this.cloned.id),this.cloned;var t=this.id+"StreamCln#"+ ++e,i=new F,n=[];i._create({id:t,active:this.active,track:[]});for(var o=0;o<this.track.length;o++){var r=this.track[o]._internalClone();i.track.push(r),n.push({tid:this.track[o].id,cid:r.id})}return N.send({cmd:"mediaStreamClone",sid:this.id,cid:i.id,trackClones:n},-1),A.debug("MediaStream.clone(): MediaStream cloned = "+i.id+" from = "+this.id),i}},W=function(){var e=0,t={};this.remote=!1,this.readonly=!1,this.contentHint="",this.id="",this.kind="",this.label="",this.muted=!1,this.readyState="",this._enabled=!1,Object.defineProperty(this,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e,N.send({cmd:"trackEnabled",trackId:this.id,enabled:e},-1)},configurable:!0}),this._create=function(e){this._update(e),p[this.id]=this},this._update=function(e){e&&(this.contentHint=e.contentHint,this.id=e.id,this.kind=e.kind,this.label=e.label,this._enabled=e.enabled,this.muted=e.muted,this.readyState=e.readyState,this.remote=e.remote,this.readonly=e.readonly,this.settings=e.settings)},this.dispatchEvent=function(e){"started"==e.type?this.onstarted&&this.onstarted(e):"ended"==e.type?this.onended&&this.onended(e):"isolationchange"==e.type?this.onisolationchange&&this.onisolationchange(e):"mute"==e.type?this.onmute&&this.onmute(e):"unmute"==e.type?this.onunmute&&this.onunmute(e):"overconstrained"==e.type?this.onoverconstrained&&this.onoverconstrained(e):A.debug("Undefined media track evt: ",e.type)},this.addEventListener=function(e,i){A.debug("MediaStreamTrack.addEventListener(): "+e),"function"==typeof i?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(i)):A.error("MediaStreamTrack.addEventListener(): The event name is invalid."):A.error("MediaStreamTrack.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,i){A.debug("MediaStreamTrack.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==i.toString()}):A.error("MediaStreamTrack.removeEventListener(): Event does not exist = "+e)},this.applyConstraints=function(e){A.debug("MediaStreamTrack.applyConstraints(): Not implemented.")},this.getConstraints=function(){A.debug("MediaStreamTrack.getConstraints(): Not implemented")},this.getCapabilities=function(){A.debug("MediaStreamTrack.getCapabilities(): Not implemented")},this.getSettings=function(){return A.debug("MediaStreamTrack.getSettings(): "+JSON.stringify(this.settings)),this.settings},this.stop=function(){N.send({cmd:"mediaTrkStop",trkid:this.id})},this._internalClone=function(){var t=this.id+"TrackCln#"+ ++e,i=new W;return i._create({id:t,kind:this.kind,label:this.label,enabled:this.enabled,muted:this.muted,readyState:this.readyState,remoate:this.remote,readonly:this.readonly,settings:this.settings}),i},this.clone=function(){var e=this._internalClone();return N.send({cmd:"mediaTrackClone",tid:this.id,cid:e.id},-1),e}},L=function(){this.reports=[],this.result=function(){return this.reports},this._create=function(e){var t=this;e.forEach(function(e){var i=new H;i._create(e),t.reports.push(i)})}},H=function(){this.stats={},this._create=function(e){this.stats=e,this.type=e.type,this.id=e.id,this.timestamp=e.timestamp,delete this.stats.type,delete this.stats.id,delete this.stats.timestamp},this.names=function(){return Object.keys(this.stats)},this.stat=function(e){return this.stats[e]}},U=function(e,t){this.peerId=e,this.track=t,this._toneBuffer="",this.canInsertDTMF=!0,Object.defineProperty(this,"toneBuffer",{get:function(){return A.debug("get DTMF tone buffer"+this._toneBuffer),this._toneBuffer},set:function(e){A.debug("set DTMF tone buffer"+e),this._toneBuffer=e},configurable:!0}),this.insertDTMF=function(e,i,n){A.debug("insertDTMF audio tones: "+e),void 0===i&&(A.debug("Duration is not set, use default"),i=s.DURATION),void 0===n&&(A.debug("Gap is not set, use default"),n=s.INTERTONEGAP),N.send({cmd:"insertDTMF",tid:t.id,tones:e,duration:i,gap:n},this.peerId)}},G=function(){var e={},t={},i=function(i){i&&("+"===i.op&&(e=null,t={}),i.track&&(e?Object.keys(i.track).forEach(function(t){e[t]=i[t]}):(e=new W)._update(i.track)),i.sources&&i.sources.forEach(function(e){var i=e.source;if("-"===e.op)delete t[i];else{"+"===e.op&&(delete t[i],t[i]={});var n=t[i];Object.keys(e).forEach(function(t){n[t]=e[t]})}}))},n=function(e){var i=[];for(var n in t){var o=t[n];o.type&&o.type===e&&i.push(o)}return i};this.update=function(e){i(e)},Object.defineProperty(this,"track",{get:function(){return e},configurable:!0}),this.getContributingSources=function(){return n(c.CSRC)},this.getSynchronizationSources=function(){return n(c.SSRC)}},z=function(e){var t=this;this._srcObject=e.srcObject,this._id=v++,this._rawAudio=e,this.sendAudioElement=function(){var t={cmd:"newAudioElement",audioId:this._id};e.setAttribute("data-vdi_audioid",this._id),N.send(t,-1)},Object.defineProperty(e,"srcObject",{get:function(){return t._srcObject},set:function(e){A.debug("Setting srcObject for audio element: "+t._id),A.debug(e),t._srcObject=e,t.sendSrcObject()},configurable:!0}),this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";N.send({cmd:"updateSrcObject",mediaStreamId:e,audioId:this._id,type:"audio"},-1)},Object.defineProperty(e,"sinkId",{get:function(){return t._sinkId},set:function(e){},configurable:!0}),e.setSinkId=function(e){return t._sinkId=e,A.debug("Audio.setSinkId for ID = "+t._id+" Value = "+e),new Promise(function(i,n){N.send({cmd:"setSinkId",deviceId:e,audioId:t._id,context:"audioElement"},-1)})},this.init=function(){this.sendAudioElement(),this._srcObject&&(A.debug("srcObject already set for audio: "+this._id),this.sendSrcObject()),A.debug(e)},this.init()},B=function(e){var t=this;this._srcObject=e.srcObject,this._videoWidth=e.videoWidth,this._videoHeight=e.videoHeight,this._cloaked=!1,this._id=f++,this._clientRect=null,this._bodyClientRect=null,this._colorKey=null,this._rawVideo=e,this._removeTimer=null,this._removed=!1;var i=function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},n=function(){for(var e="";""==e;){var t=Math.floor(16*Math.random())+1,n=Math.floor(16*Math.random())+1,o=Math.floor(16*Math.random())+1;e="#"+i(t)+i(n)+i(o);var r=Object.keys(M);for(var a in r){var s=M[r[a]];if(s&&s._colorKey==e){e="";break}}}return e};this.sendVideoElement=function(){this._colorKey=n();var t={cmd:"newVideoElement",videoId:this._id,colorKey:this._colorKey,body:{}};for(var i in this._clientRect)t[i]=this._clientRect[i];for(var i in this._bodyClientRect)t.body[i]=this._bodyClientRect[i];e.setAttribute("data-vdi_videoid",this._id),N.send(t,-1)},this.updateVideoElement=function(){var t=this.getBoundingClientRect(e),i=this.getBoundingClientRect(document.body);if(t.left==this._clientRect.left&&t.right==this._clientRect.right&&t.top==this._clientRect.top&&t.bottom==this._clientRect.bottom&&i.left==this._bodyClientRect.left&&i.right==this._bodyClientRect.right&&i.top==this._bodyClientRect.top&&i.bottom==this._bodyClientRect.bottom)return!1;this._clientRect=t,this._bodyClientRect=i;var n={cmd:"updateVideoElement",videoId:this._id,body:{}};for(var o in t)n[o]=t[o];for(var o in i)n.body[o]=i[o];A.debug(n),N.send(n,-1)},this.removeVideoElement=function(){var e={cmd:"removeVideoElement",videoId:t._id};A.debug("RemoveVideoElement: "+t._id),N.send(e,-1),delete M[t._id],t._removeTimer=null,t._removed=!0},this.cloak=function(){!0!==this._cloaked&&(this._colorKey?(e.style.backgroundColor=this._colorKey,this._poll=setInterval(function(){t.updateVideoElement()},500),this._cloaked=!0):A.error("cloak(): Invalid color key."))},this.uncloak=function(){if(!1===this._cloaked)return!1;e.style.backgroundColor="",clearInterval(this._poll),this._cloaked=!1},this.getBoundingClientRect=function(e,t){var i=e.getBoundingClientRect(),n=1;return"number"==typeof window.devicePixelRatio&&(n=window.devicePixelRatio),t&&t.left&&t.top?{left:i.left*n+t.left,top:i.top*n+t.top,bottom:i.bottom*n+t.top,right:i.right*n+t.left,width:i.width*n,height:i.height*n}:{left:i.left*n,top:i.top*n,bottom:i.bottom*n,right:i.right*n,width:i.width*n,height:i.height*n}},this.onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt)if(this._rawVideo){if("loadedmetadata"===e.evt){void 0!==e.videoWidth&&(this._videoWidth=e.videoWidth),void 0!==e.videoHeight&&(this._videoHeight=e.videoWidth);var t=new Event(e.evt);this._rawVideo.dispatchEvent(t)}}else A.error("onReceiveEvent(): Invalid rawVideo object.");else A.error("onReceiveEvent(): evt property is invalid.")},this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";N.send({cmd:"updateSrcObject",mediaStreamId:e,videoId:this._id,type:"video"},-1),this._srcObject?this.cloak():this.uncloak()},Object.defineProperty(e,"srcObject",{get:function(){return t._srcObject},set:function(e){t._removed?A.warn("Setting srcObject of zombie video element: "+t._id):(t._removeTimer&&(clearTimeout(t._removeTimer),t._removeTimer=null),A.debug("Setting srcObject for video element: "+t._id),A.debug(e),t._srcObject=e,t.sendSrcObject(),t._srcObject||(A.debug("srcObject is null, setup removeTimer for "+t._id),t._removeTimer=setTimeout(t.removeVideoElement,5e3)))},configurable:!0}),Object.defineProperty(e,"videoWidth",{get:function(){return t._videoWidth},configurable:!0}),Object.defineProperty(e,"videoHeight",{get:function(){return t._videoHeight},configurable:!0}),this.init=function(){this._clientRect=this.getBoundingClientRect(e),this._bodyClientRect=this.getBoundingClientRect(document.body),this.sendVideoElement(),this._srcObject&&(A.debug("srcObject already set for video: "+this._id),this.sendSrcObject()),A.debug(e)},this.init()},J=function(e){"function"==typeof O?(A.info("onVMEvent(): Fire event = "+JSON.stringify(e)),O(e)):A.warn("onVMEvent(): setVMEventCallback is not called yet.")},q=function(){var e=this,t=null,i=a.DISCONNECTED,n={},s=0,c=null,l=!1;Object.defineProperty(this,"state",{get:function(){return i},configurable:!0}),Object.defineProperty(this,"shortPollingIntervalMs",{get:function(){return 1e3}}),Object.defineProperty(this,"shortPollingTimeout",{get:function(){return 1e4}}),Object.defineProperty(this,"longPollingIntervalMs",{get:function(){return 5e3}}),Object.defineProperty(this,"isHorizonRegistryPresent",{get:function(){return l},set:function(e){l=e},configurable:!0}),this.sendLogToWebSocket=function(e,t){return"string"==typeof e&&0!==e.length&&(i===a.CONNECTED&&(g({cmd:"shimLogToWebSocket",message:e,level:t},-1),!0))},this.isFallbackMode=function(){return i!==a.CONNECTED},this.init=function(){A.info("RequestManager.init(): Initializing Request Manager."),this.startPolling(1e3,1e4,this.sendEvents)},this.startPolling=function(t,n,o){if(c)A.info("RequestManager.startPolling(): Polling timer already initialized");else if(i===a.DISCONNECTED){var r=n;A.info("intervalMs "+t+" timeout "+n),c=setInterval(function(){e.connectToHorizon(),void 0!==r&&(r-=t,l||e.queryHorizonRegistry()),void 0!==r&&r<=0&&(e.stopPolling(),o&&!0===l&&o())},t)}else A.info("RequestManager.startPolling(): Socket state not disconnected, exiting")},this.stopPolling=function(){null!==c&&(clearInterval(c),c=null,A.info("Stopped polling websocket"))},this.sendEvents=function(){var e={event:"vdiClientConnected",version:"shimVersion = "+d};try{J(e)}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}try{J({event:"vdiClientDisconnected",reason:"endpointUnsupported"})}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}N.startPolling(5e3)},this.queryHorizonRegistry=function(){window.getVMWareViewClientID().then(function(e){A.info("queryHorizonRegistry(): Horizon Client ID "+e),e&&N&&(N.isHorizonRegistryPresent=!0,A.info("queryHorizonRegistry(): isHorizonRegistryPresent true"))},function(){return A.error("queryHorizonRegistry(): Failed to query Horizon Client ID"),!1})},this.connectToHorizon=function(){i===a.DISCONNECTED&&window.getVMWareSecureWebPort().then(function(e){if("string"!=typeof e||0===e.length)return A.error("connectToHorizon(): Port is not valid"),void y("VMware HTML5 Server port not valid");i=a.PENDING,(t=new WebSocket("wss://view-localhost:"+e+"/")).binaryType="arraybuffer",t.onopen=u,t.onclose=h,t.onerror=f,t.onmessage=v},function(){A.error("connectToHorizon(): Failed to receive port number"),y("Failed to receive port number")})};var u=function(){A.info("onWebSocketOpen(): Websocket opened"),N.stopPolling(),g({cmd:"createInstance",hwnd:R.hwnd,shimVersion:d,shimMinAgentVersion:1},-1,function(t){if(i!=a.DISCONNECTED){t.uid&&A.info("onWebSocketOpen(): ["+t.uid+"] createInstanceDone"),"true"===t.traceEnabled&&A.updateLogLevel(r.DEBUG,r.DEBUG);for(var n={agentOsVersion:"Horizon Agent OS version",clientOsVersion:"Horizon Client OS version",haVersion:"Horizon Agent Version",hcVersion:"Horizon Client Version",shimVersion:"Shim Version",webrtcClientVer:"Client WebRTC Version",webRTCRedirAgentVersion:"WebRTC Redirection Agent Version",webRTCRedirClientVersion:"WebRTC Redirection Client Version"},o="",s=Object.keys(n),c=0;c<s.length;c++)t[s[c]]?(o+=n[s[c]]+" = "+t[s[c]],A.debug("onWebSocketOpen(): "+n[s[c]]+" = "+t[s[c]]),c!=s.length-1&&(o+="; ")):A.warn("onWebSocketOpen(): Could not find property "+n[s[c]]);var d={event:"vdiClientConnected",version:o};if(t.hcId&&(d.endpointId=t.hcId,A.debug("onWebSocketOpen(): ClientId = "+t.hcId)),"true"===t.allow){i=a.CONNECTED,Array.isArray(t.featuresSupported)?(V=t.featuresSupported,A.info("onWebSocketOpen(): Supported features = "+JSON.stringify(V))):A.warn("onWebSocketOpen(): featureSupported property not valid");try{J(d)}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}else{try{J(d)}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}for(var l="",s=["errorCode","errorMsg"],c=0;c<s.length;c++)void 0!==t[s[c]]?(A.debug("onWebSocketOpen(): "+s[c]+": "+t[s[c]]),l+=s[c]+" = "+t[s[c]],c!=s.length-1&&(l+="; ")):A.warn("onWebSocketOpen(): Could not find property "+s[c]);try{J({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:l})}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}y("VMware HTML5 Server connection not allowed",!0)}}})},h=function(){A.info("onWebSocketClose(): Websocket closed"),N&&(N.isHorizonRegistryPresent=!1,N.stopPolling()),y("VMware HTML5 Server connection closed")},f=function(e){A.info("onWebSocketError(): Websocket error"),y("VMware HTML5 Server connection error: "+e.message)},v=function(e){var t=e.data,i=JSON.parse(t);if(console.log("onWebSocketMessage(): "+t),"number"==typeof i.id&&i.id>0){var o=n[i.id];return delete n[i.id],void("function"==typeof o.responseCb&&o.responseCb(i))}if(void 0!==i.evt)switch(i.evt){case"version":if(void 0===i.ver){A.error("onWebSocketMessage(): ver property is invalid.");break}A.info("onWebSocketMessage(): version = "+i.ver);break;case"negotiationneeded":case"icecandidate":case"icegatheringstatechange":case"iceconnectionstatechange":case"signalingstatechange":case"addStream":case"tonechange":case"onreceivers":case"removeStream":void 0!==i.peer&&void 0!==m[i.peer]?m[i.peer]._onReceiveEvent(i):A.error("onWebSocketMessage(): peerConnection is invalid.");break;case"loadedmetadata":void 0!==i.videoId&&void 0!==M[i.videoId]?M[i.videoId].onReceiveEvent(i):A.error("onReceiveCommand(): Invalid context.");break;case"devicechange":var r=new Event("devicechange");navigator.mediaDevices.dispatchEvent(r)}else A.error("onWebSocketMessage(): evt property is invalid")},g=function(e,r,c,d){if(r=void 0==r?-1:r,void 0!==e)if(-1===r||m[r])e.feature=3,e.commandId=o[e.cmd],e.id=++s,e.peer=r,e.browser="electron",e.player=w,"createInstance"===e.cmd&&(e.uid=Date.now(),A.info("sendHelper(): ["+e.uid+"] createInstance")),"createInstance"!==e.cmd&&i!==a.CONNECTED||(c&&(d?c():n[e.id]={id:e.id,webCommandId:e.commandId,responseCb:c}),t.send(JSON.stringify(e)));else{l=new DOMException("peer Id is not found, operation cancelled","OperationError");c?c({error:l}):A.error(l)}else{var l=new DOMException("Invalid command, operation cancelled","OperationError");c?c({error:l}):A.error(l)}};this.send=function(e,t,i,n){"getStats"!=e.cmd&&A.debug(JSON.stringify(e)),g(e,t,i,n)},this.invokeDeviceChange=function(){j(function(){A.info("invokeDeviceChange(): Fire devicechange event");var e=new Event("devicechange");navigator.mediaDevices.dispatchEvent(e)})},this.sendBinary=function(e){i===a.CONNECTED?t.send(e):A.warn("sendBinary(): WSS is not connected.")};var S=function(){var e="v=0\n",t=Math.random()*Number.MAX_SAFE_INTEGER;return t=Math.floor(t),e=e+"o=- "+String(t)+" 2 IP4 127.0.0.1\n",e+="s=-\n",e+="t= 0 0\n",e+="a=msid-semantic: WMS"},y=function(r,s){var c=i;if(i=s?a.PENDING:a.DISCONNECTED,Object.keys(n).forEach(function(e){var t=new DOMException(r,"OperationError");if(n[e].responseCb)if(n[e].webCommandId===o.createOffer||n[e].webCommandId===o.createAnswer){var i={desc:{sdp:S()}};A.info("Resolving createoffer/createAnswer with desc "+i.desc),n[e].responseCb(i)}else n[e].responseCb({error:t});else A.error(t)}),n={},t&&t.readyState===WebSocket.OPEN&&i==a.DISCONNECTED&&t.close(),t=null,Object.keys(m).forEach(function(e){m[e].cleanUp()}),m={},p={},b={},V=[],c===a.CONNECTED){try{J({event:"vdiClientDisconnected",reason:"endpointDisconnected"})}catch(e){A.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}}},K=function(e,t){l.loop=t,l.src=e,l.play().then(function(){A.info("playFallBackRing() Playing Ringtone: "+e)}).catch(function(e){A.warn("Catch exception in playFallBackRing(): "+e.message)})},X={createPeerConnection:function(e,t){if(N.isFallbackMode())return A.info("createPeerConnection(): Use fallback mode."),new y(e,t);var i=new x(e,t);return m[i.id]=i,N.send({cmd:"createPeerConnection",arg1:e,arg2:t},i.id),A.debug("createPeerConnection(): Create peer: "+i.id),i},getDisplayMediaShim:function(e){return N.isFallbackMode()?(A.info("createPeerConnection(): Use fallback mode."),new Promise(function(t,i){_.call(navigator.mediaDevices,e).then(function(e){N.isFallbackMode()?t(e):(A.info("getDisplayMediaShim(): Success fallback cancelled."),i(new DOMException("getDisplayMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())}.catch(function(e){N.isFallbackMode()?i(e):(A.info("getDisplayMediaShim(): Error fallback cancelled."),i(new DOMException("getDisplayMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())}))})):new Promise(function(t,i){A.debug("getDisplayMediaShim(): Constraints = "+JSON.stringify(e)),N.send({cmd:"getDisplayMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var n=new F;n._create(e.stream),A.debug("getDisplayMediaShim(): Media ="+n.id),t(n)}else i(e.error)})})},mediaDevicesGetUserMediaShim:function(e){return N.isFallbackMode()?(A.info("mediaDevicesGetUserMediaShim(): Use fallback mode."),new Promise(function(t,i){E(navigator.mediaDevices,e).then(function(e){N.isFallbackMode()?t(e):(A.info("mediaDevicesGetUserMediaShim(): Success fallback cancelled."),i(new DOMException("mediaDevicesGetUserMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())}).catch(function(e){N.isFallbackMode()?i(e):(A.info("mediaDevicesGetUserMediaShim(): Error fallback cancelled."),i(new DOMException("mediaDevicesGetUserMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())})})):new Promise(function(t,i){X.getUserMediaShim(e,t,i)})},getUserMediaShim:function(e,t,i){if(A.debug("Constraints: "+JSON.stringify(e)),N.isFallbackMode())return A.info("getUserMediaShim(): Use fallback mode."),k.call(navigator,e,function(e){N.isFallbackMode()?t(e):(A.info("getUserMediaShim(): Success fallback cancelled."),i(new DOMException("getUserMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())},function(e){N.isFallbackMode()?i(e):(A.info("getUserMediaShim(): Error fallback cancelled."),i(new DOMException("getUserMediaShim fallback cancelled","OperationError")),N.invokeDeviceChange())});if(void 0!==e.video&&void 0!==e.video.mandatory&&void 0!==e.video.mandatory.sourceId&&void 0!==T[e.video.mandatory.sourceId]){var n=0,o=0,r=0,a=!1,s=e.video.mandatory.sourceId,c=e.video.mandatory.minWidth,d=e.video.mandatory.maxWidth,l=e.video.mandatory.minHeight,u=e.video.mandatory.maxHeight,h=e.video.mandatory.maxFrameRate;if(T[s].forEach(function(e){(void 0===c||e.width>=c)&&(void 0===d||e.width<=d)&&(void 0===l||e.height>=l)&&(void 0===u||e.height<=u)&&(void 0===h||e.fps>=h)?(n<e.width&&(n=e.width),o<e.height&&(o=e.height),r<e.fps&&(r=e.fps)):(void 0!==c&&e.width>=c||void 0!==d&&e.width>=d)&&(a=!0)}),n>0&&o>0&&r>0)A.debug("Constraints: "+JSON.stringify(e)+" ==> "+n+"x"+o+" @"+r),e.video.mandatory.maxFrameRate=r,e.video.mandatory.maxWidth=e.video.mandatory.minWidth=n,e.video.mandatory.maxHeight=e.video.mandatory.minHeight=o;else{if(!a)return A.debug("getUserMediaShim(): constraints does not match."),void i({name:"OverconstrainedError",message:null});A.debug("getUserMediaShim(): low resolution video forward to client.")}}N.send({cmd:"getUserMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var n=null;void 0!==e.clone&&((n=new F)._create(e.clone),A.debug("Media cloned:"+n.id));var o=new F;o._create(e.stream),o.cloned=n,A.debug("Media:"+o.id),t(o)}else{new DOMException("Abort","AbortError");i(e.error)}})},init:function(e){P=e,A.info("init(): VMware VDI shim version = "+d),window.getWindowHandleAsHex().then(function(e){A.info("init(): HWND: "+e),R.hwnd=e,(N=new q).init()},function(e){A.error("init(): Failed to retrieve window handle: "+e.message)})},connectedStateChanged:function(e){A.info("connectedStateChanged called "+e),N&&(!0===e?N.startPolling(N.shortPollingIntervalMs,N.shortPollingTimeout,N.sendEvents):(N.isHorizonRegistryPresent=!1,A.info("queryHorizonRegistry(): isHorizonRegistryPresent false"),N.stopPolling()))},enumerateDevicesShim:function(){return N.isFallbackMode()?(A.info("enumerateDevicesShim(): Use fallback mode."),new Promise(function(e,t){C.call(navigator.mediaDevices).then(function(t){e(t),N.isFallbackMode()||(A.info("enumerateDevicesShim(): [Resolve] Fallback cancelled. Invoke device change."),N.invokeDeviceChange())},function(i){N.isFallbackMode()?t(i):(A.info("enumerateDevicesShim(): [Reject] Fallback cancelled. Invoke device change."),e([]),N.invokeDeviceChange())})})):new Promise(function(e,t){N.send({cmd:"enumDevices"},-1,function(i){void 0===i.error?(e(i.devices),void 0!==i.caps&&Object.keys(i.caps).forEach(function(e){T[e]=i.caps[e]})):t("enumDevices cancelled.")})})},newVideoElement:function(e){if(N.isFallbackMode())A.info("newVideoElement(): Use fallback mode.");else{A.debug("newVideoElement: New video element from teams.");for(var t=Object.keys(M),i=0;i<t.length;i++){var n=t[i];if(M[n]._rawVideo===e)return void A.debug("newVideoElement(): Video already found")}var o=new B(e);M[o._id]=o,e._context=o}},newAudioElement:function(e){if(N.isFallbackMode())A.info("newAudioElement(): Use fallback mode.");else{A.debug("newAudioElement(): A new audio element created.");for(var t=Object.keys(D),i=0;i<t.length;i++){var n=t[i];if(D[n]._rawAudio===e)return void A.debug("newAudioElement(): Audio already found")}var o=new z(e);D[o._id]=o,e._context=o}},setVMEventCallback:function(e){return"function"!=typeof e?(A.error("setVMEventCallback(): The event callback function is not valid."),!1):(A.info("setVMEventCallback(): Set event callback"),O=e,!0)},playNotifyAudio:function(e,t){o=!0===I[e];if(A.info("playNotifyAudio(): id = "+e+" src = "+t+" loop = "+o),t.startsWith("file:")&&(t="https://teams.microsoft.com/assets/audio"+t.substring(t.lastIndexOf("/")),A.info("playNotifyAudio(): src map to :"+t)),N.isFallbackMode())if(A.info("playNotifyAudio(): Use fallback mode."),null===l&&(l=new Audio),l.paused){var i=u[e];if(void 0===i)return void A.warn("playNotifyAudio() sink Id no set");l.sinkId!=i?l.setSinkId(i).then(function(){A.info("playNotifyAudio() Sink Id set to: "+i),K(t,o)}).catch(function(e){A.warn("Catch exception in playNotifyAudio(), call to setSinkId(): "+e.message)}):K(t,o)}else A.info("playNotifyAudio(): FallbackRinger is already Playing.");else{var n=g[e];void 0===n&&(n=v++,g[e]=n);var o=!0===I[e];A.debug("playNotifyAudio(): id = "+e+" src = "+t+" loop = "+o),t.startsWith("file:")&&(t="https://teams.microsoft.com/assets/audio"+t.substring(t.lastIndexOf("/")),A.debug("playNotifyAudio(): src map to :"+t)),N.send({cmd:"notifyAudio",action:"play",src:t,audid:n,loop:o},-1);var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(){if(r.readyState==XMLHttpRequest.DONE&&200==r.status){var e=16+r.response.byteLength,i=new Uint8Array(16);i[0]=65,i[1]=78,i[2]=84,i[3]=70,i[4]=e>>24&255,i[5]=e>>16&255,i[6]=e>>8&255,i[7]=255&e,i[8]=n>>24&255,i[9]=n>>16&255,i[10]=n>>8&255,i[11]=255&n;var o=new Uint8Array(e),a=new Uint8Array(r.response);o.set(i,0),o.set(a,16),N.sendBinary(o),A.debug("onreadystatechange(): Send "+e+"bytes")}else A.debug("onreadystatechange(): Download "+t+" status = "+r.status)},r.send()}},setLoop:function(e,t){A.debug(e+".loop = "+t),I[e]=t},pauseNotifyAudio:function(e){if(N.isFallbackMode())return A.info("pauseNotifyAudio(): Use fallback mode."),void(l.paused||l.pause());A.debug("pauseNotifyAudio(): id = "+e);var t=g[e];void 0===t?A.warn("pauseNotifyAudio(): id = "+e+" did not play yet."):N.send({cmd:"notifyAudio",action:"pause",audid:t},-1)},addClipRect:function(e){},removeClipRect:function(e){},setSinkId:function(e,t){if(N.isFallbackMode())return A.info("setSinkId(): Use fallback mode."),void(u[e]=t);var i=g[e];void 0===i&&(i=v++,g[e]=i),A.debug("setSinkId id = "+i+" srcId = "+e+" Value = "+t),N.send({cmd:"setSinkId",deviceId:t,audioId:i,srcId:e,context:"global"},-1)},setDefaultSinkId:function(e){A.debug("setDefaultSinkId = "+e),N.send({cmd:"setDefaultSinkId",deviceId:e},-1)},isFeatureSupported:function(e){if("string"!=typeof e)return A.error("isFeatureSupported(): Invalid feature parameter"),!1;if(-1==Object.values(n).indexOf(e))return A.error("isFeatureSupported(): Input feature string not supported = "+e),!1;if(!N||N.state!==a.CONNECTED)return!1;var t=!1;return Array.isArray(V)&&-1!=V.indexOf(e)&&(t=!0),t}};return X});
//# sourceMappingURL=https://statics.teams.cdn.office.net/hashedjs/vdiVMwarePeerConnectionTest.js-66c588cb.map