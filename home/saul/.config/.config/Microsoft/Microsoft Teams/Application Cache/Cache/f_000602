var msRDCRTC;!function(e){window.vdiPeerConnection=e()}(function(e,t){"use strict";function n(e,t){t.forEach(function(t){Object.defineProperty(e,t,{enumerable:!0,get:function(){return this.readOnlyAttributes[t]},set:function(){throw new TypeError}})})}function i(e,t){t.forEach(function(t){var n=t[0],i=t[1],r=t[2];e.observableAttributes[n]=i,Object.defineProperty(e,n,{enumerable:!0,get:function(){return this.observableAttributes[n]},set:function(e){this.observableAttributes[n]=e,r()}})})}function r(e,t){t.forEach(function(t){var n=t[0],i=t[1],r=t[2];Object.defineProperty(e,n,{enumerable:!0,get:function(){return i(n)},set:function(e){return r(n,e)}})})}function o(e,t){t.forEach(function(t){var o=t[0],c=t[1];if(Object.defineProperty(e,o,{enumerable:!1,writable:!0,value:c}),"readOnlyAttributes"===o){var a=[];for(var o in c)a.push(o);n(e,a)}else"observableAttributes"===o?i(e,c):"customAttributes"===o&&r(e,c)})}function c(e,t){var n="on"+t,i=e.observableAttributes[n],r=e.eventListeners[n];e.eventListeners[n]=i,null!=r&&e.removeEventListener(t,r,!1),null!=i&&e.addEventListener(t,i,!1)}function a(){var e=this;o(this,[["customAttributes",[["size",function(){return e.getSize()},D]]]])}function s(e){return e<0&&(e+=4294967296),"0x"+e.toString(16)}function d(e){var t=[];e.forEach(function(e){t[e.name]={listeners:[],level:e.level}}),this.eventTarget=void 0,this.eventList=t}function u(){var e=navigator.mediaDevices,t=new d([{name:"devicechange",level:"info"}]);t.setEventTarget(e);var n=this;o(this,[["readOnlyAttributes",{rpcObjectType:"MediaDevices",actualMediaDevicesAddEventListener:e.addEventListener,actualMediaDevicesRemoveEventListener:e.removeEventListener,actualMediaDevicesGetUserMedia:e.getUserMedia,actualMediaDevicesEnumerateDevices:e.enumerateDevices,actualMediaDevicesGetDisplayMedia:e.getDisplayMedia}],["observableAttributes",[["ondevicechange",void 0,function(){c(n,"devicechange")}]]],["redirecting",!1],["mediaDevices",null],["audioOutputDevice",null],["eventManager",t],["eventListeners",new a],["deviceList",""],["pending",new Array]]);e.addEventListener=function(){return n.addEventListener.apply(n,arguments)},e.removeEventListener=function(){return n.removeEventListener.apply(n,arguments)},e.getUserMedia=function(){return n.getUserMedia.apply(n,arguments)},e.enumerateDevices=function(){return n.enumerateDevices.apply(n,arguments)},e.getDisplayMedia=function(){return n.getDisplayMedia.apply(n,arguments)}}function p(e){var t=this;I.debug("RTCDTMFSenderRedirector("+e+")"),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCDTMFSender",rpcObjectId:e,canInsertDTMF:!0,toneBuffer:""}],["eventManager",new d([{name:"tonechange",level:"info"}])],["eventListeners",new a],["observableAttributes",[["ontonechange",null,function(){c(t,"tonechange")}]]]])}function h(e){o(this,[["readOnlyAttributes",{id:e.id,type:e.type,timestamp:new Date(e.timestamp),rawTimestamp:e.timestamp}]]);var t=new a;for(var n in e.stats)e.stats.hasOwnProperty(n)&&(t[n]=e.stats[n]);this.stats=t}function l(e){var t=new Array;void 0!=e&&e.reports.forEach(function(e){var n=new h(e);t.push(n)}),this.statsReports=t}function f(e,t){var n=this,i=msRDCRTC.getNextRpcObjectId();I.debug("RTCPeerConnectionRedirector("+i+") - config: "+JSON.stringify(e)+", constraints: "+JSON.stringify(t));var r=new d([{name:"negotiationneeded",level:"info"},{name:"icecandidate",level:"info"},{name:"icecandidateerror",level:"error"},{name:"signalingstatechange",level:"info"},{name:"iceconnectionstatechange",level:"info"},{name:"icegatheringstatechange",level:"info"},{name:"connectionstatechange",level:"info"},{name:"track",level:"info"},{name:"addstream",level:"info"},{name:"removestream",level:"info"},{name:"statsended",level:"info"}]);o(this,[["readOnlyAttributes",{rpcObjectType:"RTCPeerConnection",rpcObjectId:i,currentLocalDescription:null,pendingLocalDescription:null,currentRemoteDescription:null,pendingRemoteDescription:null,signalingState:"stable",iceGatheringState:"new",iceConnectionState:"new",connectionState:"new",canTrickleIceCandidates:null}],["observableAttributes",[["onnegotiationneeded",void 0,function(){c(n,"negotiationneeded")}],["onicecandidate",void 0,function(){c(n,"icecandidate")}],["onicecandidateerror",void 0,function(){c(n,"icecandidateerror")}],["onsignalingstatechange",void 0,function(){c(n,"signalingstatechange")}],["oniceconnectionstatechange",void 0,function(){c(n,"iceconnectionstatechange")}],["onicegatheringstatechange",void 0,function(){c(n,"icegatheringstatechange")}],["onconnectionstatechange",void 0,function(){c(n,"connectionstatechange")}],["ontrack",void 0,function(){c(n,"track")}],["onaddstream",void 0,function(){c(n,"addstream")}],["onremovestream",void 0,function(){c(n,"removestream")}],["onstatsended",void 0,function(){c(n,"statsended")}]]],["customAttributes",[["localDescription",function(){return n.getLocalDescription()},D],["remoteDescription",function(){return n.getRemoteDescription()},D]]],["eventManager",r],["eventListeners",new a],["configuration",e],["closed",!1],["senders",[]],["receivers",[]],["transceivers",[]],["defaultIceServers",[]],["sendCapabilities",{}],["recvCapabilities",{}],["stats",void 0],["operations",[]],["opExecutionScheduled",!1],["pendingOp",null],["ready",!1],["eventMap",{signalingstatechange:"signalingState",iceconnectionstatechange:"iceConnectionState",icegatheringstatechange:"iceGatheringState",connectionstatechange:"connectionState"}]]),0!==msRDCRTC.debugLevel&&(this.debugPeriodicCallback=function(){var e=performance.now(),t=n.pendingOp;if(null!=t&&void 0==t.completed){var i=e-t.started;i>=5e3?void 0==t.hung&&(I.error('RTCPeerConnectionRedirector "rpcObjectId":'+n.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+i.toFixed(4)+" ms"),t.hung=!0):i>=1e3&&void 0==t.warned&&(I.warn('RTCPeerConnectionRedirector "rpcObjectId":'+n.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+i.toFixed(4)+" ms"),t.warned=!0)}n.operations.forEach(function(t){var i=e-t.queued;i>=5e3?void 0==t.hung&&(I.error('RTCPeerConnectionRedirector "rpcObjectId":'+n.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+i.toFixed(4)+" ms"),t.hung=!0):i>=1e3&&void 0==t.warned&&(I.warn('RTCPeerConnectionRedirector "rpcObjectId":'+n.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+i.toFixed(4)+" ms"),t.warned=!0)})}),this.queueOperation("createPeerConnection",function(){return n.makeRpcCall("createPeerConnection",[e,t]).then(function(e){I.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createPeerConnection - sendCapabilities: "+JSON.stringify(e.sendCapabilities)),I.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createPeerConnection - recvCapabilities: "+JSON.stringify(e.recvCapabilities)),n.sendCapabilities=e.sendCapabilities,n.recvCapabilities=e.recvCapabilities,n.senders.forEach(function(e){e.readOnlyAttributes.capabilities=n.sendCapabilities}),n.ready=!0})})}function v(e,t,n,i,r){var s=this,u=void 0==n?msRDCRTC.getNextRpcObjectId():n;if(void 0==i&&(i=msRDCRTC.generateUuid()),I.debug("MediaStreamRedirector("+u+") - id: "+i+", devices: "+JSON.stringify(t)),o(this,[["readOnlyAttributes",{rpcObjectType:"MediaStream",rpcObjectId:u,id:i,constraints:e}],["observableAttributes",[["onaddtrack",void 0,function(){c(s,"addtrack")}],["onremovetrack",void 0,function(){c(s,"removetrack")}]]],["eventManager",new d([{name:"addtrack",level:"info"},{name:"removetrack",level:"info"}])],["eventListeners",new a],["audioTracks",[]],["videoTracks",[]],["devices",t]]),void 0==n&&(this.makeRpcCall("createMediaStream",[{id:this.id,constraints:this.constraints}]),void 0==r))for(var p in t){var h=new g(this,t[p]);this.addTrack(h)}}function g(e,t,n,i,r){var s=this,u=void 0==n?msRDCRTC.getNextRpcObjectId():n;void 0==i&&(i=msRDCRTC.generateUuid());var p=null;if(void 0!=r)p=r;else if("audioinput"===t.kind||"audiooutput"===t.kind)p="audio";else if("videoinput"===t.kind)p="video";else{if("displayoutput"!==t.kind)throw new Error({name:"MSRDCRTC: E_NOTIMPL",message:"device not supported - kind="+t.kind});p="screenshare"}I.debug("MediaStreamTrackRedirector("+u+") - id: "+i+", kind: "+p+", stream rpcObjectId: "+e.rpcObjectId);var h=new d([{name:"mute",level:"info"},{name:"unmute",level:"info"},{name:"ended",level:"info"},{name:"overconstrained",level:"warn"}]),l=void 0;"audio"===p&&i.match(/.*-(\d+)$/)&&(l=i.replace(/.*-(\d+)$/,"$1")),o(this,[["readOnlyAttributes",{rpcObjectType:"MediaStreamTrack",rpcObjectId:u,mediaStreamRpcObjectId:e.rpcObjectId,deviceRpcObjectId:t.rpcObjectId,kind:p,id:i,label:t.label,muted:!1,readyState:"live"}],["observableAttributes",[["enabled",!0,function(){s.onEnabledAttributeChanged()}],["onmute",void 0,function(){c(s,"mute")}],["onunmute",void 0,function(){c(s,"unmute")}],["onended",void 0,function(){c(s,"ended")}],["onoverconstrained",void 0,function(){c(s,"overconstrained")}]]],["mediaStream",e],["device",t],["eventManager",h],["eventListeners",new a],["ssrc",l]]),void 0==n&&this.makeRpcCall("createMediaStreamTrack",[{mediaStreamRpcObjectId:e.rpcObjectId,id:this.id,kind:this.kind,label:this.label}])}function b(e,t,n,i){var r=msRDCRTC.getNextRpcObjectId();I.debug("RTCRtpSenderRedirector("+r+") - kind: "+t.kind+", pc rpcObjectId: "+e.rpcObjectId);var c=null;"audio"===t.kind&&(c=new p(r)),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpSender",rpcObjectId:r,track:t,kind:t.kind,transport:null,rtcpTransport:null,dtmf:c}],["ready",!1],["peerConnection",e],["streams",n],["sendEncodings",i],["parameters",null],["capabilities",e.sendCapabilities]])}function m(e,t,n,i){var r=void 0==n?msRDCRTC.getNextRpcObjectId():n;I.debug("RTCRtpReceiverRedirector("+r+") - kind: "+t+", pc rpcObjectId: "+e.rpcObjectId),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpReceiver",rpcObjectId:r,track:void 0==i?null:i,kind:t,transport:null,rtcpTransport:null}],["peerConnection",e],["parameters",null],["contributingSources",[]],["synchronizationSources",[]],["capabilities",e.recvCapabilities],["lastAudioReceived",void 0]])}function R(e,t){var n=this,i=msRDCRTC.getNextRpcObjectId();I.debug("MediaElementRedirector("+i+") - kind: "+e);var r=new d([{name:"loadstart",level:"info"},{name:"abort",level:"info"},{name:"emptied",level:"info"},{name:"stalled",level:"info"},{name:"play",level:"info"},{name:"pause",level:"info"},{name:"loadedmetadata",level:"info"},{name:"loadeddata",level:"info"},{name:"waiting",level:"info"},{name:"playing",level:"info"},{name:"canplay",level:"info"},{name:"canplaythrough",level:"info"},{name:"ended",level:"info"},{name:"durationchange",level:"info"},{name:"volumechange",level:"info"},{name:"timeupdate",level:"ignore"},{name:"progress",level:"ignore"},{name:"contextmenu",level:"info"},{name:"error",level:"error"}]);r.setEventTarget(t);var s=function(e){return n.getAttribute(e)},u=function(e){return n.getReadOnlyAttribute(e)},p=function(e,t){return n.setAttribute(e,t)};o(this,[["readOnlyAttributes",{rpcObjectType:"MediaElement",rpcObjectId:i,kind:e,duration:Number.NaN,readyState:this.HAVE_NOTHING,networkState:this.NETWORK_EMPTY,paused:t.paused,currentTime:0,ended:!1}],["redirecting",!1],["mediaElement",t],["eventManager",r],["eventListeners",new a],["actualGetAttribute",t.getAttribute],["actualSetAttribute",t.setAttribute],["actualRemoveAttribute",t.removeAttribute],["actualAddEventListener",t.addEventListener],["actualRemoveEventListener",t.removeEventListener],["actualPlay",t.play],["actualPause",t.pause],["actualLoad",t.load],["actualSetSinkId",t.setSinkId],["getAttributeFunctor",s],["setAttributeFunctor",p],["removeAttributeFunctor",function(e){return n.removeAttribute(e)}],["addEventListenerFunctor",function(e,t,i){return n.addEventListener(e,t,i)}],["removeEventListenerFunctor",function(e,t,i){return n.removeEventListener(e,t,i)}],["onResizeFunctor",function(){return n.onPositionChanged("onresize")}],["playFunctor",function(){return n.play()}],["pauseFunctor",function(){return n.pause()}],["loadFunctor",function(){return n.load()}],["setSinkIdFunctor",function(e){return n.setSinkId(e)}],["srcObject",null],["autoplay",t.autoplay],["muted",t.muted],["volume",t.volume],["lastPlayAt",0],["progressIntervalId",void 0],["boundingRect",void 0]]),o(t,[["customAttributes",[["currentSrc",u,D],["networkState",u,D],["buffered",u,D],["readyState",u,D],["seeking",u,D],["duration",u,D],["paused",u,D],["seekable",u,D],["ended",u,D],["error",u,D],["sinkId",u,D],["src",s,k],["preload",s,N],["currentTime",s,k],["defaultPlaybackRate",s,N],["playbackRate",s,N],["played",s,D],["loop",s,N],["srcObject",s,p],["autoplay",s,p],["muted",s,p],["volume",s,p]]],["observableAttributes",[["onloadstart",void 0,function(){c(n,"loadstart")}],["onsuspend",void 0,function(){c(n,"suspend")}],["onabort",void 0,function(){c(n,"abort")}],["onemptied",void 0,function(){c(n,"emptied")}],["onstalled",void 0,function(){c(n,"stalled")}],["onplay",void 0,function(){c(n,"play")}],["onpause",void 0,function(){c(n,"pause")}],["onloadedmetadata",void 0,function(){c(n,"loadedmetadata")}],["onwaiting",void 0,function(){c(n,"waiting")}],["onplaying",void 0,function(){c(n,"playing")}],["oncanplay",void 0,function(){c(n,"canplay")}],["oncanplaythrough",void 0,function(){c(n,"canplaythrough")}],["onended",void 0,function(){c(n,"ended")}],["ondurationchange",void 0,function(){c(n,"durationchange")}],["onvolumechange",void 0,function(){c(n,"volumechange")}],["ontimeupdate",void 0,function(){c(n,"timeupdate")}],["onprogress",void 0,function(){c(n,"progress")}],["oncontextmenu",void 0,function(){c(n,"contextmenu")}],["onerror",void 0,function(){c(n,"error")}]]]]);var h=[e];if("video"===e){o(t,[["observableAttributes",[["clientHeight",t.clientHeight,function(){n.onPositionChanged("clientHeight")}],["clientLeft",t.clientLeft,function(){n.onPositionChanged("clientLeft")}],["clientTop",t.clientTop,function(){n.onPositionChanged("clientTop")}],["clientWidth",t.clientWidth,function(){n.onPositionChanged("clientWidth")}],["data-vdi_videoid",t["data-vdi_videoid"],function(){n.onVdiVideoIdChanged()}],["offsetHeight",t.offsetHeight,function(){n.onPositionChanged("offsetHeight")}],["offsetLeft",t.offsetLeft,function(){n.onPositionChanged("offsetLeft")}],["offsetParent",t.offsetParent,function(){n.onPositionChanged("offsetParent")}],["offsetTop",t.offsetTop,function(){n.onPositionChanged("offsetTop")}],["offsetWidth",t.offsetWidth,function(){n.onPositionChanged("offsetWidth")}],["parentElement",t.parentElement,function(){n.onPositionChanged("parentElement")}],["parentNode",t.parentNode,function(){n.onPositionChanged("parentNode")}],["style",t.style,function(){n.onPositionChanged("style")}]]]]);var l=t.getBoundingClientRect();I.debug("MediaElementRedirector("+i+") - bounding client rect: "+JSON.stringify(l)),this.boundingRect=l,h.push({top:l.top,right:l.right,bottom:l.bottom,left:l.left})}this.makeRpcCall("createMediaElement",h)}function C(e,t){var n=(e+t).replace(/-/g,"").match(/[0-9a-f]{2}/gi),i=new ArrayBuffer(n.length),r=new Uint8Array(i);for(var o in n)r[o]=parseInt(n[o],16);this.rawKey=i,this.key=void 0}function O(){this.vmEventCallback=void 0,this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!1,this.webSocketUnavailable=!1,this.clientFeatures=void 0,this.debugLevel=0,this.socket=null,this.socketConnected=!1,this.socketClosed=!0,this.rtcSessionStarted=!1,this.enumerateDevicesOnConnect=!1,this.pendingMessages=[],this.outstandingRpcCalls=new a,this.actualRTCPeerConnection=RTCPeerConnection,this.mediaDevicesRedirector=new u,this.rtcObjects=[this.mediaDevicesRedirector],this.nextPeerConnectionId=1,this.nextVideoElementId=1,this.nextRpcObjectId=1,this.nextRpcCallId=1,this.nextOperationId=1,this.uniqueIds=new a,this.defaultSinkId=void 0,this.notifications=new a;var e=this;this.onWebSocketOpenFunctor=function(t){e.onWebSocketOpen(t)},this.onWebSocketClosedFunctor=function(t){e.onWebSocketClosed(t)},this.onWebSocketErrorFunctor=function(t){e.onWebSocketError(t)},this.onWebSocketMessageFunctor=function(t){e.onWebSocketMessage(t)}}var T,S={debug:function(){},info:function(e){T.info("MSRDCRTC: [I] "+e)},warn:function(e){T.warn("MSRDCRTC: [W] "+e)},error:function(e){T.error("MSRDCRTC: [E] "+e)}},E={debug:function(e){T.debug("MSRDCRTC: [D] "+e)},info:function(e){T.info("MSRDCRTC: [I] "+e)},warn:function(e){T.warn("MSRDCRTC: [W] "+e)},error:function(e){T.error("MSRDCRTC: [E] "+e)}},y={debug:function(e){console.debug("MSRDCRTC: [D] "+e)},info:function(e){console.info("MSRDCRTC: [I] "+e)},warn:function(e){console.warn("MSRDCRTC: [W] "+e)},error:function(e){console.error("MSRDCRTC: [E] "+e)}},I=S,N=function(){},D=function(){throw new TypeError},k=function(){throw new InvalidStateError};return a.prototype={forEach:function(e){for(var t in this)"size"!==t&&this.hasOwnProperty(t)&&e(t)},get:function(e){return this[e]},has:function(e){return void 0!=this[e]},keys:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},values:function(){var e=[],t=this;return this.forEach(function(n){e.push(t.get(n))}),e},getSize:function(){return this.keys().length}},d.prototype={addEventListener:function(e,t,n){var i=this.eventList[e];if(void 0==i)throw new Error({name:"MSRDCRTC: Error",message:"Event not expected: "+e});i.listeners.push(t)},removeEventListener:function(e,t,n){var i=this.eventList[e];if(void 0==i)throw new Error({name:"MSRDCRTC: Error",message:"Event not expected: "+e});var r=i.listeners;for(var o in r)if(r[o]===t){r.splice(o,1);break}},setEventTarget:function(e){this.eventTarget=e},fireEvent:function(e,t){var n=this.eventList[e];if(void 0==n)return I.warn("event not expected: "+e),!1;var i=n.level;"ignore"!==i&&("debug"===i?I.debug:"info"===i?I.info:"warn"===i?I.warn:I.error)("EventManager::fireEvent('"+e+"')");var r=document.createEvent("HTMLEvents");if(r.initEvent(e,!1,!0),void 0!=t)for(var o in t)r[o]=t[o];if(void 0!=this.eventTarget)this.eventTarget.dispatchEvent(r);else{n.listeners.forEach(function(e){e(r)})}return!0}},u.prototype={enableRedirection:function(){this.redirecting=!0},disableRedirection:function(){this.redirecting=!1,this.mediaDevices=null,this.deviceList="",this.pending=new Array},addEventListener:function(e,t,n){I.debug("MediaDevicesRedirector adding event listener for: "+e),this.eventManager.addEventListener(e,t,n),this.actualMediaDevicesAddEventListener.apply(navigator.mediaDevices,arguments)},removeEventListener:function(e,t,n){I.debug("MediaDevicesRedirector removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n),this.actualMediaDevicesRemoveEventListener.apply(navigator.mediaDevices,arguments)},enumerateDevices:function(){if(I.debug("MediaDevicesRedirector::enumerateDevices("+JSON.stringify(arguments)+")"),!this.redirecting)return I.info("returning empty array"),msRDCRTC.enumerateDevicesOnConnect=!0,new Promise(function(e,t){e([])});var e=this;if(null!=this.mediaDevices)return new Promise(function(t,n){I.debug("MediaDevicesRedirector::enumerateDevices returning: "+JSON.stringify(e.mediaDevices)),t(e.mediaDevices)});var t={},n=new Promise(function(e,n){t.resolve=function(t){I.debug("MediaDevicesRedirector::enumerateDevices returning: "+JSON.stringify(t)),e(t)},t.reject=function(e){n(e)}});return this.pending.push(t),1==this.pending.length&&e.makeRpcCall("enumerateDevices",arguments).then(function(t){e.onEnumerateDevices(t),e.pending.forEach(function(e){e.resolve(t)}),e.pending=new Array}).catch(function(t){e.pending.forEach(function(e){e.reject(t)}),e.pending=new Array}),n},onEnumerateDevices:function(e){var t=JSON.stringify(e);if(t!==this.deviceList){this.deviceList=t,this.mediaDevices=e,this.audioOutputDevice=null;for(var n in e){var i=e[n];if("audiooutput"===i.kind&&null==this.audioOutputDevice){this.audioOutputDevice=i;break}}this.eventManager.fireEvent("devicechange")}},getUserMedia:function(){if(I.debug("MediaDevicesRedirector::getUserMedia("+JSON.stringify(arguments)+")"),!msRDCRTC.redirectionSupported())return I.info("passing through call to actual MediaDevices.getUserMedia"),this.actualMediaDevicesGetUserMedia.apply(navigator.mediaDevices,arguments);var e,t,n;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],n=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getUserMedia() constraints must not be the empty set.");var i=!1,r=!1;if(!0===e||e.audio&&e.video?(i=!0,r=!0):e.audio?i=!0:e.video&&(r=!0),!i&&!r)throw new TypeError("getUserMedia() constraints not supported.");var o=this;return null==this.mediaDevices?new Promise(function(c,a){o.enumerateDevices().then(function(s){o.completeGetUserMedia(e,i,r,t,n,c,a)}).catch(function(e){a(e)})}):new Promise(function(c,a){o.completeGetUserMedia(e,i,r,t,n,c,a)})},completeGetUserMedia:function(e,t,n,i,r,o,c){var a,s,d=new Array;t&&e.audio&&(a=e.audio.deviceId),n&&e.video&&(s=e.video.deviceId);for(var u=void 0===a,p=void 0===s,h=!1,l=!1,f=null==this.mediaDevices?0:this.mediaDevices.length,g=0;g<f;++g){var b=this.mediaDevices[g];if(t&&"audioinput"===b.kind&&!h?(u||b.deviceId===a)&&(d.push(b),h=!0):n&&"videoinput"===b.kind&&!l&&(p||b.deviceId===s)&&(d.push(b),l=!0),h&&l)break}if(d.length>0){var m=new v(e,d);I.debug("MediaDevicesRedirector::getUserMedia returning: "+JSON.stringify(m)),void 0!=i?(i(m),o()):o(m)}else{var R=t?n?"audio or video":"audio":"video",C=new Error({name:"MSRDCRTC Error",message:"No "+R+" input device found."});void 0!=r&&r(C),c(C)}},getDisplayMedia:function(){I.debug("MediaDevicesRedirector::getDisplayMedia("+JSON.stringify(arguments)+")");var e,t,n;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],n=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getDisplayMedia() constraints must not be the empty set.");var i=!0===e||e.video,r=this;return new Promise(function(o,c){r.completeGetDisplayMedia(e,i,t,n,o,c)})},completeGetDisplayMedia:function(e,t,n,i,r,o){var c=new Array;if(c.push(JSON.parse('{"deviceId":"display","kind":"displayoutput","label":"Session Desktop"}')),t&&e.video){var a=new v(e,c);I.debug("MediaDevicesRedirector::getDisplayMedia returning: "+JSON.stringify(a)),void 0!=n?(n(a),r()):r(a)}},onDeviceChange:function(e){this.onEnumerateDevices(e.mediaDevices)},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&"devicechange"===e.rpcEventName&&(this.onDeviceChange(e.rpcEventArgs),t=!0),t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},n)}},p.prototype={addEventListener:function(e,t,n){I.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,n)},removeEventListener:function(e,t,n){I.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n)},insertDTMF:function(e,t,n){I.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - Inserting tones ["+e+"] with Duration:"+t+" and Gap:"+n),this.makeRpcCall("insertDTMF",[{tones:e,duration:t,gap:n}])},onToneChange:function(e,t){I.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+")::onToneChange("+JSON.stringify(e)+", "+JSON.stringify(t)+")"),this.readOnlyAttributes.toneBuffer=t,this.eventManager.fireEvent("tonechange",{tone:e})},makeRpcCall:function(e,t){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t})}},h.prototype={names:function(){return this.stats.keys()},stat:function(e){return this.stats.get(e)}},l.prototype={namedItem:function(){return null},result:function(){return this.statsReports}},f.prototype={addEventListener:function(e,t,n){I.debug("adding event listener for: "+e),this.eventManager.addEventListener(e,t,n)},removeEventListener:function(e,t,n){I.debug("removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n)},createOffer:function(){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createOffer("+JSON.stringify(arguments)+")");var e,t,n;arguments.length<=1?e=arguments[0]:(t=arguments[0],n=arguments[1],e=arguments[2]);var i=this;return new Promise(function(r,o){i.queueOperation("createOffer",function(){return i.makeRpcCall("createOffer",[e]).then(function(e){void 0!=t?(I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createOffer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=n&&n(e),o(e)})})})},createAnswer:function(){if(I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createAnswer("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,n;arguments.length<=1?e=arguments[0]:(t=arguments[0],n=arguments[1]);var i=this;return new Promise(function(r,o){i.queueOperation("createAnswer",function(){return i.makeRpcCall("createAnswer",[e]).then(function(e){void 0!=t?(I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createAnswer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=n&&n(e),o(e)})})})},setLocalDescription:function(){if(I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setLocalDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,n=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingLocalDescription=n;var i=this;return new Promise(function(r,o){i.queueOperation("setLocalDescription",function(){return i.makeRpcCall("setLocalDescription",[n]).then(function(t){i.readOnlyAttributes.currentLocalDescription=n,i.readOnlyAttributes.pendingLocalDescription=null,void 0!=e&&(I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::setLocalDescription - calling successCallback"),e()),r()}).catch(function(e){i.readOnlyAttributes.pendingLocalDescription=null,void 0!=t&&t(e),o(e)})})})},setRemoteDescription:function(){if(I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setRemoteDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,n=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingRemoteDescription=n;var i=this;return new Promise(function(r,o){i.queueOperation("setRemoteDescription",function(){return i.makeRpcCall("setRemoteDescription",[n]).then(function(t){i.readOnlyAttributes.currentRemoteDescription=n,i.readOnlyAttributes.pendingRemoteDescription=null,void 0!=e&&(I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::setRemoteDescription - calling successCallback"),e()),r()}).catch(function(e){i.readOnlyAttributes.pendingRemoteDescription=null,void 0!=t&&t(e),o(e)})})})},addIceCandidate:function(){if(I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addIceCandidate("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,n=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]);var i=this;return new Promise(function(r,o){i.queueOperation("addIceCandidate",function(){return i.makeRpcCall("addIceCandidate",[n]).then(function(t){I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::addIceCandidate - updating remoteDescription: "+JSON.stringify(t.result)),i.remoteDescription=t.result,void 0!=e&&(I.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::addIceCandidate - calling successCallback"),e()),r()}).catch(function(e){void 0!=t&&t(e),o(e)})})})},getDefaultIceServers:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers("+JSON.stringify(arguments)+")"),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers returning: "+JSON.stringify(this.defaultIceServers)),this.defaultIceServers},getConfiguration:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration("+JSON.stringify(arguments)+")"),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration returning: "+JSON.stringify(this.configuration)),this.configuration},setConfiguration:function(e){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setConfiguration("+JSON.stringify(arguments)+")"),this.configuration=e;var t=this;this.queueOperation("setConfiguration",function(){return t.makeRpcCall("setConfiguration",[e]).then(function(){t.configuration=e})})},close:function(){if(I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::close("+JSON.stringify(arguments)+")"),!this.closed){var e=this;this.queueOperation("close",function(){return e.makeRpcCall("close").finally(function(){e.closed=!0})})}},getSenders:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders("+JSON.stringify(arguments)+")"),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders returning: "+JSON.stringify(this.senders)),this.senders},getReceivers:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers("+JSON.stringify(arguments)+")"),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers returning: "+JSON.stringify(this.receivers)),this.receivers},getTransceivers:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getTransceivers("+JSON.stringify(arguments)+")"),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getTransceivers returning: "+JSON.stringify(this.transceivers)),this.transceivers},addStream:function(e){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addStream("+JSON.stringify(arguments)+")");var t=this;e.getTracks().forEach(function(n){t.internalAddTrack(n,e)})},removeStream:function(){I.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addStream("+JSON.stringify(arguments)+") - E_NOTIMPL")},addTrack:function(){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),this.internalAddTrack.apply(this,arguments)},removeTrack:function(e){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")");var t=this;this.queueOperation("removeTrack",function(){return t.makeRpcCall("removeTrack",[{senderRpcObjectId:e.rpcObjectId}])})},addTransceiver:function(e,t){I.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTransceiver("+JSON.stringify(arguments)+") - E_NOTIMPL")},createDTMFSender:function(){I.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createDTMFSender("+JSON.stringify(arguments)+") - E_NOTIMPL")},getLocalStreams:function(){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.senders.forEach(function(t){e=e.concat(t.streams)}),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams - returning: "+JSON.stringify(e)),e},getRemoteStreams:function(){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.receivers.forEach(function(t){e=e.concat(t.track.mediaStream)}),I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams - returning: "+JSON.stringify(e)),e},getStats:function(){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e,t;arguments.length>0&&void 0!=arguments[0]&&"function"==typeof arguments[0]?e=arguments[0]:t=arguments[0];var n={};void 0!=t&&(n={selectorRpcObjectType:t.rpcObjectType,selectorRpcObjectId:t.rpcObjectid});var i=this;return this.closed?void 0!=e?void e(new l):new Promise(function(e,t){t(new InvalidStateError)}):this.ready?new Promise(function(t,r){i.makeRpcCall("getStats",[n]).then(function(n){if(i.updateContributingSources(n.receivers),void 0!=e){var r=new l(n);return i.stats=r,void e(r)}var o=new a;for(var c in n){var s=n[c];o[s.id]=s}t(o)}).catch(function(e){r(e)})}):void 0!=e?void e(new l):new Promise(function(e,t){e(new a)})},setState:function(e,t,n){var i=this.readOnlyAttributes[e];i!==t&&(this.readOnlyAttributes[e]=t,I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setState - "+e+" changed from: "+i+" to: "+t),this.eventManager.fireEvent(n))},setSignalingState:function(e){this.setState("signalingState",e,"signalingstatechange")},setIceConnectionState:function(e){this.setState("iceConnectionState",e,"iceconnectionstatechange")},setIceGatheringState:function(e){this.setState("iceGatheringState",e,"icegatheringstatechange")},setConnectionState:function(e){this.setState("connectionState",e,"connectionstatechange")},getLocalDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingLocalDescription,t=this.readOnlyAttributes.pendingLocalDescription||this.readOnlyAttributes.currentLocalDescription;return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalDescription - pending="+e+": "+JSON.stringify(t)),t},getRemoteDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingRemoteDescription,t=this.readOnlyAttributes.pendingRemoteDescription||this.readOnlyAttributes.currentRemoteDescription;return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteDescription - pending="+e+": "+JSON.stringify(t)),t},getReceiverByRpcObjectId:function(e){var t=null;return this.receivers.some(function(n){return n.rpcObjectId==e&&(t=n),null!=t}),t},internalAddTrack:function(e,t){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::internalAddTrack("+JSON.stringify(arguments)+")"),void 0!=t&&(t=(new Array).concat(t));var n=new b(this,e,t,void 0),i=this,r=new Array;return void 0!=t&&t.forEach(function(e){r.push(e.rpcObjectId)}),this.queueOperation("addTrack",function(){return i.makeRpcCall("addTrack",[{trackRpcObjectId:e.rpcObjectId,streamRpcObjectIds:r,senderRpcObjectId:n.rpcObjectId}]).then(function(e){n.ready=!0})}),this.senders.push(n),n},onTrack:function(e){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiver,n=e.stream,i=e.track,r=new Array,o=msRDCRTC.mediaDevicesRedirector.audioOutputDevice,c=new v(void 0,[o],n.rpcObjectId,n.id),a=new g(c,o,i.rpcObjectId,i.id,t.kind);c.addTrack(a);var s=new m(this,t.kind,t.rpcObjectId,a);this.receivers.push(s);var d={track:a,receiver:s,streams:r};return this.eventManager.fireEvent("addstream",{stream:c}),d},onRemoveTrack:function(e){I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onRemoveTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiverRpcObjectId,n=void 0;for(var i in this.receivers){var r=this.receivers[i];if(r.rpcObjectId===t){n=r.track.mediaStream,this.receivers.splice(i,1);break}}this.eventManager.fireEvent("removestream",{stream:n})},onIceCandidate:function(e){return I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onIceCandidate - "rpcObjectId":'+this.rpcObjectId+" - updating localDescription: "+JSON.stringify(e.desc)),this.readOnlyAttributes.currentLocalDescription=e.desc,e},updateContributingSources:function(e){if(e)for(var t in this.receivers){var n=this.receivers[t],i=e.find(function(e){return e.rpcObjectId===n.rpcObjectId});i?n.updateContributingSources(i.contributingSources):n.updateContributingSources([])}},queueOperation:function(e,t){var n=this.operations.length,i={id:msRDCRTC.getNextOperationId(),name:e,op:t,queued:performance.now(),started:void 0,completed:void 0};I.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::queueOperation - "rpcObjectId":'+this.rpcObjectId+', "opName":'+i.name+', "opId":'+i.id+", "+n+" operation"+(1!==n?"s":"")+" ahead in queue"),this.operations.push(i),this.scheduleNextOperation()},scheduleNextOperation:function(e){if(!this.opExecutionScheduled&&null==this.pendingOp&&this.operations.length>0){this.opExecutionScheduled=!0;var t=this;window.setTimeout(function(){t.executeNextOperation()},0)}},executeNextOperation:function(){this.opExecutionScheduled=!1;var e=this.operations.shift();if(void 0!=e)if(null==this.pendingOp){this.pendingOp=e;var t=this;e.started=performance.now();var n=e.started-e.queued;(n>=5e3?I.error:n>=1e3?I.warn:I.debug)("RTCPeerConnectionRedirector("+this.rpcObjectId+')::executeNextOperation - "rpcObjectId":'+this.rpcObjectId+', "opName":'+e.name+', "opId":'+e.id+" is starting after waiting in queue for "+n.toFixed(4)+" ms"),e.op().then(function(){e.completed=performance.now();var n=e.started-e.queued,i=e.completed-e.started;(n>=5e3||i>=5e3?I.error:n>=1e3||i>=1e3?I.warn:I.debug)('RTCPeerConnectionRedirector "rpcObjectId":'+t.rpcObjectId+', "opName":'+e.name+', "opId":'+e.id+" took "+i.toFixed(4)+" ms, after sitting in the queue for "+n.toFixed(4)+" ms")}).finally(function(){t.pendingOp=null,t.scheduleNextOperation()})}else I.error("RTCPeerConnectionRedirector("+this.rpcObjectId+')::executeNextOperation "rpcObjectId":'+this.rpcObjectId+" was called while an operation was pending.");else void 0!=e&&I.debug('RTCPeerConnectionRedirector "rpcObjectId":'+this.rpcObjectId+" is closed - dropping operation")},disableRedirection:function(){this.closed||(this.pendingOp=null,this.operations=new Array,"new"!==this.iceConnectionState&&(I.info("RTCPeerConnectionRedirector("+this.rpcObjectId+")::disableRedirection - iceConnectionState changing from: "+this.iceConnectionState+" to: failed"),this.setIceConnectionState("failed")),this.closed=!0)},onRpcEventNotification:function(e){var t=!1,n=e.rpcEventTarget,i=e.rpcEventArgs;if(n.rpcObjectType===this.rpcObjectType&&n.rpcObjectId===this.rpcObjectId){var r=e.rpcEventName,o=i&&i.state;if(void 0!=o){var c=this.eventMap[r];void 0!=c&&(this.setState(c,o,r),t=!0)}t||("removetrack"===r?(this.onRemoveTrack(i),t=!0):("track"===r?i=this.onTrack(i):"icecandidate"===r&&(i=this.onIceCandidate(i)),t=this.eventManager.fireEvent(r,i)))}else"RTCRtpReceiver"===n.rpcObjectType?this.getReceivers().forEach(function(n){void 0!=n.onRpcEventNotification&&n.onRpcEventNotification(e)&&(t=!0)}):"RTCRtpSender"===n.rpcObjectType&&this.getSenders().forEach(function(n){void 0!=n.onRpcEventNotification&&n.onRpcEventNotification(e)&&(t=!0)});return t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n)}},v.prototype={addEventListener:function(e,t,n){I.debug("MediaStreamRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,n)},removeEventListener:function(e,t,n){I.debug("MediaStreamRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n)},getAudioTracks:function(){return I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks("+JSON.stringify(arguments)+")"),I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks returning: "+JSON.stringify(this.audioTracks)),this.audioTracks},getVideoTracks:function(){return I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks("+JSON.stringify(arguments)+")"),I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks returning: "+JSON.stringify(this.videoTracks)),this.videoTracks},getTracks:function(){I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks("+JSON.stringify(arguments)+")");var e=this.audioTracks.concat(this.videoTracks);return I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks returning: "+JSON.stringify(e)),e},getTrackById:function(e){I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById("+JSON.stringify(arguments)+")");var t=null;for(var n in this.audioTracks)if(n.id===e){t=n;break}if(null==t)for(var n in this.videoTracks)if(n.id===e){t=n;break}return I.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById returning: "+JSON.stringify(t)),t},addTrack:function(e){if(I.debug("MediaStreamRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),null==this.getTrackById(e.id)){if("audio"===e.kind)this.audioTracks.push(e);else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("addTrack - unsupported track kind: "+e.kind);this.videoTracks.push(e)}this.eventManager.fireEvent("addtrack")}},removeTrack:function(e){if(I.debug("MediaStreamRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")"),null!=this.getTrackById(e.id)){var t=null;if("audio"===e.kind)t=this.audioTracks;else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("removeTrack - unsupported track kind: "+e.kind);t=this.videoTracks}var n=e.id;for(var i in t)if(t[i].id===n){t.splice(i,1);break}this.eventManager.fireEvent("removetrack")}},clone:function(){I.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone");var e=new v(this.constraints,this.devices,void 0,void 0,"cloning");return this.getTracks().forEach(function(t){var n=t.internalClone(e);e.addTrack(n)}),I.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},onRpcEventNotification:function(e){var t=!1,n=e.rpcEventTarget;return n.rpcObjectType===this.rpcObjectType&&n.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n)}},g.prototype={addEventListener:function(e,t,n){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,n)},removeEventListener:function(e,t,n){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n)},clone:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var e=this.internalClone(this.mediaStream);return I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},internalClone:function(e){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var t=new g(e,this.device);return t.readOnlyAttributes.readyState=this.readyState,t.observableAttributes.enabled=this.observableAttributes.enabled,I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(t)),t},stop:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::stop("+JSON.stringify(arguments)+")"),this.setReadyState("ended"),this.makeRpcCall("stop")},getCapabilities:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+") - E_NOTIMPL")},getConstraints:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getConstraints("+JSON.stringify(arguments)+") - E_NOTIMPL")},getSettings:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getSettings("+JSON.stringify(arguments)+") - E_NOTIMPL")},applyConstraints:function(e){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::applyConstraints("+JSON.stringify(arguments)+")");var t=this;return new Promise(function(n,i){t.makeRpcCall("applyConstraints",e).then(function(e){n()}).catch(function(e){i(e)})})},setReadyState:function(e){var t=this.readyState;t!==e&&(this.readOnlyAttributes.readyState=e,I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::setReadyState - old="+t+", new="+e),"ended"===e&&this.eventManager.fireEvent("ended"))},onEnabledAttributeChanged:function(){I.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::onEnabledAttributeChanged("+JSON.stringify(arguments)+")"),"ended"!==this.readyState&&this.makeRpcCall("onEnabledAttributeChanged",[this.enabled])},onRpcEventNotification:function(e){var t=!1,n=e.rpcEventTarget;return n.rpcObjectType===this.rpcObjectType&&n.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n)}},b.prototype={getCapabilities:function(e){I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},setParameters:function(e){return I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setParameters("+JSON.stringify(arguments)+")"),this.parameters=e,this.makeRpcCall("setParameters",[e])},getParameters:function(){return I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getParameters returning: "+JSON.stringify(this.parameters)),this.parameters},replaceTrack:function(e){I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::replaceTrack("+JSON.stringify(arguments)+") - E_NOTIMPL")},setStreams:function(e){I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setStreams("+JSON.stringify(arguments)+") - E_NOTIMPL")},getStats:function(){if(I.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")"),!this.ready)return new Promise(function(e,t){e(new a)});var e=this;return new Promise(function(t,n){e.makeRpcCall("getStats",arguments).then(function(e){var n=new a;for(var i in e){var r=e[i];n[r.id]=r}t(n)}).catch(function(e){n(e)})})},onRpcEventNotification:function(e){var t=!1;if(e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"tonechange"===e.rpcEventName){var n=e.rpcEventArgs,i=n.tone,r=n.toneBuffer;this.dtmf.onToneChange(i,r),t=!0}return t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n)}},m.prototype={getCapabilities:function(e){I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},getParameters:function(){return I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters returning: "+JSON.stringify(this.parameters)),this.parameters},getContributingSources:function(){return I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources("+JSON.stringify(arguments)+")"),I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources returning: "+JSON.stringify(this.contributingSources)),this.contributingSources},getSynchronizationSources:function(){return I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources("+JSON.stringify(arguments)+")"),I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources returning: "+JSON.stringify(this.synchronizationSources)),this.synchronizationSources},getStats:function(){I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e=this;return new Promise(function(t,n){e.makeRpcCall("getStats",arguments).then(function(e){var n=new a;for(var i in e){var r=e[i];n[r.id]=r}t(n)}).catch(function(e){n(e)})})},onContributingSourcesChanged:function(e){I.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::onContributingSourcesChanged("+JSON.stringify(e)+")"),this.contributingSources=e},updateContributingSources:function(e){void 0!=this.track&&(this.contributingSources=e,this.contributingSources||(this.contributingSources=[]))},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"contributingsourceschanged"===e.rpcEventName&&(this.onContributingSourcesChanged(e.rpcEventArgs.sources),t=!0),t},makeRpcCall:function(e,t,n){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n)}},R.prototype={MEDIA_ERR_ABORTED:1,MEDIA_ERR_NETWORK:2,MEDIA_ERR_DECODE:3,MEDIA_ERR_SRC_NOT_SUPPORTED:4,NETWORK_EMPTY:0,NETWORK_IDLE:1,NETWORK_LOADING:2,NETWORK_NO_SOURCE:3,HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4,enableRedirection:function(){if(!this.redirecting){var e=this.mediaElement;"video"===this.kind&&e.addEventListener("onresize",this.onResizeFunctor,!1),e.getAttribute=this.getAttributeFunctor,e.setAttribute=this.setAttributeFunctor,e.removeAttribute=this.removeAttributeFunctor,e.addEventListener=this.addEventListenerFunctor,e.removeEventListener=this.removeEventListenerFunctor,e.play=this.playFunctor,e.pause=this.pauseFunctor,e.load=this.loadFunctor,e.setSinkId=this.setSinkIdFunctor,this.redirecting=!0}},disableRedirection:function(){if(this.redirecting){var e=this.mediaElement;e.getAttribute=this.actualGetAttribute,e.setAttribute=this.actualSetAttribute,e.removeAttribute=this.actualRemoveAttribute,e.addEventListener=this.actualAddEventListener,e.removeEventListener=this.actualRemoveEventListener,e.play=this.actualPlay,e.pause=this.actualPause,e.load=this.actualLoad,e.setSinkId=this.actualSetSinkId,"video"===this.kind&&e.removeEventListener("onresize",this.onResizeFunctor,!1),this.stopProgressTimer(),this.redirecting=!1}},getAttribute:function(e){return"preload"===e?"none":"currentTime"===e?this.getCurrentTime():"duration"===e?this.duration:"defaultPlaybackRate"===e?1:"playbackRate"===e?1:"played"===e?this.getPlayedRanges():"loop"!==e&&("srcObject"===e?this.srcObject:"sinkId"===e?this.sinkId:"autoplay"===e?this.autoplay:"muted"===e?this.muted:"volume"===e?this.volume:"data-vdi_videoid"===e?this["data-vdi_videoid"]:void I.warn("MediaElementRedirector("+this.rpcObjectId+")::getAttribute called for unsupported attribute: name="+e))},getReadOnlyAttribute:function(e){return this.redirecting?this.readOnlyAttributes[e]:this.actualGetAttribute.apply(this.mediaElement,arguments)},setAttribute:function(e,t){var n=null,i=!0,r=!1,o=null,c=this;if("srcObject"===e){if(null!=t&&"MediaStream"!==t.rpcObjectType)throw new TypeError("srcObject is not an instance of MediaStreamRedirector");this.readOnlyAttributes.networkState=this.NETWORK_LOADING,o=function(e){c.setReadyState(c.HAVE_ENOUGH_DATA)},this.srcObject=t,null!=t&&(t={rpcObjectType:t.rpcObjectType,rpcObjectId:t.rpcObjectId})}else"autoplay"===e?(r=!0,n=this.autoplay,this.autoplay=t):"muted"===e?(r=!0,n=this.muted,this.muted=t,o=function(e){c.eventManager.fireEvent("volumechange")}):"volume"===e?(r=!0,n=this.volume,this.volume=t,o=function(e){c.eventManager.fireEvent("volumechange")}):"data-vdi_videoid"===e?(I.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for data-vdi_video value="+t),this["data-vdi_videoid"]=t):(i=!1,I.warn("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for unsupported attribute: name="+e+", value="+t));n!==t&&(r&&this.actualSetAttribute.apply(this.mediaElement,arguments),i&&this.makeRpcCall("setAttribute",[e,t]).then(function(e){null!=o&&o(e)}))},removeAttribute:function(e){I.warn("MediaElementRedirector("+this.rpcObjectId+")::removeAttribute called for unsupported attribute: name="+e+", value="+value)},addEventListener:function(e,t,n){I.debug("MediaElementRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,n),this.actualAddEventListener.apply(this.mediaElement,arguments)},removeEventListener:function(e,t,n){I.debug("MediaElementRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,n),this.actualRemoveEventListener.apply(this.mediaElement,arguments),"loadedmetadata"===e&&msRDCRTC.clientVersionGreaterThanOrEqual("0.8.0")&&msRDCRTC.wssVersionGreaterThanOrEqual("0.8.0")&&this.makeRpcCall("shutdown",void 0,!1)},setSinkId:function(e){return I.debug("MediaElementRedirector("+this.rpcObjectId+")::setSinkId: "+e),this.makeRpcCall("setSinkId",[e])},play:function(){if(I.debug("MediaElementRedirector("+this.rpcObjectId+")::play"),this.paused){this.eventManager.fireEvent("play"),this.lastPlayAt=performance.now();var e=this;this.makeRpcCall("play").then(function(){e.readOnlyAttributes.paused=!1,e.eventManager.fireEvent("playing"),e.startProgressTimer()})}},pause:function(){if(I.debug("MediaElementRedirector("+this.rpcObjectId+")::pause"),!this.paused){var e=this;this.makeRpcCall("pause").then(function(){e.stopProgressTimer(),e.readOnlyAttributes.paused=!0,e.updateCurrentTime(),e.eventManager.fireEvent("pause")})}},load:function(){I.debug("MediaElementRedirector("+this.rpcObjectId+")::load")},getCurrentTime:function(){return this.currentTime},updateCurrentTime:function(){var e=performance.now(),t=this.currentTime,n=e-this.lastPlayAt;n!==t&&(this.readOnlyAttributes.currentTime=n,this.eventManager.fireEvent("timeupdate"))},getPlayedTimeRanges:function(){var e=this.getCurrentTime(),t=new TimeRanges;return 0!==e&&t.setTimeRange(0,e),t},setReadyState:function(e){var t=this.readyState;if(t!==e){var n=!1;t===this.HAVE_NOTHING&&e>=this.HAVE_METADATA&&(this.readOnlyAttributes.readyState=this.HAVE_METADATA,isNaN(this.duration)&&(this.readOnlyAttributes.duration=Number.POSITIVE_INFINITY,this.eventManager.fireEvent("durationchange")),this.eventManager.fireEvent("loadedmetadata")),t<=this.HAVE_METADATA&&e>=this.HAVE_CURRENT_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_CURRENT_DATA,this.eventManager.fireEvent("loadeddata")),t<=this.HAVE_CURRENT_DATA&&e>=this.HAVE_FUTURE_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_FUTURE_DATA,this.eventManager.fireEvent("canplay"),n=!0),t<=this.HAVE_FUTURE_DATA&&e>=this.HAVE_ENOUGH_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_ENOUGH_DATA,this.eventManager.fireEvent("canplaythrough"),n=!0),n&&this.paused&&this.autoplay&&this.play()}},startProgressTimer:function(){if(void 0==this.progressIntervalId){I.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer");var e=this;this.progressIntervalId=window.setInterval(function(){e.onProgressTimer()},250)}},stopProgressTimer:function(){void 0!=this.progressIntervalId&&(I.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer"),window.clearInterval(this.progressIntervalId),this.progressIntervalId=void 0)},onProgressTimer:function(){this.paused||this.ended||(this.onPositionChanged("poll"),this.updateCurrentTime(),this.eventManager.fireEvent("progress"))},onVdiVideoIdChanged:function(){I.debug("MediaElementRedirector("+this.rpcObjectId+")::onVdiVideoIdChanged: "+this.mediaElement["data-vdi_video"])},onPositionChanged:function(e){"poll"!==e&&I.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged due to "+e+": ["+this.mediaElement[e]+"]");var t={left:0,top:0,right:0,bottom:0},n=this.boundingRect;this.mediaElement&&(t=this.mediaElement.getBoundingClientRect()),null!=n&&t.left===n.left&&t.top===n.top&&t.right===n.right&&t.bottom===n.bottom||(I.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged - bounding client rect changed from: "+JSON.stringify(n)+" to: "+JSON.stringify(t)),this.boundingRect=t,this.makeRpcCall("notifyPositionChanged",[{left:t.left,top:t.top,right:t.right,bottom:t.bottom}],!1,!0,!0))},makeRpcCall:function(e,t,n,i,r){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},n,i,r)}},C.prototype={sign:function(e){var t=this;return void 0==this.key?new Promise(function(n,i){t.importKey().then(function(){t.generateHash(e).then(function(e){n(e)}).catch(function(e){i(e)})}).catch(function(e){i(e)})}):this.generateHash(e)},importKey:function(){var e=this;return new Promise(function(t,n){window.crypto.subtle.importKey("raw",e.rawKey,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]).then(function(n){e.key=n,t()}).catch(function(e){n(e)})})},pad:function(e){for(;e.length<2;)e="0"+e;return e},generateHash:function(e){for(var t=this,n=e.length,i=new ArrayBuffer(n),r=new Uint8Array(i),o=0;o<n;++o)r[o]=e.charCodeAt(o);return new Promise(function(e,n){window.crypto.subtle.sign({name:"HMAC"},t.key,i).then(function(n){for(var i=new Uint8Array(n),r="",o=i.byteLength,c=0;c<o;++c)r+=t.pad(i[c].toString(16));e(r)}).catch(function(e){n(e)})})}},O.prototype={VERSION:"0.9.4",WEBSOCKET_DEFAULT_PORT:9500,WEBSOCKET_PORT:O.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_URI_BASE:"ws://localhost",WEBSOCKET_URI:O.WEBSOCKET_URI_BASE+":"+O.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_SERVICE_ID:"388FE4DA-5AAD-C078-FCD5-2DB6ADE9C174",WEBSOCKET_KEY:void 0,CLIENT_OS_VERSION:void 0,HOST_OS_VERSION:void 0,OOB_CLIENT_VERSION:void 0,WEBRTC_VERSION:void 0,WEBRTC_REDIRECTOR_VERSION:void 0,WEBSOCKET_SERVICE_VERSION:void 0,SESSION_ID:void 0,ENDPOINT_ID:void 0,APP_WINDOW_NAME:"Chrome Legacy Window",NOTIFICATION_ASSETS_BASEURI:"https://teams.microsoft.com/assets/audio",STATE_NOT_CONNECTED:0,STATE_CONNECTING:1,STATE_CONNECTED:2,STATE_WS_CONNECTION_FAILED:3,STATE_ENDPOINT_UNSUPPORTED:4,STATE_CONNECTION_FAILED:5,init:function(e){var t=this;T=e,I.info("WVD VDI shim loaded - v"+this.VERSION),this.getConfiguration().then(function(){t.startRtcSession()})},setConnectionState:function(e,t){I.info("connectionState changed from: "+this.connectionState+" to: "+e);var n=this.connectionState;if(this.connectionState=e,e===this.STATE_NOT_CONNECTED)this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],n),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointDisconnected"});else if(e===this.STATE_CONNECTING){if(this.verifyConnectionState([this.STATE_NOT_CONNECTED],n),null==this.socket){I.debug("connecting to: "+this.WEBSOCKET_URI),this.webSocketUnavailable=!1,this.endpointUnsupported=!1;var i=new WebSocket(this.WEBSOCKET_URI);i.addEventListener("open",this.onWebSocketOpenFunctor,!1),i.addEventListener("closed",this.onWebSocketClosedFunctor,!1),i.addEventListener("error",this.onWebSocketErrorFunctor,!1),i.addEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=i}}else if(e===this.STATE_CONNECTED)this.verifyConnectionState([this.STATE_CONNECTING],n),this.rtcObjects.forEach(function(e){void 0!=e.enableRedirection&&e.enableRedirection()}),this.notifyVmEventCallback({event:"vdiClientConnected",version:{clientOS:this.CLIENT_OS_VERSION,hostOS:this.HOST_OS_VERSION,oobClient:this.OOB_CLIENT_VERSION,webRTC:this.WEBRTC_VERSION,webRTCRedirector:this.WEBRTC_REDIRECTOR_VERSION,websocketService:this.WEBSOCKET_SERVICE_VERSION,shim:this.VERSION},endpointId:this.ENDPOINT_ID}),this.enumerateDevicesOnConnect?this.enumerateDevices():this.enumerateDevicesOnConnect=!0;else if(e===this.STATE_WS_CONNECTION_FAILED)this.verifyConnectionState([this.STATE_CONNECTING],n),I.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.webSocketUnavailable=!0,this.closeWebSocketConnection(),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t});else if(e===this.STATE_ENDPOINT_UNSUPPORTED)this.verifyConnectionState([this.STATE_CONNECTING],n),I.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!0,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:t});else{if(e!==this.STATE_CONNECTION_FAILED)throw I.error("invalid connectionState: "+e),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+e});this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],n),I.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t})}},verifyConnectionState:function(e,t){var n=!1;void 0==t&&(t=this.connectionState);for(var i in e)if(e[i]===t){n=!0;break}if(!n)throw I.error("invalid connectionState: "+this.connectionState+", expecting: "+e.toString()),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+this.connectionState+", expecting: "+e.toString()})},closeWebSocketConnection:function(){if(null!=this.socket){var e=this.socket;I.debug("disconnected from: "+this.WEBSOCKET_URI),e.removeEventListener("open",this.onWebSocketOpenFunctor,!1),e.removeEventListener("closed",this.onWebSocketClosedFunctor,!1),e.removeEventListener("error",this.onWebSocketErrorFunctor,!1),e.removeEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=null,this.socketConnected=!1,this.socketClosed=!0}this.stopRtcSession(),this.SESSION_ID=void 0},setDebugLevel:function(e){if(e!==this.debugLevel){var t=this.debugLevel;if(this.debugLevel=e,I=0===e?S:1===e?E:y,0===e)window.clearInterval(this.periodicCallbackId),this.periodicCallbackId=null;else if(0===t){var n=this;this.periodicCallbackId=window.setInterval(function(){n.debugPeriodicCallback()},1e3)}}},redirectionSupported:function(){return!this.endpointUnsupported&&!this.webSocketUnavailable},startRtcSession:function(){var e=this;if(!this.endpointUnsupported&&(this.setConnectionState(this.STATE_CONNECTING),void 0==this.SESSION_ID)){var t=msRDCRTC.generateUuid(),n=Date.now().toString(),i=t+"|"+n;new C(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(i).then(function(i){e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"rtcSession",rpcArgs:[t,n,i,e.VERSION]},!0,!0).then(function(i){var r=i[0],o=i[1],c=i[2];void 0!=c&&(e.HOST_OS_VERSION=c.hostOS,e.WEBSOCKET_SERVICE_VERSION=c.websocketService),e.verifyRtcSession(t,n,r,o)}),e.trySendPendingMessages()}),this.registerAppWindowHandle()}},stopRtcSession:function(){this.pendingMessages=[],this.outstandingRpcCalls=new a,this.rtcObjects.forEach(function(e){void 0!=e.disableRedirection&&e.disableRedirection()}),this.connectionState!==this.STATE_NOT_CONNECTED&&this.setConnectionState(this.STATE_NOT_CONNECTED)},verifyRtcSession:function(e,t,n,i){var r=this;this.verifyConnectionState([this.STATE_CONNECTING]);var o=e+"|"+t+"|"+n;new C(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(o).then(function(e){e===i?(r.rtcSessionStarted=!0,r.trySendPendingMessages()):r.setConnectionState(r.STATE_WS_CONNECTION_FAILED,"WebSocket connection failed due to hash mismatch")})},getConfiguration:function(){var e=this;return new Promise(function(t,n){window.getWVDConfig().then(function(i){I.debug("config="+i);var r=JSON.parse(i);void 0!=r.port&&void 0!=r.key||n(new Error("invalid WVD config")),e.WEBSOCKET_PORT=r.port,e.WEBSOCKET_URI=e.WEBSOCKET_URI_BASE+":"+e.WEBSOCKET_PORT,e.WEBSOCKET_KEY=r.key,t()}).catch(function(e){n(e)})})},registerAppWindowHandle:function(){var e=this;window.getWindowHandleAsHex().then(function(t){t=t.match(/[0-9a-f]{2}/gi).reverse().join(""),I.info("app hwnd="+t),e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"setAppWindow",rpcArgs:[t,e.APP_WINDOW_NAME]})}).catch(function(e){I.error("failed to get the app window - "+e.toString())})},compareVersions:function(e,t){var n=e.match(/^(\d+)\.(\d+)\.(\d+)$/),i=t.match(/^(\d+)\.(\d+)\.(\d+)$/),r=1e8*Number.parseInt(n[1])+1e4*Number.parseInt(n[2])+Number.parseInt(n[3]),o=1e8*Number.parseInt(i[1])+1e4*Number.parseInt(i[2])+Number.parseInt(i[3]);return r==o?0:r<o?1:-1},compareVersionsLowerThan:function(e,t){var n=!0;return void 0!=t&&(n=this.compareVersions(e,t)<0),n},clientVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBSOCKET_SERVICE_VERSION)},compareVersionsGreaterThanOrEqual:function(e,t){var n=!1;return void 0!=t&&(n=this.compareVersions(e,t)>=0),n},clientVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBSOCKET_SERVICE_VERSION)},setVMEventCallback:function(e){this.vmEventCallback=e},newAudioElement:function(e){var t=new R("audio",e);this.rtcObjects.push(t);var n=!1;this.connectionState===this.STATE_CONNECTED&&(t.enableRedirection(),n=!0),I.info("newAudioElement returning "+(n?"":"un")+"shimmed object")},newVideoElement:function(e){var t=this.nextVideoElementId++;e.setAttribute("data-vdi_videoid",t);var n=new R("video",e);this.rtcObjects.push(n);var i=!1;this.connectionState===this.STATE_CONNECTED&&(n.enableRedirection(),i=!0),I.info("newVideoElement returning "+(i?"":"un")+"shimmed object, id="+t)},getNotifyAudio:function(e){var t=this.notifications[e];return void 0==t&&(t={id:e,sinkId:this.defaultSinkId,loop:!1,played:!1},this.notifications[e]=t),t},getNotificationAssetUri:function(e){var t=void 0;return e.match(/^http/i)?t=e:e.match(/[^\/]+$/)&&(t=e.replace(/.*?([^\/]+)$/,this.NOTIFICATION_ASSETS_BASEURI+"/$1")),t},playNotifyAudio:function(e,t){I.debug("playNotifyAudio("+JSON.stringify(arguments)+")");var n=this.getNotifyAudio(e);n.played=!0;var i=this.getNotificationAssetUri(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"playNotifyAudio",rpcArgs:[{audioId:e,uri:i,sinkId:n.sinkId,loop:n.loop}]})},pauseNotifyAudio:function(e){I.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).played&&this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"pauseNotifyAudio",rpcArgs:[{audioId:e}]})},setLoop:function(e,t){I.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).loop=t},setSinkId:function(e,t){I.debug("setSinkId("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).sinkId=t},setDefaultSinkId:function(e){I.debug("setDefaultSinkId("+JSON.stringify(arguments)+")"),this.defaultSinkId=e},addClipRect:function(e){I.info("addClipRect("+JSON.stringify(arguments)+")"),this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"addClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom}]})},removeClipRect:function(e){I.info("removeClipRect("+JSON.stringify(arguments)+")"),this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"removeClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom}]})},createPeerConnection:function(e,t){var n;if(null!=e&&(e=JSON.parse(JSON.stringify(e))),null!=t&&(t=JSON.parse(JSON.stringify(t))),this.redirectionSupported())(n=new f(e,t)).teamsId=this.nextPeerConnectionId++,I.info("createPeerConnection returning shimmed object, id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),this.rtcObjects.push(n);else{(n=new this.actualRTCPeerConnection(e,t)).teamsId=this.nextPeerConnectionId++,I.info("createPeerConnection returning hooked object, id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var i=n.addIceCandidate;n.addIceCandidate=function(){return I.info("addIceCandidate id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),i.apply(n,arguments)};var r=n.createOffer;n.createOffer=function(){return I.info("createOffer id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),r.apply(n,arguments)};var o=n.createAnswer;n.createAnswer=function(){return I.info("createAnswer id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),o.apply(n,arguments)};var c=n.setRemoteDescription;n.setRemoteDescription=function(){return I.info("setRemoteDescription id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),c.apply(n,arguments)};var a=n.setLocalDescription;n.setLocalDescription=function(){return I.info("setLocalDescription id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),a.apply(n,arguments)};var s=n.createDTMFSender;n.createDTMFSender=function(){return I.info("createDTMFSender id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),s.apply(n,arguments)};var d=n.getLocalStreams;n.getLocalStreams=function(){I.info("getLocalStreams id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var e=d.apply(n,arguments);return I.info("VDI Local Streams",e),e};var u=n.getRemoteStreams;n.getRemoteStreams=function(){return I.info("getRemoteStreams id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),u.apply(n,arguments)};var p=n.getStats;n.getStats=function(){return I.info("getStats id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),p.apply(n,arguments)};var h=n.addStream;n.addStream=function(){return I.info("addStream id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),h.apply(n,arguments)};var l=n.addTrackStream;n.addTrack=function(){return I.info("addTrack id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),l.apply(n,arguments)};var v=n.removeStream;n.removeStream=function(){return I.info("removeStream id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),v.apply(n,arguments)};var g=n.getReceivers;n.getReceivers=function(){return I.info("getReceivers id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),g.apply(n,arguments)};var b=n.close;n.close=function(){return I.info("close id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),b.apply(n,arguments)},["onnegotiationneeded","onsignalingstatechange","onaddstream","onremovestream","onicecandidate","oniceconnectionstatechange","onicegatheringstatechange"].forEach(function(e){var t=n[e];n[e]=function(){if(I.info(e+" id="+n.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),t)return t.apply(n,arguments)}})}return n},getUserMedia:function(){return this.mediaDevicesRedirector.getUserMedia.apply(this.mediaDevicesRedirector,arguments)},enumerateDevices:function(){return this.mediaDevicesRedirector.enumerateDevices.apply(this.mediaDevicesRedirector,arguments)},getDisplayMedia:function(){return this.mediaDevicesRedirector.getDisplayMedia.apply(this.mediaDevicesRedirector,arguments)},isFeatureSupported:function(e){var t=!1;return"video"===e?void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.camera||(t=!0):"screenshare"===e&&void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.screenshare&&(t=!0),I.debug("isFeatureSupported("+JSON.stringify(arguments)+") returning: "+t),t},onWebSocketOpen:function(e){I.debug("WebSocket opened"),this.socketConnected=!0,this.trySendPendingMessages()},onWebSocketClosed:function(e){I.debug("WebSocket closed"),this.setConnectionState(this.STATE_NOT_CONNECTED)},onWebSocketError:function(e){I.error("WebSocket error");var t=this.connectionState===this.STATE_CONNECTING?this.STATE_WS_CONNECTION_FAILED:this.STATE_CONNECTION_FAILED,n=this.connectionState===this.STATE_CONNECTING?"WebSocket connection failed":"WebSocket error";this.setConnectionState(t,n)},onWebSocketMessage:function(e){I.debug("onWebSocketMessage");var t=null;try{var n=new String(e.data),i=n.lastIndexOf("}");n=n.substring(0,i+1),t=JSON.parse(n)}catch(t){I.error("failed to parse the JSON string: ["+e.data+"] - "+t.toString())}if(null!=t)try{void 0!=t.rpcCallId?this.onRpcResponse(t):void 0!=t.rpcEventTarget?this.onRpcEventNotification(t):I.error("error: received RPC response with no rpcCallId or rpcEventTarget defined")}catch(t){I.error("failed to handle the WebSocket message: ["+e.data+"] - "+t.toString())}},onSessionInfo:function(e){I.debug("onSessionInfo: "+JSON.stringify(e));var t=e.version;void 0!=t&&(this.CLIENT_OS_VERSION=t.clientOS,this.OOB_CLIENT_VERSION=t.oobClient,this.WEBRTC_VERSION=t.webRTC,this.WEBRTC_REDIRECTOR_VERSION=t.webRTCRedirector,this.ENDPOINT_ID=e.endpointId),this.SESSION_ID=e.sessionId,this.clientFeatures=e.features,void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.microphone?(I.warn("endpoint microphone access is disabled"),this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"endpoint microphone access is disabled")):this.setConnectionState(this.STATE_CONNECTED)},onSessionChange:function(e){var t=e.status;void 0!=t&&(I.debug("onSessionChange: received sessionChange event: "+e.status),"connected"===t?(this.endpointUnsupported=!1,this.connectionState===this.STATE_NOT_CONNECTED&&this.startRtcSession()):"disconnected"===t&&this.stopRtcSession())},onRpcResponse:function(e){0===e.hr?I.debug("onRpcResponse: "+JSON.stringify(e)):I.error("onRpcResponse - ERROR: "+JSON.stringify(e));var t=e.rpcCallId,n=this.outstandingRpcCalls[t];if(void 0!=n){n.stats.completed=performance.now();var i=n.stats.completed-n.stats.started;(i>=1e3?I.warn:I.debug)('"rpcCallId":'+t+" took "+i.toFixed(4)+" ms"),delete this.outstandingRpcCalls[t],n.onRpcResponse(e)}else I.error("error: received RPC response with unexpected rpcCallId: "+t)},onRpcEventNotification:function(e){if(0===e.hr?I.debug("onRpcEventNotification: "+JSON.stringify(e)):I.error("onRpcEventNotification - ERROR: "+JSON.stringify(e)),void 0!=e.rpcEventTarget)if(void 0!=e.rpcEventTarget.rpcObjectType)if(void 0!=e.rpcEventName){var t=!1;"RDWebRTCRedirector"===e.rpcEventTarget.rpcObjectType?t=this.handleRpcEventNotification(e):this.rtcObjects.forEach(function(n){void 0!=n.onRpcEventNotification&&n.onRpcEventNotification(e)&&(t=!0)}),t||I.warn("warning - received RPC event notification but no objects handled the event")}else I.error("error: received RPC event notification with no rpcEventName defined");else I.error("error: received RPC event notification with no rpcEventTarget.rpcObjectType defined");else I.error("error: received RPC event notification with no rpcEventTarget defined")},handleRpcEventNotification:function(e){var t=!0,n=e.rpcEventName;return"sessioninfo"===n?this.onSessionInfo(e.rpcEventArgs):"sessionchange"===n?this.onSessionChange(e.rpcEventArgs):"virtualchannelerror"===n?this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"virtual channel connection failed: hr="+s(e.hr)):"error"===n?this.setConnectionState(this.STATE_CONNECTION_FAILED,"hr="+s(e.hr)):t=!1,t},sendWebSocketMessage:function(e,t){if(this.socketConnected&&(this.rtcSessionStarted||this.isSessionHandshakeMessage(e))){var n="close"===e;if(!n||!this.socketClosed){I.debug("Sending... "+e);try{this.socket.send(e),this.socketClosed=n}catch(e){I.error("failed to send WebSocket message - "+e.toString()),this.setConnectionState(this.STATE_NOT_CONNECTED)}}}else t?this.pendingMessages.unshift(e):this.pendingMessages.push(e)},isSessionHandshakeMessage:function(e){var t=JSON.parse(e);return"RDWebRTCRedirector"===t.rpcObjectType&&"rtcSession"===t.rpcName},trySendPendingMessages:function(){if(this.socketConnected)for(;;){var e=this.pendingMessages.shift();if(void 0==e)break;if(!this.rtcSessionStarted&&!this.isSessionHandshakeMessage(e)){this.pendingMessages.unshift(e);break}this.sendWebSocketMessage(e)}},getNextRpcObjectId:function(){return this.nextRpcObjectId++},getNextOperationId:function(){return this.nextOperationId++},generateUuid:function(){for(var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t=null;;)if(t=e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e(),void 0==this.uniqueIds[t]){this.uniqueIds[t]=!0;break}return t},makeRpcCall:function(e,t,n,i){var r=this.nextRpcCallId++;e.rpcCallId=r;var o=e.rpcArgs,c=!0;for(var a in o)if(void 0!=o[a]){c=!1;break}if(c&&(e.rpcArgs=[]),i){for(var d=[];;){var u=this.pendingMessages.shift();if(void 0==u)break;var p=JSON.parse(u);p.rpcObjectId===e.rpcObjectId&&p.rpcName===e.rpcName?I.debug("Dropping superceded RPC call: "+u):d.push(u)}this.pendingMessages=d}var h=JSON.stringify(e);this.sendWebSocketMessage(h,n);var l;return void 0==t||t?(e.stats={started:performance.now()},l=new Promise(function(t,n){e.onRpcResponse=function(e){0===e.hr?t(e.result):n(new Error("RPC call failed with hr="+s(e.hr)))}}),this.outstandingRpcCalls[r]=e):l=new Promise(function(e,t){e()}),l},disconnectAllCalls:function(){this.notifyVmEventCallback({event:"vdiClientDisconnected",request:"endCalls"})},notifyVmEventCallback:function(e){I.info("notifyVmEventCallback event="+JSON.stringify(e)),void 0!=this.vmEventCallback&&this.vmEventCallback(e)},debugPeriodicCallback:function(){this.rtcObjects.forEach(function(e){void 0!=e.debugPeriodicCallback&&e.debugPeriodicCallback()})}},msRDCRTC=new O,{init:function(){return msRDCRTC.init.apply(msRDCRTC,arguments)},setVMEventCallback:function(){return msRDCRTC.setVMEventCallback.apply(msRDCRTC,arguments)},newAudioElement:function(){return msRDCRTC.newAudioElement.apply(msRDCRTC,arguments)},newVideoElement:function(){return msRDCRTC.newVideoElement.apply(msRDCRTC,arguments)},playNotifyAudio:function(){return msRDCRTC.playNotifyAudio.apply(msRDCRTC,arguments)},pauseNotifyAudio:function(){return msRDCRTC.pauseNotifyAudio.apply(msRDCRTC,arguments)},setLoop:function(){return msRDCRTC.setLoop.apply(msRDCRTC,arguments)},setSinkId:function(){return msRDCRTC.setSinkId.apply(msRDCRTC,arguments)},setDefaultSinkId:function(){return msRDCRTC.setDefaultSinkId.apply(msRDCRTC,arguments)},addClipRect:function(){return msRDCRTC.addClipRect.apply(msRDCRTC,arguments)},removeClipRect:function(){return msRDCRTC.removeClipRect.apply(msRDCRTC,arguments)},createPeerConnection:function(){return msRDCRTC.createPeerConnection.apply(msRDCRTC,arguments)},getUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},mediaDevicesGetUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},enumerateDevicesShim:function(){return msRDCRTC.enumerateDevices.apply(msRDCRTC,arguments)},getDisplayMediaShim:function(){return msRDCRTC.getDisplayMedia.apply(msRDCRTC,arguments)},isFeatureSupported:function(){return msRDCRTC.isFeatureSupported.apply(msRDCRTC,arguments)}}});
//# sourceMappingURL=https://statics.teams.cdn.office.net/hashedjs/vdiWVDPeerConnection.js-4c791d25.map