webpackJsonp([14],{2221:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(2222),n(2226),n(2230)},2222:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(2223),i=n(2225),o=function(){function e(e,t,n,r,i,o){this.loggingService=e,this.$window=t,this.constants=n,this.utilityService=r,this.desktopUtilityService=i,this.eventingService=o,this.logger=e.newLogger("ExperienceContainerFactory")}return e.$inject=["loggingService","$window","constants","utilityService","desktopUtilityService","eventingService"],e.prototype.generateContainerId=function(){return"experience-renderer-"+this.utilityService.generateUUID()},e.prototype.create=function(e){this.logger.log("creating experience container");var t=this.generateContainerId(),n=this.desktopUtilityService.isElectron(),o=this.loggingService.findScenario(this.constants.experienceContainers.scenarios.init);o&&o.mark(this.constants.experienceContainers.step.ecfCreate,{isElectron:n});var a=/^https:\/\/local.teams.office.com/.test(e.url);return this.loggingService.setContext("experienceContainerMode",a?"development":"production"),n?(this.logger.info("Creating WebView experience container: "+t,e),new i.WebViewExperienceContainer(this.loggingService,t,e,this.$window,this.constants,this.eventingService)):(this.logger.info("Creating IFrame experience container: "+t,e),new r.IframeExperienceContainer(this.loggingService,t,e,this.$window,this.constants))},e}();t.ExperienceContainerFactory=o,angular.module("teamspace.experienceContainerFactory",["teamspace.loggingService","teamspace.constants","teamspace.utilityService","teamspace.desktopUtilityService"]).service("experienceContainerFactory",o)},2223:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=n(55),a=function(e){function t(t,n,r,i,o){var a=e.call(this,t.newLogger("IframeExperienceContainer"),n,r,o,i)||this,s=new URL(r.url);return a.origin=s.origin,a}return r(t,e),t.prototype.createElement=function(e){var t=this,n=o.htmlFactory.createIframe(this.elementId);return n.src=e,n.setAttribute("class","embedded-electron-webview embedded-page-content"),this.$window.addEventListener("message",function(e){var r=e.source,i=e.origin,o=e.data,a=o.channel,s=o.payload;r===n.contentWindow&&i===t.origin&&a===t.constants.multiWindow.channel&&s&&t.publish(s.eventId,s.payload)}),n},t.prototype.appendTo=function(t){var n=this;return this.element?new Promise(function(r){n.updateTMPStorageSettings(),r(e.prototype.appendTo.call(n,t))}):Promise.reject("unable to mount")},t.prototype.updateTMPStorageSettings=function(){var e=JSON.parse(this.$window.localStorage.getItem("tmp.settings")),t=this.params.settings.hostSettings,n=e&&e.core||{},r=e&&e.host||{},o=t&&t.core||{};e=JSON.stringify(i({},e,{core:i({},n,o),host:i({},r,o)})),this.$window.localStorage.setItem("tmp.settings",e)},t.prototype._sendCommand=function(e){var t=i({},e,{channel:this.constants.multiWindow.channel,metaData:{destination:{channel:e.eventId}}});this.element.contentWindow.postMessage(t,this.origin)},t}(n(224).ExperienceContainer);t.IframeExperienceContainer=a},2224:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.logger=e,this.handlers=new Map}return e.prototype.publish=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=this.handlers.get(e)||[];this.logger.debug("Publishing event "+e+" to "+i.length+" subscribers with following args",n),i.forEach(function(e){try{e.apply(void 0,n)}catch(e){t.logger.warn("Unable to publish event to handler because it threw the following error: "+e)}})},e.prototype.addEventListener=function(e,t){var n=this.handlers.get(e)||[];n.push(t),this.handlers.set(e,n)},e.prototype.removeEventListener=function(e,t){var n=this.handlers.get(e)||[];n=n.filter(function(e){return e!==t}),this.handlers.set(e,n)},e}();t.EventPublisher=r},2225:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(56),o=n(55),a=function(e){function t(t,n,r,i,o,a){var s=e.call(this,t.newLogger("WebViewExperienceContainer"),n,r,o,i)||this;return s.eventingService=a,s}return r(t,e),t.prototype.createElement=function(e){var t=this;try{var n=o.htmlFactory.createWebView(this.elementId);return n.src=e,n.setAttribute("class","embedded-electron-webview embedded-page-content"),n.setAttribute("webpreferences","nativeWindowOpen=yes, sandbox=yes"),n.setAttribute("allowpopups",""),n.addEventListener("ipc-message",function(e){if(e.channel===t.constants.experienceContainers.channel){var n=e.args&&e.args[0];if(!n)return void t.logger.error("Invalid webview ipc-message - received no args.");if(n.requestRendererId=t.elementId,t.publish("message",n),n.eventId){if(n.eventId===i.ChildWindowEventRequest.ExperienceStarted){var r=n.payload&&n.payload.message;t.logger.info("ExperienceStarted:"+r)}n.eventId===i.ChildWindowEventRequest.CommandStep&&t._handleCommandStepEvent(n),n.eventId===i.ChildWindowEventRequest.CommandComplete&&t._handleCommandCompleteEvent(n),t.publish(n.eventId,n.payload)}}}),n.addEventListener("crashed",function(){t.logger.error("Experience container with Id "+t.elementId+" has crashed"),t.eventingService.$emit(t.constants.events.experienceContainers.crashed,{id:t.elementId}),t.publish("crashed")}),n.addEventListener("did-fail-load",function(e){t.logger.error("Experience container with Id "+t.elementId+" failed to load. Url="+t.params.url+" Error="+e.errorDescription+" ("+e.errorCode+")"),t.publish("failed-to-load",e)}),n.addEventListener("did-navigate",function(e){t.logger.info("Experience container with Id "+t.elementId+" did navigate with "+e.httpResponseCode+". Url="+t.params.url)}),n.addEventListener("did-frame-navigate",function(e){t.logger.info("Experience container with Id "+t.elementId+" did frame navigate with "+e.httpResponseCode+". Url="+t.params.url)}),n.addEventListener("plugin-crashed",function(e){t.logger.error("Experience container with Id "+t.elementId+" plugin crashed. Url="+t.params.url)}),n}catch(e){this.logger.error("Experience container with Id "+this.elementId+" loading exception: "+e);var r=this.logger.service.findScenario(this.constants.experienceContainers.scenarios.init);throw r&&r.fail({reason:this.constants.experienceContainers.reason.webViewEcCreateElementFailed}),e}},t.prototype.appendTo=function(t){var n=this;return this.element?new Promise(function(r){var i={enablePreload:!0,isExperienceRenderer:!0,rendererContext:JSON.stringify(n.params.settings||{})};n.$window.electronSafeIpc.send(n.constants.events.desktopApp.allowWebViewCreate,i),n.$window.electronSafeIpc.once(n.constants.events.desktopApp.webViewCreationEnabled,function(){n.logger.info("Received webViewCreationEnabled event, Appending webview element to the page"),r(e.prototype.appendTo.call(n,t).catch(function(e){return n.logger.warn("Failed to append webview element to the page: "+e)}))})}):Promise.reject(this.constants.experienceContainers.reason.ecAppendToError)},t.prototype._sendCommand=function(e){this.element.send(this.constants.experienceContainers.channel,e)},t.prototype._handleCommandStepEvent=function(e){var t=e.payload,n=t.correlationId,r=t.step,i=this.logger.service.findScenarioByNameAndId(this.constants.multiWindow.scenario.enqueueEntityCommand,n);this.logger.log("Command with id "+n+" reported step "+r),i&&i.appendEventData({previousStep:r})},t.prototype._handleCommandCompleteEvent=function(e){var t=e.payload,n=t.correlationId,r=t.commandStatus,i=t.errorInfo,o=this.logger.service.findScenarioByNameAndId(this.constants.multiWindow.scenario.enqueueEntityCommand,n);o?(this.logger.log("Command with id "+n+" reported complete with status "+r),"Failure"===r?o.fail({reason:r,errorInfo:i}):o.stop({reason:r})):this.logger.warn("Received commandComplete event, but could not find a corresponding scenario")},t}(n(224).ExperienceContainer);t.WebViewExperienceContainer=a},2226:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=n(55),a=n(2227),s=n(2228),c=function(e){function t(t,n,r,o,s,c,p,d,l,u){var h=e.call(this,t)||this;return h.loggingService=n,h.experienceContainerFactory=r,h.constants=o,h.desktopUtilityService=s,h.settingsService=c,h.experienceContainerFeatureService=p,h.experienceContainerCdlCommunicator=d,h.$window=l,h.containers=new Map,h.recreateAttempts=0,h.lastRecreatedTime=0,h.onTearDown=function(e,t){if(h.logger.warn("Tearing down "+e.experienceContainer.elementId+" because it has "+t.reason+"."),h.settingsService.valueAsBoolean(h.constants.settings.names.enableAutoBRBforERCrashes)&&e.params&&e.params.url&&e.params.url.includes("teams.microsoft.com/")&&"crashed"===t.reason&&0===h.recreateAttempts&&h.logger.error("MultiWindow ExperienceRenderer Crashed or Failed to Load, so triggering AutoBRB"),h.remove(e,t),h.shouldRecreate(e,t)){var n=h.loggingService.findScenario(h.constants.experienceContainers.scenarios.init);n&&n.mark(h.constants.experienceContainers.step.ecmOnTearDownRecreate,i({recreateAttempts:h.recreateAttempts,reason:t.reason},t.data)),h.lastRecreatedTime=Date.now(),h.register(e.params)}else h.markTearDownScenario(t)},h.mountElement=h.createAndMountElement(),h.serviceWrapper=new a.ServiceWrapper(o,u,l,p),h.serviceWrapper.initialize(),h.logger=n.newLogger("ExperienceContainerManager"),h.initializeOnAppLaunchAndReinit("constructor"),l.addEventListener("unload",function(){h.cleanupOnAppTeardown("shutdown"),n.flush()}),h}return r(t,e),t.$inject=["orchestrationService","loggingService","experienceContainerFactory","constants","desktopUtilityService","settingsService","experienceContainerFeatureService","experienceContainerCdlCommunicator","$window","$injector"],t.prototype.mtmaTelemetryIdentifier=function(){return"ExperienceContainerManager"},t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this,n=this.loggingService.findScenario(this.constants.experienceContainers.scenarios.init);if(this.isEnabled())try{var r=this.settingsService.valueAsObject(this.constants.settings.names.experienceContainers);Object.keys(r).forEach(function(e){var i=r[e];t.logger.info("Registering '"+e+"' experience container with options: {0}",i),n&&n.mark(t.constants.experienceContainers.step.ecmAppLaunchRegister,{reason:JSON.stringify(i),config:e}),t.register(t.getDefaultContainerParams(i))})}catch(e){this.logger.error("Failed to initialize some containers",e),n&&n.fail({reason:this.constants.experienceContainers.reason.ecmAppLaunchFailed})}else n&&n.fail({reason:this.constants.experienceContainers.reason.notEnabledDuringEcmAppLaunch})},t.prototype.cleanupOnAppTeardown=function(e){for(;this.containers.size>0;){var t=this.containers.entries().next().value,n=t[0],r=t[1];s.isContainerFactory(r)||(this.remove(r,{reason:e}),this.markTearDownScenario({reason:e})),this.containers.delete(n)}this.recreateAttempts=0,this.lastRecreatedTime=0,"shutdown"===e&&(this.onReadyCallback=void 0)},Object.defineProperty(t.prototype,"isReady",{get:function(){var e=this.getContainerEntry("multi-window");return!(!e||!e.isReady)},enumerable:!0,configurable:!0}),t.prototype.onReady=function(e){this.onReadyCallback=e;var t=this.getContainerEntry("multi-window");t?t.onReady(e):this.logger.warn("Registration for onReady callback arrived when container entry is undefined")},t.prototype.nudge=function(){this.logger.info("Received a nudge to recreate the experience container");var e=this.getContainerEntry("multi-window");e||(this.recreateAttempts=0,this.initializeOnAppLaunchAndReinit("nudge")),(e=this.getContainerEntry("multi-window"))||this.logger.error("The nudge attempt failed to recreate the experience container.")},t.prototype.collectLogs=function(){var e=this.getContainerEntry("multi-window");return e?e.collectLogs():Promise.resolve([])},t.prototype.isEnabled=function(){return this.experienceContainerFeatureService.isExperienceContainerSupportEnabled()},t.prototype.getDefaultContainerParams=function(e){var t=this.desktopUtilityService.isElectron()?"electron":"web",n=new URL(e.baseUrl);n.searchParams.append("agent",t);var r=this.$window.desktopSettings&&this.$window.desktopSettings.experienceRendererBuildContainer;return r?n.searchParams.append("container",r):n.searchParams.append("version",this.getVersion()),{url:n.href,types:e.types}},t.prototype.getDefaultContainerSettings=function(e){return{windowId:"northstarCore",hostSettings:this.serviceWrapper.getHostSettings({timeOpened:Date.now(),content:{id:e,metaData:{}}}),perfMarkers:{windowCreateTimeFromMainRenderer:Date.now()},loadUrl:e}},t.prototype.getVersion=function(){return this.settingsService.getOrbitalVersion(this.constants.settings.orbitals.multiWindow)},t.prototype.register=function(e){var t=this;e.types.forEach(function(n){return t.containers.set(n,t.createContainerFactory(e))})},t.prototype.getContainerEntry=function(e){var t=this.isEnabled()&&this.containers.get(e);if(t)return s.isContainerFactory(t)&&(t=t.factory()),t;this.recreateAttempts<2&&this.logger.error("Unknown container type '"+e+"'. You need to call register first.")},t.prototype.get=function(e){var t=this.getContainerEntry(e);return t&&t.experienceContainer},t.prototype.getUiHandle=function(e){var t=this.getContainerEntry(e);return t&&t.outerWrap},t.prototype.createContainerFactory=function(e){var t=this;return{factory:function(){try{e.settings=t.getDefaultContainerSettings(e.url);var n=t.createContainerEntry(e);return t.add(n),n}catch(n){throw t.logger.error("Failed to create container entry",n,e),n}}}},t.prototype.createContainerEntry=function(e){return this.markCreateNewScenario(),new s.ContainerEntry(e,this.experienceContainerFactory,this.loggingService,this.serviceWrapper,this.experienceContainerCdlCommunicator,this.onTearDown,this.constants,this.$window,this.logger)},t.prototype.add=function(e){var t=this;this.logger.info("Adding EC '"+e.experienceContainer.elementId+"'"),e.params.types.forEach(function(n){return t.containers.set(n,e)}),this.mountElement.appendChild(e.outerWrap),e.params.types.includes("multi-window")&&this.onReadyCallback&&e.onReady(this.onReadyCallback)},t.prototype.remove=function(e,t){var n=this;this.logger.info("Removing EC '"+e.experienceContainer.elementId+"' with reason='"+t.reason+"'"),this.mountElement.removeChild(e.outerWrap),this.experienceContainerCdlCommunicator&&this.experienceContainerCdlCommunicator.teardown(e.experienceContainer.elementId),e.params.types.forEach(function(e){return n.containers.delete(e)})},t.prototype.shouldRecreate=function(e,t){var n=0;return"reloaded"===t.reason?(this.logger.info("Attempting to recreate the experience container after unloading."),!0):(n=Date.now()-this.lastRecreatedTime)>18e4?(this.logger.info("Attempting to recreate the experience container because the last attempt was made "+n+" ms ago, which is beyond the recreate limit time window: 180000 ms."),this.recreateAttempts=0,!0):this.recreateAttempts++<2?(this.logger.info("Attempting to recreate the experience container. Attempt #"+this.recreateAttempts+"."),!0):(this.logger.error("Maximum retries hit. Not attempting to recreate the experience container."),!1)},t.prototype.markCreateNewScenario=function(){var e=this.constants.experienceContainers.scenarios.createNew;this.loggingService.newScenario(e).stop()},t.prototype.markTearDownScenario=function(e){var t=e.data,n=e.reason,r=this.loggingService.findScenario(this.constants.experienceContainers.scenarios.init)||this.loggingService.newScenario(this.constants.experienceContainers.scenarios.tearDown);s.isTearDownDueToFailure(e)?r&&r.fail(i({reason:n,errorCode:n,retryAttempt:this.recreateAttempts},t)):r&&r.stop(i({reason:n,retryAttempt:this.recreateAttempts},t))},t.prototype.createAndMountElement=function(){var e=o.htmlFactory.createDiv("ExperienceContainerManagerMountElement");return e.setAttribute("class","experience-containers-root"),document.body.appendChild(e),e},t}(teamspace.services.MTMABase);t.ExperienceContainerManager=c,angular.module("teamspace.experienceContainerManager",["teamspace.orchestrationService","teamspace.loggingService","teamspace.experienceContainerFactory","teamspace.constants","teamspace.desktopUtilityService","teamspace.settingsService","teamspace.experienceContainerFeatureService","teamspace.experienceContainerCdlCommunicator"]).service("experienceContainerManager",c)},2227:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t,n,r,i){var o=e.call(this,t,n,r)||this;return o.experienceContainerFeatureService=i,o}return r(t,e),t.prototype.getHostSettings=function(t){var n={core:{enableMultiWindowV2:this.experienceContainerFeatureService.isExperienceContainerSupportEnabled()}},r=e.prototype.getHostSettings.call(this,t);try{r.default=i({},r.default)}catch(e){}return i({},r,n)},t}(n(215).AngularServiceWrapper);t.ServiceWrapper=o},2228:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(56),i=n(2229),o=n(55);t.isTearDownDueToFailure=function(e){var t=e.reason;return"crashed"===t||"failed-to-load"===t},t.isContainerFactory=function(e){return!!e.factory};var a=function(){function e(e,t,n,a,s,c,p,d,l){var u=this;this.params=e,this.experienceContainerFactory=t,this.loggingService=n,this.serviceWrapper=a,this.cdlCommunicator=s,this.onTearDownCallback=c,this.constants=p,this.$window=d,this.logger=l,this.onTearDown=function(e,t){u._isReady=!1,u.tearDownListeners(),u.shellCommWrapper.tearDown(),u.onTearDownCallback(u,{data:t,reason:e})},this.onCrashed=function(){return u.onTearDown("crashed")},this.onFailedToLoad=function(e){return u.onTearDown("failed-to-load",e&&{errorDescription:e.errorDescription,statusCode:e.errorCode})},this.onReloaded=function(){return u.onTearDown("reloaded")},this.onCdlRequest=function(e){u.cdlCommunicator?e?u.cdlCommunicator.sendDataLayerRequest(e,u.experienceContainer.sendCommand):u.logger.error("Error in processing data layer request: Data layer request is undefined."):u.logger.error("Error in processing data layer request: Cdl communicator is unavailable.")},this.onCoreInitialized=function(){u.logger.info("Experience Container Core Initailized");var e=u.logger.service.findScenario(u.constants.experienceContainers.scenarios.init);e&&e.stop({reason:r.ChildWindowEventRequest.CoreInitialized}),u._isReady=!0,u.onReadyCallback?u.onReadyCallback():u.logger.error("onReady callback is not registered to the container entry")},this._isReady=!1;var h=t.create(e);this.experienceContainer=h,this.setupListeners(),this.outerWrap=o.htmlFactory.createDiv("ExperienceContainerWrap-"+h.elementId),this.shellCommWrapper=new i.ShellCommWrapper(h,n,a),this.outerWrap.setAttribute("class","hidden");var g=n.findScenario(p.experienceContainers.scenarios.init);h.appendTo(this.outerWrap).then(function(){g&&g.mark(p.experienceContainers.step.constructContainerEntry)}).catch(function(e){l.error("Failed to append experience container to wrapper",e),g&&g.fail({reason:p.experienceContainers.reason.constructContainerEntryFailed})})}return Object.defineProperty(e.prototype,"isReady",{get:function(){return this._isReady},enumerable:!0,configurable:!0}),e.prototype.onReady=function(e){this.onReadyCallback=e},e.prototype.collectLogs=function(){var e=this;return new Promise(function(t,n){var i=e.constants.timeInMiliseconds.second,o=r.ChildWindowEventRequest.GetLogs,a={eventId:o},s=0,c=function(n){e.experienceContainer.removeEventListener(o,c),e.$window.clearTimeout(s),t(n&&n.logs||[])};s=e.$window.setTimeout(function(){var t="Request to gather logs from experience container timed out after "+i+" milli seconds.";e.logger.error(t),e.experienceContainer.removeEventListener(o,c),n(t)},i),e.experienceContainer.addEventListener(o,c),e.experienceContainer.sendCommand(a)})},e.prototype.setupListeners=function(){this.experienceContainer.addEventListener("crashed",this.onCrashed),this.experienceContainer.addEventListener("failed-to-load",this.onFailedToLoad),this.experienceContainer.addEventListener(r.ChildWindowEventRequest.WindowUnloaded,this.onReloaded),this.experienceContainer.addEventListener(r.ChildWindowEventRequest.CentralDataLayerRequest,this.onCdlRequest),this.experienceContainer.addEventListener(r.ChildWindowEventRequest.CoreInitialized,this.onCoreInitialized)},e.prototype.tearDownListeners=function(){this.experienceContainer.removeEventListener("crashed",this.onCrashed),this.experienceContainer.removeEventListener("failed-to-load",this.onFailedToLoad),this.experienceContainer.removeEventListener(r.ChildWindowEventRequest.WindowUnloaded,this.onReloaded),this.experienceContainer.removeEventListener(r.ChildWindowEventRequest.CentralDataLayerRequest,this.onCdlRequest),this.experienceContainer.removeEventListener(r.ChildWindowEventRequest.CoreInitialized,this.onCoreInitialized)},e}();t.ContainerEntry=a},2229:function(e,t,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=n(56),o=teamspace.services.ApplicationState,a=function(){function e(e,t,n){var r=this;this.experienceContainer=e,this.serviceWrapper=n,this.messageHandler=function(e){var t=function(e){r.experienceContainer.sendCommand(e)};switch(e.eventId){case i.ChildWindowEventRequest.AadGetToken:r.handleAadGetToken(e,t);break;case i.ChildWindowEventRequest.AadGetCurrentUser:r.handleAadGetCurrentUser(e,t);break;case i.ChildWindowEventRequest.GetStateData:r.handleGetStateData(e,t);break;case i.ChildWindowEventRequest.RequestShellToOpen:r.handleRequestShellToOpen(e,t);break;case i.ChildWindowEventRequest.UpdateWindowState:r.handleUpdateWindowState(e);break;case i.ChildWindowEventRequest.ScreenSharingControlMessage:r.handleScreenSharingControlMessage(e);break;case i.ChildWindowEventRequest.WindowCrashed:case"windowErrored":r.handleWindowErrored(e)}},e.addEventListener("message",this.messageHandler),this.logger=t.newLogger("MWv2::ShellCommWrapper")}return e.prototype.tearDown=function(){this.experienceContainer.removeEventListener("message",this.messageHandler)},e.prototype.handleAadGetToken=function(e,t){var n=this;this.serviceWrapper.getAadToken(e.payload.resource,e.payload.claim?e.payload.claim:void 0).then(function(t){return n.buildResponse(e,{token:t})}).then(t).catch(function(e){return n.logger.error("Failed to handle AAD token",e)})},e.prototype.handleAadGetCurrentUser=function(e,t){var n=this;this.serviceWrapper.getAuthUser().then(function(t){return n.buildResponse(e,{authUser:t})}).then(t).catch(function(e){return n.logger.error("Failed to handle AadGetCurrentUser",e)})},e.prototype.handleGetStateData=function(e,t){var n,r=this;switch(e.payload.requestType){case"skypeToken":n=this.serviceWrapper.getSkypeToken().then(function(e){return{skypeTokenData:e}});break;case"hostSettings":n=Promise.resolve({hostSettings:this.serviceWrapper.getHostSettings({})})}n.then(function(t){return r.buildResponse(e,t)}).then(t).catch(function(e){return r.logger.error("Failed to handle GetStateData",e)})},e.prototype.handleRequestShellToOpen=function(e,t){var n=this;if(e){var r=void 0,i=e.payload.openType,o=e.payload.openHandler,a=e.payload.handlerParams;if(i&&o)switch(i){case teamspace.services.OpenType.OpenOnMainRenderer:r=Promise.resolve({opened:this.serviceWrapper.navigateMainWindow(o,a)});break;case teamspace.services.OpenType.OpenInNewChildWindow:r=Promise.resolve({opened:this.serviceWrapper.openWindow(o,a)});break;case teamspace.services.OpenType.OpenInNewChildWindowFallBackToMain:r=new Promise(function(e){var t=n.serviceWrapper.openWindow(o,a);return e(t?{opened:t}:{opened:n.serviceWrapper.navigateMainWindow(o,a)})})}r.then(function(t){return n.buildResponse(e,t)}).then(t).catch(function(e){return n.logger.error("Failed to handle RequestShellToOpen",e)})}},e.prototype.handleScreenSharingControlMessage=function(e){e&&e.payload&&this.serviceWrapper.sendScreenSharingControlMessage(e.payload)},e.prototype.handleUpdateWindowState=function(e){if(e&&e.payload&&e.payload.childSettings&&e.payload.childSettings.appState){var t=e.payload.childSettings.appState;t!==o.Interactive&&t!==o.InCall||this.serviceWrapper.emitMessage("IdleEnd")}},e.prototype.handleWindowErrored=function(e){var t=this,n=e.payload||{},r=n.errorMsg;if(n.showOops){var i=n.logs&&Array.isArray(n.logs)&&n.logs.length>0,o=i?"\nLogs emitted for a child window error:\n":"";this.logger.warn("Child window has hit an unrecovered errored state: errorMsg="+r+", errorCode="+n.errorCode+"."+o),n.errorStack&&this.logger.warn("Error Stack: "+n.errorStack),i&&n.logs.forEach(function(e){t.logger.warn(e.timeStamp+" "+e.levelName+" - "+e.message)})}},e.prototype.buildResponse=function(e,t){return r({},e,{payload:t||{}})},e}();t.ShellCommWrapper=a},2230:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=n(56),o=n(2231),a=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.experienceContainerManager=n,o.experienceContainerFeatureService=r,o.$window=i,o.initializeOnAppLaunchAndReinit("constructor"),o}return r(t,e),t.$inject=["orchestrationService","experienceContainerManager","experienceContainerFeatureService","$window"],Object.defineProperty(t.prototype,"experienceContainer",{get:function(){return this.experienceContainerManager.get("hybrid-app")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"experienceUiWrap",{get:function(){return this.experienceContainerManager.getUiHandle("hybrid-app")},enumerable:!0,configurable:!0}),t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.isEnabled()&&(this.resizeObserver=new ResizeObserver(function(e){var n=e[0].contentRect;t.resizeUtil.setSize(n)}),this.resizeUtil=new o.HybridAppResizeUtil,this.startResizeAnimation(this.experienceUiWrap))},t.prototype.mtmaTelemetryIdentifier=function(){return"HybridAppService"},t.prototype.cleanupOnAppTeardown=function(e){this.resizeUtil=void 0,this.resizeSampleElement=void 0,this.isHidden=!0,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=void 0)},Object.defineProperty(t.prototype,"isReady",{get:function(){return this.experienceContainerManager.isReady},enumerable:!0,configurable:!0}),t.prototype.onReady=function(e){return this.experienceContainerManager.onReady(e)},t.prototype.collectLogs=function(){return this.experienceContainerManager.collectLogs()},t.prototype.setSettings=function(e){this.sendMessage(e)},t.prototype.setTheme=function(e){this.sendMessage({hostSettings:{theme:e}})},t.prototype.setAppState=function(e){this.sendMessage({hostSettings:{appState:e}})},t.prototype.setLocale=function(e){this.sendMessage({hostSettings:{localeCode:e}})},t.prototype.nudge=function(){this.experienceContainerManager.nudge()},t.prototype.sendCommand=function(e){return this.showCommand(e)},t.prototype.show=function(e,t,n){if(void 0===n&&(n=!0),!this.isEnabled())return Promise.reject("Hybrid app service is disabled. Unable to show the provided command - "+JSON.stringify(e));var r=Promise.resolve();return this.isHidden=!1,r=n?this.showCommand(e):Promise.resolve(),this.experienceUiWrap.setAttribute("class","visible overlay"),this.resizeSampleElement&&this.resizeSampleElement===t||(this.resizeSampleElement&&this.resizeObserver.disconnect(),this.resizeSampleElement=t,t&&this.resizeObserver.observe(t)),r},t.prototype.hide=function(){this.resizeSampleElement=void 0,this.isHidden=!0,this.experienceUiWrap.setAttribute("class","hidden"),this.resizeObserver.disconnect()},t.prototype.isEnabled=function(){return this.experienceContainer&&this.experienceContainerFeatureService.isExperienceContainerSupportEnabled()},t.prototype.showCommand=function(e){var t={eventId:"executeEntityCommand",payload:{entity:e.entity,command:e.command}};return this.experienceContainer.sendCommand(t),Promise.resolve()},t.prototype.startResizeAnimation=function(e){var t=this,n=$(e),r=function(e){if(t.isEnabled()&&!t.isHidden){var i=t.resizeUtil.getElementStyle(e);n.css(i)}t.$window.requestAnimationFrame(r)};this.$window.requestAnimationFrame(r)},t.prototype.sendMessage=function(e){if(this.experienceContainer){var t={eventId:i.ChildWindowEventRequest.UpdateWindowState,payload:e};this.experienceContainer.sendCommand(t)}},t}(teamspace.services.MTMABase);t.HybridAppService=a,angular.module("teamspace.hybridAppServiceLazy",["teamspace.orchestrationService","teamspace.experienceContainerManager","teamspace.experienceContainerFeatureService"]).service("hybridAppServiceLazy",a)},2231:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.lastResizeTimestamp=0,this.RESIZE_INTERVAL=200}return e.prototype.setSize=function(e){this.height=e.height,this.width=e.width},e.prototype.getElementStyle=function(e){var t=this.getSize(),n=t.width,r=t.height,i=this.lastSetHeight!==n||this.lastSetWidth!==r,o=e-this.lastResizeTimestamp;return i?o>=this.RESIZE_INTERVAL?(this.lastSetHeight=r,this.lastSetWidth=n,this.lastResizeTimestamp=e,{transform:"none",width:n+"px",height:r+"px"}):{transform:"scale("+n/this.lastSetWidth+","+r/this.lastSetHeight+")"}:{transform:"none"}},e.prototype.getSize=function(){return{width:this.width,height:this.height}},e}();t.HybridAppResizeUtil=r},224:function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t,n,r,i,o){var a=e.call(this,t)||this;return a.logger=t,a.elementId=n,a.params=r,a.constants=i,a.$window=o,a.sendCommand=function(e){a.sendTelemetryEvent(e);try{a._sendCommand(e)}catch(n){a.logger.error("sendCommand() failed - {0}",n);var t=a.logger.service.findScenarioByNameAndId(a.constants.multiWindow.scenario.enqueueEntityCommand,e.payload.command.correlation.id);t&&t.fail({reason:teamspace.services.commanding.EntityCommandErrorCode.SendCommandFailure})}},a.sendTelemetryEvent=function(e){var t=(e.payload&&e.payload.command||{correlation:{}}).correlation,n="executeEntityCommand"===e.eventId?a.logger.service.findScenarioByNameAndId(a.constants.multiWindow.scenario.createNewWindow,t.id):void 0;if(n){var r={correlationId:t.id,commandSource:t.source},i=r.correlationId,o=r.commandSource;n.stop({"EventInfo.CorrelationId":i,commandSource:o})}},a.element=a.createElement(r.url),a}return r(t,e),t.prototype.appendTo=function(e){return this.element?(e.appendChild(this.element),Promise.resolve()):Promise.reject(this.constants.experienceContainers.reason.ecAppendToError)},t}(n(2224).EventPublisher);t.ExperienceContainer=i},55:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.createDiv=function(e){return this.createElement("div",e)},e.prototype.createWebView=function(e){return this.createElement("webview",e)},e.prototype.createIframe=function(e){return this.createElement("iframe",e)},e.prototype.createElement=function(e,t){var n=document.createElement(e);return n.id=t,n},e}();t.htmlFactory=new r},56:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExperienceContainerEventNames=teamspace.services.ExperienceContainerEventNames,t.ExperienceContainerType=teamspace.services.ExperienceContainerType,t.ExperienceCommand=teamspace.services.ExperienceCommand,t.ShowEntityResultCode=teamspace.services.ShowEntityResultCode,t.EntityCommandErrorCode=teamspace.services.commanding.EntityCommandErrorCode,t.ChildWindowEventRequest=teamspace.services.ChildWindowEventRequest}},[2221]);
//# sourceMappingURL=https://statics.teams.cdn.office.net/hashedjs/lazy-ng1-mod-experience-container-services.min.js-93c2b7dd.map